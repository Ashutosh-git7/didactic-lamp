<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simple MLM Product Plan</title>
<style>
body {font-family: Arial, sans-serif; background:#121212; color:#e0e0e0; margin:0; padding:10px;}
.box {background:#1e1e1e; padding:20px; margin:20px 0; border-radius:10px;}
input, select, button {width:100%; padding:12px; margin-top:10px; border:none; border-radius:6px; font-size:16px;}
button {background:#00ffe1; cursor:pointer; font-weight:bold;}
button:hover {background:#00c7aa;}
h2, h3 {text-align:center; color:#00ffe1;}
table {width:100%; border-collapse:collapse; margin-top:20px;}
th, td {border:1px solid #333; padding:10px; text-align:center;}
th {background:#222; color:#00ffe1;}
.hidden {display:none;}
</style>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>

<h2>MLM Product Plan</h2>

<!-- Login -->
<div id="loginDiv" class="box">
<h3>Login</h3>
<input type="text" id="loginID" placeholder="Enter User ID" />
<input type="password" id="loginPass" placeholder="Password" />
<button onclick="login()">Login</button>
<p>New? <a href="#" onclick="showRegister()">Register here</a></p>
</div>

<!-- Register -->
<div id="registerDiv" class="box hidden">
<h3>Register</h3>
<input type="text" id="regName" placeholder="Full Name" />
<input type="text" id="regMobile" placeholder="Mobile" />
<input type="text" id="regWallet" placeholder="BEP20 USDT Wallet" />
<input type="password" id="regPassword" placeholder="Set Password" />
<input type="text" id="regRef" placeholder="Referred By (ID, optional)" />
<button onclick="register()">Register</button>
<p>Already registered? <a href="#" onclick="showLogin()">Login here</a></p>
</div>

<!-- User Dashboard -->
<div id="userDiv" class="box hidden">
<h3>Hello, <span id="userNameDisplay"></span></h3>
<p>Status: <span id="userStatus"></span></p>
<p>Wallet Balance: <span id="walletBalance">0</span> USDT</p>
<p>Total Income: <span id="totalIncome">0</span> USDT</p>

<!-- Product Purchase -->
<h3>Buy Products</h3>
<select id="productSelect"></select>
<input type="number" id="buyQty" placeholder="Quantity" min="1" />
<button onclick="buyProduct()">Buy</button>

<!-- Downline -->
<h3>Your Downline (6 levels)</h3>
<div id="downline"></div>

<!-- Earnings Ledger -->
<h3>My Earnings</h3>
<table id="ledgerTable">
<tr><th>Date</th><th>Level</th><th>Amount (USDT)</th></tr>
<tbody></tbody>
</table>

<!-- Withdraw -->
<h3>Request Withdrawal</h3>
<input type="text" id="withdrawWallet" placeholder="Your USDT Wallet" />
<input type="number" id="withdrawAmount" placeholder="Amount (min 5 USDT)" min="5" />
<button onclick="requestWithdraw()">Request</button>

<button onclick="logout()">Logout</button>
</div>

<!-- Admin Panel -->
<div id="adminDiv" class="box hidden">
<h3>Admin Panel</h3>
<h4>Adjust Commission Percentages</h4>
<table>
<tr><th>Level</th><th>% of 70%</th></tr>
<tr><td>1</td><td><input type="number" id="p1" min="0" max="70" value="25" /></td></tr>
<tr><td>2</td><td><input type="number" id="p2" min="0" max="70" value="15" /></td></tr>
<tr><td>3</td><td><input type="number" id="p3" min="0" max="70" value="12" /></td></tr>
<tr><td>4</td><td><input type="number" id="p4" min="0" max="70" value="10" /></td></tr>
<tr><td>5</td><td><input type="number" id="p5" min="0" max="70" value="5" /></td></tr>
<tr><td>6</td><td><input type="number" id="p6" min="0" max="70" value="3" /></td></tr>
</table>
<button onclick="savePercentages()">Save Percentages</button>

<h4>Product List</h4>
<table id="productTable">
<tr><th>Name</th><th>Price (USDT)</th><th>BV</th><th>Edit</th></tr>
</table>

<br/><button onclick="logout()">Logout Admin</button>
</div>

<script>
  // Firebase Init
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_DOMAIN",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID",
    databaseURL: "YOUR_DB_URL"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentUserId = null;
  let isAdmin = false;
  let commissionPercentages = [25,15,12,10,5,3];

  // Sample products
  let products = [
    { name: "Product A", price: 100, bv: 80 },
    { name: "Product B", price: 200, bv: 160 },
    { name: "Product C", price: 300, bv: 240 }
  ];

  // Load products into admin table
  function loadProducts() {
    const tbody = document.getElementById("productTable").querySelector("tbody");
    tbody.innerHTML="";
    products.forEach((p, i) => {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${p.name}</td>
        <td>${p.price.toFixed(2)}</td>
        <td>${p.bv}</td>
        <td><button onclick='editProduct(${i})'>Edit</button></td>`;
      tbody.appendChild(row);
    });
  }
  function editProduct(i) {
    const p = products[i];
    const newName = prompt("New Name:", p.name);
    const newPrice = parseFloat(prompt("New Price", p.price));
    const newBV = parseInt(prompt("New BV", p.bv));
    if (newName && !isNaN(newPrice) && !isNaN(newBV)) {
      products[i] = { name: newName, price: newPrice, bv: newBV };
      loadProducts();
    }
  }

  // Show/hide pages
  function showPage(id) {
    document.querySelectorAll('.box').forEach(b => b.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }

  function showRegister() { showPage('registerDiv'); }
  function showLogin() { showPage('loginDiv'); }

  // Register
  function register() {
    const name = document.getElementById("regName").value.trim();
    const mobile= document.getElementById("regMobile").value.trim();
    const wallet= document.getElementById("regWallet").value.trim();
    const pass= document.getElementById("regPassword").value.trim();
    const ref= document.getElementById("regRef").value.trim();
    if (!name || !mobile || !wallet || !pass) { alert("Fill all fields"); return; }
    const uid = "U"+Math.floor(100000+Math.random()*900000);
    const data= {
      name, mobile, wallet, password: pass,
      referredBy: ref || null,
      walletBalance: 0,
      income: 0,
      deposit:0,
      status: "Active",
      bvTotal:0,
      createdAt: new Date().toISOString()
    };
    db.ref("users/"+uid).set(data).then(()=>{ alert("Registered ID: "+uid); showPage('loginDiv'); }).catch(e => alert("Error: "+e));
  }

  // Login
  function login() {
    const id = document.getElementById("loginID").value.trim();
    const pass= document.getElementById("loginPass").value.trim();
    if (id === "Admin" && pass==="JaiHanuman7") { isAdmin= true; showPage("adminDiv"); return; }
    db.ref("users/"+id).once("value").then(snap => {
      if (!snap.exists()) { alert("Not found"); return; }
      const u= snap.val();
      if (u.password!==pass) { alert("Wrong pass"); return; }
      currentUserId= id; showPage("userDiv"); loadUserData();
    });
  }

  // Load user data
  function loadUserData() {
    db.ref("users/"+currentUserId).once("value").then(snap => {
      const u= snap.val();
      document.getElementById("userNameDisplay").innerText= u.name;
      document.getElementById("userStatus").innerText= u.status;
      document.getElementById("walletBalance").innerText= u.walletBalance.toFixed(2);
      document.getElementById("totalIncome").innerText= u.income.toFixed(2);
      loadDownline();
      loadLedger();
    });
  }

  // Load downline recursion up to 6 levels
  function loadDownline() {
    const container= document.getElementById("downline");
    container.innerHTML= "Loading...";
    function recurse(parentId, level) {
      return db.ref("users").orderByChild("referredBy").equalTo(parentId).once("value").then(snap => {
        let html="";
        snap.forEach(s => {
          const u= s.val();
          html += `<li>Level ${level}: ${u.name} (ID: ${s.key})</li>`;
          if (level<6) {
            html += `<ul>${recurse(s.key, level+1)}</ul>`;
          }
        });
        return html;
      });
    }
    recurse(currentUserId,1).then(html => {
      document.getElementById("downline").innerHTML= `<ul>${html}</ul>`;
    });
  }

  // Load ledger
  function loadLedger() {
    db.ref("users/"+currentUserId+"/commissionLedger").once("value").then(snap => {
      const ledger= snap.val() || {};
      const tbody= document.getElementById("ledgerTable").querySelector("tbody");
      tbody.innerHTML= "";
      Object.keys(ledger).sort().forEach(date => {
        ledger[date].forEach(rec => {
          const tr= document.createElement("tr");
          tr.innerHTML= `<td>${date}</td><td>${rec.level}</td><td>${rec.amount.toFixed(2)}</td>`;
          tbody.appendChild(tr);
        });
      });
    });
  }

  // Buy Product
  function buyProduct() {
    const prodId= document.getElementById("productSelect").value;
    const qty= parseInt(document.getElementById("buyQty").value);
    if (!prodId || isNaN(qty) || qty<1) { alert("Select product and quantity"); return; }
    const p= products.find(pp=> pp.name===prodId);
    if (!p) { alert("Invalid product"); return; }
    // For demo, assume payment done outside
    // Add BV to user
    db.ref("users/"+currentUserId).transaction(u=> {
      if (!u) return u;
      u.bvTotal= (u.bvTotal||0)+ p.bv*qty;
      return u;
    }).then(()=>{
      // Save purchase record
      const saleData= {
        product: p.name,
        qty,
        bv: p.bv*qty,
        price: p.price*qty,
        date: new Date().toISOString()
      };
      db.ref("purchases").push(saleData).then(()=> {
        alert("Purchase recorded");
        distributeCommission(currentUserId, p.bv*qty);
        loadUserData();
      });
    });
  }

  // Distribute commission up to 6 levels
  function distributeCommission(bvAmount, buyerId) {
    const companyShare= bvAmount*0.30;
    db.ref("company/profit").transaction(c=> (c||0)+companyShare);
    let uid= buyerId;
    for(let i=0; i<commissionPercentages.length; i++) {
      db.ref("users/"+uid).once("value").then(snap => {
        const u= snap.val();
        if (u && u.referredBy) {
          const uplinerId= u.referredBy;
          const commission= bvAmount*0.70* (commissionPercentages[i]/100);
          // Credit upliner wallet
          db.ref("users/"+uplinerId).transaction(upl=> {
            if (!upl) return upl;
            upl.walletBalance= (upl.walletBalance||0)+commission;
            upl.income= (upl.income||0)+commission;
            const dateStr= new Date().toISOString().slice(0,10);
            if (!upl.commissionLedger) upl.commissionLedger= {};
            if (!upl.commissionLedger[dateStr]) upl.commissionLedger[dateStr]= [];
            upl.commissionLedger[dateStr].push({level: i+1, amount: commission});
            return upl;
          });
          uid= uplinerId;
        }
      });
    }
  }

  // Request withdrawal
  function requestWithdraw() {
    const addr= document.getElementById("withdrawWallet").value.trim();
    const amount= parseFloat(document.getElementById("withdrawAmount").value);
    if (!addr || isNaN(amount) || amount<5) { alert("Enter valid amount & address"); return; }
    // Deduct from wallet
    db.ref("users/"+currentUserId).transaction(u=> {
      if (!u) return u;
      if ((u.walletBalance||0)<amount) { alert("Insufficient balance"); return; }
      u.walletBalance= (u.walletBalance||0)-amount;
      return u;
    }).then(()=> {
      // Save withdrawal request
      const wr= {
        wallet: addr,
        amount,
        date: new Date().toISOString(),
        status: "Pending"
      };
      db.ref("withdrawals/"+currentUserId).push(wr).then(()=>alert("Withdrawal requested"));
      loadUserData();
    });
  }

  // Save Commission Percentages
  function savePercentages() {
    for(let i=1; i<=6; i++) {
      const val= parseFloat(document.getElementById("p"+i).value);
      if (!isNaN(val)) commissionPercentages[i-1]= val;
    }
    alert("Percentages saved");
  }

  // Load Products into store
  function loadProducts() {
    // Generate options
    const select= document.getElementById("productSelect");
    products.forEach(p=> {
      const opt= document.createElement("option");
      opt.value= p.name;
      opt.innerText= `${p.name} - Price: ${p.price} USDT, BV: ${p.bv}`;
      select.appendChild(opt);
    });
  }
  loadProducts();

  // Initial load
  function init() {
    // You can load admin data or set admin login here for demo
  }
  init();
</script>
</body>
</html>      box-sizing: border-box;
    }
    input, button, select, textarea {
      padding: 12px 15px;
      margin: 10px 0 20px 0;
      width: 100%;
      border-radius: 6px;
      border: none;
      font-size: 16px;
      background: #2a2a2a;
      color: #fff;
      box-sizing: border-box;
      transition: background-color 0.2s ease, box-shadow 0.2s ease;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      background-color: #393939;
      box-shadow: 0 0 6px #00ffe1aa;
    }
    button {
      background: #00ffe1;
      color: #000;
      font-weight: 700;
      cursor: pointer;
      border: none;
      transition: background 0.3s ease;
      user-select: none;
    }
    button:hover, button:focus {
      background: #00c7aa;
      outline: none;
    }
    a {
      color: #00ffe1;
      text-decoration: underline;
      cursor: pointer;
      user-select: none;
    }
    a:hover {
      color: #00c7aa;
    }
    .hidden {
      display: none !important;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0 10px 0;
    }
    th, td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #333;
      font-size: 14px;
    }
    th {
      background-color: #222;
      color: #00ffe1;
      font-weight: 700;
    }
    td {
      background-color: #1c1c1c;
      word-break: break-word;
    }
    .admin-section {
      background: #2b1b1b;
      border: 2px solid #ff5555;
      max-width: 980px;
    }
    .admin-section h3 {
      margin-top: 0;
    }
    .btn-table {
      padding: 6px 10px;
      margin: 0 3px;
      font-size: 13px;
      border-radius: 6px;
      font-weight: 600;
    }
    .btn-accept {
      background-color: #28a745;
      color: #fff;
      border: none;
    }
    .btn-reject {
      background-color: #dc3545;
      color: #fff;
      border: none;
    }
    .btn-close {
      background-color: #6c757d;
      color: #fff;
      border: none;
    }
    .btn-edit {
      background-color: #007bff;
      color: #fff;
      border: none;
    }
    .btn-delete {
      background-color: #e55753;
      color: #fff;
      border: none;
    }
    .btn-small {
      padding: 5px 8px;
      font-size: 12px;
    }
    #userDashboard {
      max-width: 650px;
      text-align: left;
    }
    #userDashboard p, #userDashboard code {
      margin: 6px 0;
      font-size: 15px;
    }
    #profitChartContainer {
      margin-top: 20px;
      background: #272727;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 0 12px #00ffe1bb;
    }
    #profitChart {
      width: 100% !important;
      max-height: 250px;
    }
    code {
      display: inline-block;
      background-color: #333;
      padding: 6px 10px;
      border-radius: 6px;
      font-family: monospace;
      user-select: all;
    }
    hr {
      border: none;
      border-top: 1px solid #262626;
      margin: 25px 0;
    }
    @media (max-width: 640px) {
      .box, .admin-section {
        max-width: 100%;
        padding: 15px 20px;
      }
      table, th, td {
        font-size: 12px;
      }
      button, input, select, textarea {
        font-size: 14px;
      }
    }
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal-content {
      background: #1e1e1e;
      border-radius: 12px;
      padding: 25px 30px;
      width: 100%;
      max-width: 480px;
      box-shadow: 0 0 20px #00ffe1bb;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .modal-header h4 {
      margin: 0;
      color: #00ffe1;
    }
    .modal-close {
      font-size: 22px;
      font-weight: 700;
      cursor: pointer;
      color: #ff5555;
      user-select: none;
    }
  </style>
</head>
<body>

<h2>üöÄ Ashirwad Mart P - Grow Up Together</h2>

<div id="loginBox" class="box">
  <h3>üîê Login</h3>
  <input type="text" id="loginId" placeholder="Enter ID" autocomplete="username" />
  <input type="password" id="loginPass" placeholder="Password" autocomplete="current-password" />
  <button onclick="login()">Login</button>
  <p>Don't have ID? <a onclick="showRegister()">Register here</a></p>
</div>

<div id="registerBox" class="box hidden">
  <p><a onclick="showForgot()">Forgot Password?</a></p>
  <h3>üìù New Registration</h3>
  <input type="text" id="regName" placeholder="Full Name" autocomplete="name"/>
  <input type="text" id="regMobile" placeholder="Mobile Number" autocomplete="tel"/>
  <input type="text" id="regWallet" placeholder="BEP20 USDT Wallet Address" />
  <input type="password" id="regPassword" placeholder="Set Password" autocomplete="new-password"/>
  <input type="text" id="regRef" placeholder="Referral ID (optional)" />
  <button onclick="register()">Register Now</button>
</div>

<div id="forgotBox" class="box hidden">
  <h3>üîë Reset Password via OTP</h3>
  <input type="text" id="otpMobile" placeholder="Enter Registered Mobile Number" autocomplete="tel" />
  <div id="recaptcha-container"></div>
  <button onclick="sendOTP()">Send OTP</button>
  <input type="text" id="otpCode" placeholder="Enter OTP" autocomplete="one-time-code" />
  <input type="password" id="otpNewPass" placeholder="New Password" autocomplete="new-password" />
  <button onclick="verifyOTP()">Verify & Change Password</button>
  <p><a onclick="backToLogin()">üîô Back to Login</a></p>
</div>

<div id="userDashboard" class="box hidden">
  <h3>üëã Hello, <span id="userName"></span></h3>
  <p>üíº Wallet: <span id="userWallet"></span></p>
  <p>üí∞ Deposit: <b><span id="userDeposit">0</span> USDT</b></p>
  <p><small><em>Deposit Time: <span id="userDepositTime">N/A</span></em></small></p>
  <p>üìà Income: <b><span id="userIncome">0</span> USDT</b></p>
  <p>üè¶ Withdrawal Wallet: <b><span id="userWithdrawWallet"></span></b></p>
  <p><small>Set your UPI ID for INR withdrawals:</small></p>
  <input type="text" id="userUPI" placeholder="Enter your UPI ID here" autocomplete="off" />
  <button id="saveUPIButton" onclick="saveUserUPI()">Save UPI ID</button>
  <p>üéØ Income Target (2x): <b><span id="userTarget">0</span> USDT</b></p>
  <p>üìâ Remaining Target: <b><span id="userRemaining">0</span> USDT</b></p>
  <p>üîí Status: <span id="userStatus">Pending</span></p>
  <p>üí≥ Wallet Balance: <b><span id="walletBalance">0</span> USDT</b></p>

  <hr />
  <h4>üì• Deposit Funds</h4>
  <label>
    <input type="radio" name="depositCurrency" value="USDT" checked onclick="updateDepositUI()" /> Deposit in USDT
  </label>
  <label>
    <input type="radio" name="depositCurrency" value="INR" onclick="updateDepositUI()" /> Deposit in INR (UPI)
  </label>

  <div id="depositUSDTDiv" style="margin-top: 15px;">
    <p>Send 100‚Äì1000 USDT to:</p>
    <code>0x49F7A836A32C1aCF04d4d20Fa87A14C7a19aB74B</code>
    <input type="number" id="depAmount" placeholder="Enter amount (100-1000)" min="100" max="1000" />
    <button onclick="submitDeposit()">Submit Deposit</button>
  </div>

  <div id="depositINRDiv" class="hidden" style="margin-top: 15px;">
    <p>Current USDT to INR Buy Rate = <b><span id="usdtToInrBuyRate">Loading...</span> ‚Çπ</b></p>
    <p>Enter USDT amount to deposit (100-1000 USDT):</p>
    <input type="number" id="depINRUSDTAmount" placeholder="Enter USDT amount (100-1000)" min="100" max="1000" oninput="updateINRDepositAmount()" />
    <p>You need to pay (INR) <b><span id="depINRAmount">0</span></b> via UPI.</p>
    <p>Send payment to UPI ID: <code>ashutoshkarmkar7-1@oksbi</code></p>
    <button onclick="submitDepositINR()">Submit INR Deposit Request</button>
  </div>

  <hr />
  <h4>üí∏ Request Withdrawal</h4>

  <label>
    <input type="radio" name="withdrawCurrency" value="USDT" checked onclick="updateWithdrawUI()" /> Withdraw in USDT
  </label>
  <label>
    <input type="radio" name="withdrawCurrency" value="INR" onclick="updateWithdrawUI()" /> Withdraw in INR
  </label>

  <div id="withdrawUSDTDiv" style="margin-top: 15px;">
    <p>Your BEP20 USDT Wallet Address: <code id="userWalletAddress"></code></p>
    <input type="number" id="withAmt" placeholder="Min 5 USDT" min="5" />
    <button onclick="requestWithdraw()">Request Withdrawal</button>
  </div>

  <div id="withdrawINRDiv" class="hidden" style="margin-top: 15px;">
    <p>Current USDT to INR Sell Rate = <b><span id="usdtToInrSellRate">Loading...</span> ‚Çπ</b></p>
    <p>Wallet Balance: <span id="walletBalanceINR">0</span> ‚Çπ (approx.)</p>
    <p>Enter INR withdrawal amount (Min ‚Çπ373 approx for 5 USDT):</p>
    <input type="number" id="withAmtINR" placeholder="Enter INR amount" min="0" />
    <button onclick="requestWithdrawINR()">Request INR Withdrawal</button>
  </div>

  <hr />
  <h4>üîë Change Password</h4>
  <input type="password" id="changePassCurrent" placeholder="Current Password" />
  <input type="password" id="changePassNew" placeholder="New Password" />
  <button onclick="changePasswordNormal()">Change Password</button>
  
  <hr/>
  <h4>üë®üë©üëßüë¶ Referral Team</h4>
  <button onclick="viewTeam()">View Your Team</button>
  <div id="teamBox"></div>

  <hr />
  <h4>üìú History</h4>
  <button onclick="viewHistory()">View History</button>
  <div id="historyBox"></div>

  <div id="profitChartContainer" class="hidden">
    <h4>üìä Profit Graph (Deposit vs Income)</h4>
    <canvas id="profitChart"></canvas>
  </div>

  <button onclick="logout()">üö™ Logout</button>
</div>

<div id="adminPanel" class="box admin-section hidden">
  <h3>üõ†Ô∏è Admin Dashboard</h3>

  <div style="margin-bottom:15px; font-size: 16px; color: #00ffe1;">
    <b>Total Deposit Balance:</b> <span id="totalDepositBalance">0</span> USDT &nbsp;&nbsp;&nbsp;
    <b>Total Wallet Balance:</b> <span id="totalWalletBalance">0</span> USDT
  </div>

  <div id="adminDepositsContainer" style="margin-bottom: 20px;">
    <h4>üìù Pending Deposit Requests</h4>
    <table id="depositsTable">
      <thead>
        <tr>
          <th>User ID</th><th>Name</th><th>Amount</th><th>Currency</th><th>Status</th><th>Deposit Time</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="adminWithdrawalsContainer" style="margin-bottom: 20px;">
    <h4>üìù Pending Withdrawal Requests</h4>
    <table id="withdrawalsTable">
      <thead>
        <tr>
          <th>User ID</th><th>Name</th><th>Amount</th><th>Currency</th><th>UPI ID</th><th>Status</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="adminUsersContainer"></div>

  <h4>‚ûï Add Weekly Income</h4>
  <input type="text" id="incomeUserId" placeholder="User ID" />
  <input type="number" id="incomeAmt" placeholder="Amount" />
  <button onclick="addWeeklyIncome()">Add Income</button>

  <button onclick="logout()">üö™ Logout</button>
</div>

<div id="editUserModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h4>Edit User</h4>
      <span class="modal-close" onclick="closeEditModal()">&times;</span>
    </div>
    <input type="text" id="editUserId" placeholder="User ID" disabled />
    <input type="text" id="editName" placeholder="Full Name" />
    <input type="text" id="editMobile" placeholder="Mobile Number" />
    <input type="text" id="editWallet" placeholder="BEP20 USDT Wallet Address" />
    <input type="password" id="editPassword" placeholder="Password (leave blank to keep unchanged)" />
    <input type="text" id="editRef" placeholder="Referral ID" />
    <select id="editStatus">
      <option value="Pending">Pending</option>
      <option value="Active">Active</option>
      <option value="Rejected">Rejected</option>
      <option value="Closed">Closed</option>
    </select>
    <input type="number" id="editDeposit" placeholder="Deposit" min="0" step="any" />
    <input type="number" id="editIncome" placeholder="Income" min="0" step="any" />
    <input type="number" id="editWalletBalance" placeholder="Wallet Balance" min="0" step="any" />
    <input type="text" id="editDepositTime" placeholder="Deposit Time (ISO format)" />
    <button onclick="saveUserChanges()">Save Changes</button>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCBXuE2NHuZkKeQY7JjYM5vpbF1-K9AcS8",
    authDomain: "ashirwadmart-6d657.firebaseapp.com",
    databaseURL: "https://ashirwadmart-6d657-default-rtdb.firebaseio.com",
    projectId: "ashirwadmart-6d657",
    storageBucket: "ashirwadmart-6d657.appspot.com",
    messagingSenderId: "1013585797321",
    appId: "1:1013585797321:web:8a5c5fdb50c6aa7e7e57aa"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentId = "";
  let profitChartInstance = null;

  // Margins on exchange rates internally for deposit and withdrawal
  let usdtToINRBuy = null;   // USDT to INR buy rate + 7%
  let usdtToINRSell = null;  // USDT to INR sell rate - 5%

  async function loadExchangeRates() {
    try {
      const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=tether&vs_currencies=inr');
      const data = await response.json();
      const baseRate = data.tether.inr;
      if (baseRate) {
        usdtToINRBuy = baseRate * 1.07;
        usdtToINRSell = baseRate * 0.98;

        document.getElementById('usdtToInrBuyRate').innerText = usdtToINRBuy.toFixed(2);
        document.getElementById('usdtToInrSellRate').innerText = usdtToINRSell.toFixed(2);

        if (currentId && currentId !== "Admin") {
          db.ref('users/' + currentId).once('value').then(snap => {
            const data = snap.val();
            if (data) {
              const walletUSDT = parseFloat(data.walletBalance || 0);
              const walletINR = walletUSDT * usdtToINRSell;
              document.getElementById('walletBalanceINR').innerText = walletINR.toFixed(2);
              const userUPI = data.upiId || "";
              document.getElementById("userUPI").value = userUPI;
            }
          });
        }
        updateINRDepositAmount();
      }
    } catch (e) {
      console.error(e);
      document.getElementById('usdtToInrBuyRate').innerText = 'Error';
      document.getElementById('usdtToInrSellRate').innerText = 'Error';
    }
  }
  loadExchangeRates();
  setInterval(loadExchangeRates, 60000);

  function show(ele) { ele.classList.remove('hidden'); }
  function hide(ele) { ele.classList.add('hidden'); }

  function showRegister() {
    hide(document.getElementById('loginBox'));
    show(document.getElementById('registerBox'));
    hide(document.getElementById('forgotBox'));
  }
  function showForgot() {
    hide(document.getElementById('loginBox'));
    hide(document.getElementById('registerBox'));
    show(document.getElementById('forgotBox'));
  }
  function backToLogin() {
    hide(document.getElementById('forgotBox'));
    hide(document.getElementById('registerBox'));
    show(document.getElementById('loginBox'));
  }

  function login() {
    const id = document.getElementById('loginId').value.trim();
    const pass = document.getElementById('loginPass').value;
    if (!id) return alert("Please enter your ID");
    if (!pass) return alert("Please enter your password");

    if (id === "Admin" && pass === "Jaihanuman@7") {
      currentId = "Admin";
      hide(document.getElementById("loginBox"));
      show(document.getElementById("adminPanel"));
      loadAdmin();
      return;
    }
    db.ref("users/" + id).once("value", snap => {
      if (snap.exists()) {
        const data = snap.val();
        if (data.password !== pass) return alert("Incorrect password");
        currentId = id;
        loadUser(id);
        hide(document.getElementById("loginBox"));
        show(document.getElementById("userDashboard"));
      } else {
        alert("User ID not found.");
      }
    });
  }

  function register() {
    const name = document.getElementById("regName").value.trim();
    const mobile = document.getElementById("regMobile").value.trim();
    const wallet = document.getElementById("regWallet").value.trim();
    const ref = document.getElementById("regRef").value.trim();
    const password = document.getElementById("regPassword").value.trim();

    if (!name || !mobile || !wallet || !password) {
      return alert("Please fill all required fields");
    }
    const id = "U" + Math.floor(Math.random() * 100000);

    const userData = {
      name, mobile, wallet, deposit: 0, income: 0, status: "Pending", referredBy: ref || "", password,
      walletBalance: 0, depositTime: null, upiId: ""
    };
    db.ref("users/" + id).set(userData).then(() => {
      alert(`Registered! Your ID: ${id}`);
      location.reload();
    }).catch(err => alert("Error during registration: " + err.message));
  }

  function loadUser(id) {
    db.ref("users/" + id).on("value", snap => {
      if (!snap.exists()) {
        alert("User data not found");
        logout();
        return;
      }
      const data = snap.val();

      const deposit = parseFloat(data.deposit || 0);
      const income = parseFloat(data.income || 0);
      const cap = deposit * 2;
      const remaining = Math.max(0, cap - income);
      const balance = parseFloat(data.walletBalance || 0);
      const depositTimeStr = data.depositTime ? new Date(data.depositTime).toLocaleString() : "N/A";

      document.getElementById("userName").innerText = data.name;
      document.getElementById("userWallet").innerText = data.wallet;
      document.getElementById("userDeposit").innerText = deposit.toFixed(2);
      document.getElementById("userDepositTime").innerText = depositTimeStr;
      document.getElementById("userIncome").innerText = income.toFixed(2);
      document.getElementById("userStatus").innerText = data.status;
      document.getElementById("userWithdrawWallet").innerText = data.wallet;
      document.getElementById("userTarget").innerText = cap.toFixed(2);
      document.getElementById("userRemaining").innerText = remaining.toFixed(2);
      document.getElementById("walletBalance").innerText = balance.toFixed(2);

      document.getElementById("userWalletAddress").innerText = data.wallet || "(No wallet address)";

      const upiValue = data.upiId || "";
      document.getElementById("userUPI").value = upiValue;
      if (upiValue.trim()) {
        document.getElementById("saveUPIButton").style.display = "none";
      } else {
        document.getElementById("saveUPIButton").style.display = "inline-block";
      }

      if (usdtToINRSell) {
        const walletINR = balance * usdtToINRSell;
        document.getElementById('walletBalanceINR').innerText = walletINR.toFixed(2);
      }

      if (deposit > 0 && income >= cap && data.status !== "Closed") {
        db.ref("users/" + id).update({
          income: 0,
          deposit: 0,
          status: "Closed",
          depositTime: null
        });
        alert("üéâ Congratulations! Your agreement has completed 2x and is now closed.");
      }

      loadProfitChart(deposit, income);
    });
  }

  function updateDepositUI() {
    const currency = document.querySelector('input[name="depositCurrency"]:checked').value;
    if (currency === "USDT") {
      show(document.getElementById("depositUSDTDiv"));
      hide(document.getElementById("depositINRDiv"));
    } else {
      hide(document.getElementById("depositUSDTDiv"));
      show(document.getElementById("depositINRDiv"));
      updateINRDepositAmount();
    }
  }

  function updateINRDepositAmount() {
    const usdtAmt = parseFloat(document.getElementById("depINRUSDTAmount").value);
    if (isNaN(usdtAmt) || usdtAmt < 100 || usdtAmt > 1000 || !usdtToINRBuy) {
      document.getElementById("depINRAmount").innerText = "0";
      return;
    }
    const inrAmt = usdtAmt * usdtToINRBuy;
    document.getElementById("depINRAmount").innerText = inrAmt.toFixed(2);
  }

  // Referral income percentages for levels
  const REF_LEVELS = [0.05, 0.03, 0.02]; // 5%, 3%, 2%

  // Adds referral income up to 3 levels for given deposit amount
  function addReferralIncome(depositAmount, userId) {
    let currentUserId = userId;
    let level = 0;

    function updateUserIncome(userId, incomeToAdd) {
      return db.ref("users/" + userId).transaction(userData => {
        if (userData) {
          userData.income = (parseFloat(userData.income) || 0) + incomeToAdd;
          userData.walletBalance = (parseFloat(userData.walletBalance) || 0) + incomeToAdd;
        }
        return userData;
      });
    }

    (async () => {
      while (level < 3 && currentUserId) {
        const userSnap = await db.ref("users/" + currentUserId).once("value");
        if (!userSnap.exists()) break;
        const user = userSnap.val();
        const referrerId = user.referredBy;
        if (!referrerId) break;

        const referralIncome = depositAmount * REF_LEVELS[level];
        if (referralIncome > 0) {
          await updateUserIncome(referrerId, referralIncome);
        }

        currentUserId = referrerId;
        level++;
      }
    })();
  }

  function submitDeposit() {
    const amt = parseFloat(document.getElementById("depAmount").value);
    if (isNaN(amt) || amt < 100 || amt > 1000) {
      return alert("Deposit amount must be between 100 and 1000 USDT");
    }
    db.ref("users/" + currentId).once("value").then(snap => {
      if (!snap.exists()) return alert("User data not found");

      const data = snap.val();
      if (data.status === "Active") return alert("Deposit is locked until agreement is closed.");

      const nowISOString = new Date().toISOString();

      db.ref("users/" + currentId).update({
        deposit: amt,
        status: "Pending",
        depositTime: nowISOString,
        depositCurrency: "USDT",
        depositINRAmount: null
      }).then(() => {
        alert("Deposit submitted! Waiting for admin approval.");
        document.getElementById("depAmount").value = "";
        loadUser(currentId);
      }).catch(err => alert("Error submitting deposit: " + err.message));
    });
  }

  function submitDepositINR() {
    const usdtAmt = parseFloat(document.getElementById("depINRUSDTAmount").value);
    if (isNaN(usdtAmt) || usdtAmt < 100 || usdtAmt > 1000) {
      return alert("USDT amount must be between 100 and 1000");
    }
    if (!usdtToINRBuy) {
      return alert("Exchange rate not loaded yet. Please wait.");
    }
    const inrAmt = usdtAmt * usdtToINRBuy;
    const nowISOString = new Date().toISOString();

    db.ref("users/" + currentId).once("value").then(snap => {
      if (!snap.exists()) return alert("User data not found");

      const data = snap.val();
      if (data.status === "Active") return alert("Deposit is locked until agreement is closed.");

      db.ref("depositINRRequests/" + currentId).set({
        usdtAmount: usdtAmt,
        inrAmount: inrAmt,
        status: "Pending",
        depositTime: nowISOString,
        upiId: "ashutoshkarmkar7-1@oksbi"
      }).then(() => {
        alert(`INR deposit request submitted for approx ‚Çπ${inrAmt.toFixed(2)}. Please pay via UPI to ashutoshkarmkar7-1@oksbi.\nAfter payment, wait for admin approval.`);
        document.getElementById("depINRUSDTAmount").value = "";
        document.getElementById("depINRAmount").innerText = "0";
      }).catch(err => alert("Error submitting INR deposit: " + err.message));
    });
  }

  function updateWithdrawUI() {
    const currency = document.querySelector('input[name="withdrawCurrency"]:checked').value;
    if (currency === "USDT") {
      show(document.getElementById("withdrawUSDTDiv"));
      hide(document.getElementById("withdrawINRDiv"));
    } else {
      hide(document.getElementById("withdrawUSDTDiv"));
      show(document.getElementById("withdrawINRDiv"));
    }
  }

  function requestWithdraw() {
    const amt = parseFloat(document.getElementById("withAmt").value);
    if (isNaN(amt) || amt < 5) return alert("Minimum withdrawal amount is 5 USDT");

    db.ref("users/" + currentId).once("value").then(snap => {
      if (!snap.exists()) return alert("User data not found");

      const data = snap.val();
      const walletBalance = parseFloat(data.walletBalance || 0);
      if (amt > walletBalance) return alert("Insufficient wallet balance");

      const newBalance = walletBalance - amt;
      db.ref("users/" + currentId + "/walletBalance").set(newBalance);
      db.ref("withdrawals/" + currentId).push({ amount: amt, status: "Pending", currency: "USDT", upiId: "" }).then(() => {
        alert("Withdrawal requested!");
        document.getElementById("withAmt").value = "";
      });
    });
  }

  function requestWithdrawINR() {
    const inrAmt = parseFloat(document.getElementById("withAmtINR").value);
    if (isNaN(inrAmt) || inrAmt <= 0) return alert("Please enter a valid INR amount");

    if (!usdtToINRSell) return alert("Exchange rate not loaded yet. Please wait.");

    db.ref("users/" + currentId).once("value").then(snap => {
      if (!snap.exists()) return alert("User data not found");

      const data = snap.val();
      const walletUSDT = parseFloat(data.walletBalance || 0);

      const usdtValue = inrAmt / usdtToINRSell;

      if (usdtValue > walletUSDT) return alert("Insufficient wallet balance for requested INR withdrawal");

      const newBalance = walletUSDT - usdtValue;

      db.ref("users/" + currentId + "/walletBalance").set(newBalance);
      const userUPI = data.upiId || "";
      db.ref("withdrawals/" + currentId).push({ amount: inrAmt, status: "Pending", currency: "INR", upiId: userUPI }).then(() => {
        alert(`INR Withdrawal requested for ‚Çπ${inrAmt.toFixed(2)}. Waiting for admin approval.`);
        document.getElementById("withAmtINR").value = "";
        document.getElementById('walletBalanceINR').innerText = (newBalance * usdtToINRSell).toFixed(2);
      });
    });
  }

  function saveUserUPI() {
    const upiId = document.getElementById("userUPI").value.trim();
    if (!upiId) return alert("Please enter a valid UPI ID");

    db.ref("users/" + currentId).update({ upiId }).then(() => {
      alert("UPI ID saved successfully.");
      document.getElementById("saveUPIButton").style.display = "none";
    }).catch(err => alert("Error saving UPI ID: " + err.message));
  }

  function changePasswordNormal() {
    const currentPass = document.getElementById("changePassCurrent").value;
    const newPass = document.getElementById("changePassNew").value;
    if (!currentPass || !newPass) return alert("Please fill both current and new password");

    db.ref("users/" + currentId).once("value").then(snap => {
      if (!snap.exists()) return alert("User data not found");
      const data = snap.val();
      if (data.password !== currentPass) return alert("Current password is incorrect");

      db.ref("users/" + currentId + "/password").set(newPass).then(() => {
        alert("Password changed successfully. Please login again.");
        logout();
      });
    }).catch(err => alert("Error changing password: " + err.message));
  }

  function viewTeam() {
    db.ref("users").once("value").then(snap => {
      let html = "<ul>";
      snap.forEach(child => {
        const data = child.val();
        if (data.referredBy === currentId) {
          html += `<li><b>${child.key}</b>: ${data.name} - ${parseFloat(data.deposit || 0).toFixed(2)} USDT - ${data.status}</li>`;
        }
      });
      html += "</ul>";
      document.getElementById("teamBox").innerHTML = html;
    });
  }

  function viewHistory() {
    db.ref("withdrawals/" + currentId).once("value").then(snap => {
      let html = "<h5>Withdrawals:</h5><ul>";
      snap.forEach(child => {
        const d = child.val();
        html += `<li>${parseFloat(d.amount).toFixed(2)} ${d.currency || 'USDT'} - ${d.status}</li>`;
      });
      html += "</ul>";
      document.getElementById("historyBox").innerHTML = html;
    });
  }

  function loadProfitChart(deposit, income) {
    const container = document.getElementById("profitChartContainer");
    if (deposit <= 0) {
      container.classList.add("hidden");
      return;
    }
    container.classList.remove("hidden");

    const ctx = document.getElementById("profitChart").getContext('2d');

    if (profitChartInstance) {
      profitChartInstance.destroy();
    }

    profitChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Start', 'Now'],
        datasets: [
          {
            label: 'Deposit',
            data: [deposit, deposit],
            borderColor: '#00ffe1',
            backgroundColor: '#001f20',
            fill: false
          },
          {
            label: 'Income',
            data: [0, income],
            borderColor: '#ffaa00',
            backgroundColor: '#332600',
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true
            }
          }]
        }
      }
    });
  }

  function logout() {
    currentId = "";
    profitChartInstance?.destroy();
    document.getElementById("loginId").value = "";
    document.getElementById("loginPass").value = "";

    hide(document.getElementById("userDashboard"));
    hide(document.getElementById("adminPanel"));
    show(document.getElementById("loginBox"));
  }

  // Admin functions
  function loadAdmin() {
    loadUsers();
    loadDeposits();
    loadWithdrawals();
  }

  function loadUsers() {
    db.ref("users").once("value").then(snap => {
      const container = document.getElementById("adminUsersContainer");
      let html = "<h4>Users List</h4><table><thead><tr><th>ID</th><th>Name</th><th>Status</th><th>Deposit</th><th>Income</th><th>Wallet Balance</th><th>UPI ID</th><th>Actions</th></tr></thead><tbody>";

      let totalDeposit = 0;
      let totalWallet = 0;

      snap.forEach(child => {
        const d = child.val();
        const id = child.key;
        totalDeposit += parseFloat(d.deposit || 0);
        totalWallet += parseFloat(d.walletBalance || 0);
        html += `<tr>
          <td>${id}</td>
          <td>${d.name}</td>
          <td>${d.status}</td>
          <td>${parseFloat(d.deposit || 0).toFixed(2)} USDT</td>
          <td>${parseFloat(d.income || 0).toFixed(2)} USDT</td>
          <td>${parseFloat(d.walletBalance || 0).toFixed(2)} USDT</td>
          <td>${d.upiId || ""}</td>
          <td>
            <button class="btn-table btn-edit" onclick="openEditModal('${id}')">Edit</button>
            <button class="btn-table btn-delete" onclick="deleteUser('${id}')">Delete</button>
          </td>
        </tr>`;
      });

      html += "</tbody></table>";
      container.innerHTML = html;
      document.getElementById("totalDepositBalance").innerText = totalDeposit.toFixed(2);
      document.getElementById("totalWalletBalance").innerText = totalWallet.toFixed(2);
    });
  }

  function loadDeposits() {
    const tbody = document.querySelector("#depositsTable tbody");
    tbody.innerHTML = "";

    db.ref("users").once("value").then(usersSnap => {
      usersSnap.forEach(userSnap => {
        const id = userSnap.key;
        const user = userSnap.val();
        if (user.status === "Pending" && user.deposit > 0) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${id}</td>
            <td>${user.name}</td>
            <td>${user.deposit.toFixed(2)}</td>
            <td>USDT</td>
            <td>${user.status}</td>
            <td>${user.depositTime ? new Date(user.depositTime).toLocaleString() : ''}</td>
            <td>
              <button class="btn-table btn-accept" onclick="approveDepositUSDT('${id}')">Approve</button>
              <button class="btn-table btn-reject" onclick="rejectDepositUSDT('${id}')">Reject</button>
            </td>`;
          tbody.appendChild(tr);
        }
      });

      db.ref("depositINRRequests").once("value").then(depositINRSnap => {
        depositINRSnap.forEach(childSnap => {
          const id = childSnap.key;
          const d = childSnap.val();
          if (d.status === "Pending") {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${id}</td>
              <td>(INR Deposit) Pending User</td>
              <td>${d.usdtAmount.toFixed(2)} USDT / ‚Çπ${d.inrAmount.toFixed(2)}</td>
              <td>INR</td>
              <td>${d.status}</td>
              <td>${d.depositTime ? new Date(d.depositTime).toLocaleString() : ''}</td>
              <td>
                <button class="btn-table btn-accept" onclick="approveDepositINR('${id}')">Approve</button>
                <button class="btn-table btn-reject" onclick="rejectDepositINR('${id}')">Reject</button>
              </td>`;
            tbody.appendChild(tr);
          }
        });
      });
    });
  }

  function loadWithdrawals() {
    const tbody = document.querySelector("#withdrawalsTable tbody");
    tbody.innerHTML = "";
    db.ref("withdrawals").once("value").then(withdrawalsSnap => {
      withdrawalsSnap.forEach(userSnap => {
        const userId = userSnap.key;
        userSnap.forEach(wSnap => {
          const w = wSnap.val();
          if (w.status === "Pending") {
            db.ref("users/" + userId).once("value").then(userDataSnap => {
              const userName = userDataSnap.val()?.name || "(Unknown)";
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${userId}</td>
                <td>${userName}</td>
                <td>${parseFloat(w.amount).toFixed(2)}</td>
                <td>${w.currency || "USDT"}</td>
                <td>${w.upiId || ""}</td>
                <td>${w.status}</td>
                <td>
                  <button class="btn-table btn-accept" onclick="approveWithdrawal('${userId}', '${wSnap.key}', ${w.amount}, '${w.currency || "USDT"}')">Approve</button>
                  <button class="btn-table btn-reject" onclick="rejectWithdrawal('${userId}', '${wSnap.key}')">Reject</button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          }
        });
      });
    });
  }

  // Modified to add referral income on deposit approval for USDT deposits
  async function approveDepositUSDT(userId) {
    const userSnap = await db.ref("users/" + userId).once("value");
    const user = userSnap.val();
    if (!user || user.status !== "Pending" || !user.deposit) return alert("Invalid deposit request");

    const depositAmount = parseFloat(user.deposit);

    // Add deposit to wallet balance, mark active
    const newWalletBalance = (parseFloat(user.walletBalance || 0)) + depositAmount;
    await db.ref("users/" + userId).update({
      status: "Active",
      walletBalance: newWalletBalance,
    });

    // Add referral income up to 3 levels
    addReferralIncome(depositAmount, userId);

    alert(`Deposit Approved for User: ${userId} and referral income distributed.`);
    loadDeposits();
    loadUsers();
  }

  // Modified to add referral income on deposit approval for INR deposits
  async function approveDepositINR(userId) {
    const reqSnap = await db.ref("depositINRRequests/" + userId).once("value");
    const req = reqSnap.val();
    if (!req || req.status !== "Pending") return alert("Invalid INR deposit request");

    const userSnap = await db.ref("users/" + userId).once("value");
    const user = userSnap.val();
    if (!user) return alert("User not found");

    const depositAmount = parseFloat(req.usdtAmount);
    const newDeposit = (parseFloat(user.deposit || 0)) + depositAmount;
    const newWalletBalance = (parseFloat(user.walletBalance || 0)) + depositAmount;

    await db.ref("users/" + userId).update({
      deposit: newDeposit,
      walletBalance: newWalletBalance,
      status: "Active",
      depositTime: req.depositTime
    });

    // Add referral income up to 3 levels
    addReferralIncome(depositAmount, userId);

    await db.ref("depositINRRequests/" + userId).remove();
    alert(`INR Deposit Approved for User: ${userId} and referral income distributed.`);
    loadDeposits();
    loadUsers();
  }

  function rejectDepositUSDT(userId) {
    db.ref("users/" + userId).once("value").then(snap => {
      const user = snap.val();
      if (!user || user.status !== "Pending" || !user.deposit) return alert("Invalid deposit request");

      db.ref("users/" + userId).update({
        deposit: 0,
        status: "Rejected",
        depositTime: null
      }).then(() => {
        alert(`Deposit Rejected for User: ${userId}`);
        loadDeposits();
        loadUsers();
      });
    });
  }

  function rejectDepositINR(userId) {
    db.ref("depositINRRequests/" + userId).once("value").then(snap => {
      const req = snap.val();
      if (!req || req.status !== "Pending") return alert("Invalid INR deposit request");

      db.ref("depositINRRequests/" + userId).remove().then(() => {
        alert(`INR Deposit Rejected for User: ${userId}`);
        loadDeposits();
      });
    });
  }

  function approveWithdrawal(userId, withdrawalKey, amount, currency) {
    db.ref("withdrawals/" + userId + "/" + withdrawalKey).once("value").then(wSnap => {
      const w = wSnap.val();
      if (!w || w.status !== "Pending") return alert("Withdrawal already processed or invalid");

      db.ref("withdrawals/" + userId + "/" + withdrawalKey).update({ status: "Approved" }).then(() => {
        alert(`Withdrawal Approved for User: ${userId}`);
        loadWithdrawals();
        loadUsers();
      });
    });
  }

  function rejectWithdrawal(userId, withdrawalKey) {
    db.ref("withdrawals/" + userId + "/" + withdrawalKey).once("value").then(wSnap => {
      const w = wSnap.val();
      if (!w || w.status !== "Pending") return alert("Withdrawal already processed or invalid");

      db.ref("users/" + userId).once("value").then(userSnap => {
        const user = userSnap.val();
        if (!user) return alert("User not found");

        let refundAmountUSDT = 0;
        if ((w.currency || "USDT") === "USDT") {
          refundAmountUSDT = parseFloat(w.amount);
        } else if (w.currency === "INR") {
          if (usdtToINRSell) {
            refundAmountUSDT = parseFloat(w.amount) / usdtToINRSell;
          }
        }

        const newWalletBalance = (parseFloat(user.walletBalance || 0)) + refundAmountUSDT;

        db.ref("users/" + userId + "/walletBalance").set(newWalletBalance).then(() => {
          db.ref("withdrawals/" + userId + "/" + withdrawalKey).update({ status: "Rejected" }).then(() => {
            alert(`Withdrawal Rejected and wallet refunded for User: ${userId}`);
            loadWithdrawals();
            loadUsers();
          });
        });
      });
    });
  }

  let editingUserKey = null;

  function openEditModal(userId) {
    editingUserKey = userId;
    db.ref("users/" + userId).once("value").then(snap => {
      const u = snap.val();
      if (!u) return;
      document.getElementById("editUserId").value = userId;
      document.getElementById("editName").value = u.name || "";
      document.getElementById("editMobile").value = u.mobile || "";
      document.getElementById("editWallet").value = u.wallet || "";
      document.getElementById("editPassword").value = "";
      document.getElementById("editRef").value = u.referredBy || "";
      document.getElementById("editStatus").value = u.status || "Pending";
      document.getElementById("editDeposit").value = parseFloat(u.deposit || 0);
      document.getElementById("editIncome").value = parseFloat(u.income || 0);
      document.getElementById("editWalletBalance").value = parseFloat(u.walletBalance || 0);
      document.getElementById("editDepositTime").value = u.depositTime || "";
      show(document.getElementById("editUserModal"));
    });
  }

  function closeEditModal() {
    editingUserKey = null;
    hide(document.getElementById("editUserModal"));
  }

  function saveUserChanges() {
    if (!editingUserKey) return;
    const userId = editingUserKey;
    const updatedData = {
      name: document.getElementById("editName").value,
      mobile: document.getElementById("editMobile").value,
      wallet: document.getElementById("editWallet").value,
      referredBy: document.getElementById("editRef").value,
      status: document.getElementById("editStatus").value,
      deposit: parseFloat(document.getElementById("editDeposit").value) || 0,
      income: parseFloat(document.getElementById("editIncome").value) || 0,
      walletBalance: parseFloat(document.getElementById("editWalletBalance").value) || 0,
      depositTime: document.getElementById("editDepositTime").value || null
    };
    // Password update only if entered
    const newPass = document.getElementById("editPassword").value;
    if (newPass.trim()) {
      updatedData.password = newPass;
    }
    db.ref("users/" + userId).update(updatedData).then(() => {
      alert("User data updated.");
      closeEditModal();
      loadUsers();
    }).catch(err => alert("Error updating user: " + err.message));
  }

  function deleteUser(userId) {
    if (!confirm(`Are you sure? Delete user ${userId} permanently?`)) return;
    db.ref("users/" + userId).remove().then(() => {
      alert("User deleted.");
      loadUsers();
    });
  }

  function addWeeklyIncome() {
    const userId = document.getElementById("incomeUserId").value.trim();
    const amt = parseFloat(document.getElementById("incomeAmt").value);
    if (!userId || isNaN(amt) || amt <= 0) return alert("Enter valid User ID and amount");

    db.ref("users/" + userId).once("value").then(snap => {
      if (!snap.exists()) return alert("User not found");

      const user = snap.val();
      const newIncome = (parseFloat(user.income || 0)) + amt;
      const newWalletBalance = (parseFloat(user.walletBalance || 0)) + amt;

      db.ref("users/" + userId).update({
        income: newIncome,
        walletBalance: newWalletBalance
      }).then(() => {
        alert("Weekly income added.");
        loadUsers();
        document.getElementById("incomeUserId").value = "";
        document.getElementById("incomeAmt").value = "";
      });
    });
  }

</script>

</body>
</html>
