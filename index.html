<!DOCTYPE html>
<html>
<head>
  <title>üöÄ Ashirwad Mart P - 6 Level Product MLM (LEGAL)</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Same dark theme CSS */
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #121212 0%, #1a1a2e 50%, #16213e 100%); color: #e0e0e0; margin: 0; padding: 15px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
    .box { background: rgba(30,30,30,0.95); padding: 25px; margin: 15px 0; border-radius: 16px; box-shadow: 0 12px 40px rgba(0,255,225,0.2); max-width: 700px; width: 100%; }
    h2 { color: #00ffe1; text-align: center; font-size: 28px; margin: 20px 0; }
    h3, h4 { color: #00ffe1; text-align: center; }
    input, button, select { padding: 14px; margin: 8px 0; width: 100%; border-radius: 8px; border: none; font-size: 16px; box-sizing: border-box; }
    input { background: #2a2a2a; color: #fff; }
    button { background: linear-gradient(45deg, #00ffe1, #00c7aa); color: #000; font-weight: 700; cursor: pointer; }
    button:hover { background: linear-gradient(45deg, #00c7aa, #00ffe1); }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th { background: #222; color: #00ffe1; padding: 15px; }
    td { padding: 12px; text-align: center; border-bottom: 1px solid #333; background: #1c1c1c; }
    .product-card { background: rgba(0,255,225,0.1); border: 2px solid #00ffe1; border-radius: 12px; padding: 20px; margin: 10px 0; }
    .hidden { display: none !important; }
    .admin-section { border: 2px solid #ff6b6b; background: rgba(43,27,27,0.9); }
    .bv-points { color: #ffaa00; font-weight: bold; font-size: 18px; }
  </style>
</head>
<body>
  <h2>üöÄ Ashirwad Mart P - Legal Product MLM</h2>
  
  <!-- LOGIN -->
  <div id="loginBox" class="box">
    <h3>üîê Login</h3>
    <input type="text" id="loginId" placeholder="User ID" />
    <input type="password" id="loginPass" placeholder="Password" />
    <button onclick="login()">Login</button>
    <p><a onclick="showRegister()" style="color: #00ffe1; cursor: pointer;">New? Register</a></p>
  </div>

  <!-- REGISTER -->
  <div id="registerBox" class="box hidden">
    <h3>üìù Register</h3>
    <input type="text" id="regName" placeholder="Full Name" />
    <input type="text" id="regMobile" placeholder="Mobile" />
    <input type="text" id="regWallet" placeholder="BEP20 USDT Wallet" />
    <input type="password" id="regPassword" placeholder="Password" />
    <input type="text" id="regRef" placeholder="Referral ID (Optional)" />
    <button onclick="register()">Register</button>
  </div>

  <!-- USER DASHBOARD -->
  <div id="userDashboard" class="box hidden">
    <h3>üëã <span id="userName"></span></h3>
    <p>ID: <span id="userId"></span> | BV Balance: <span class="bv-points" id="userBV">0</span></p>
    
    <h4>üõçÔ∏è Products (Buy to Activate)</h4>
    <div class="product-card">
      <h5>Sanitary Pads (‚Çπ150 = 150 BV)</h5>
      <p><strong>Physical Product Delivered + 150 BV</strong></p>
      <input type="number" id="sanitaryQty" placeholder="Quantity" min="1" max="10" value="1" />
      <button onclick="buySanitaryPads()">Buy Now (‚Çπ150 ea)</button>
    </div>
    
    <div class="product-card">
      <h5>Health Pack (‚Çπ500 = 500 BV)</h5>
      <p><strong>Supplements + 500 BV</strong></p>
      <input type="number" id="healthQty" placeholder="Quantity" min="1" max="5" value="1" />
      <button onclick="buyHealthPack()">Buy Now (‚Çπ500 ea)</button>
    </div>

    <h4>üìä Your Team (6 Levels)</h4>
    <button onclick="showTeamTree()">View Team Tree</button>
    <div id="teamTree"></div>

    <h4>üí∞ Commission History</h4>
    <div id="commissionHistory"></div>

    <button onclick="logout()">Logout</button>
  </div>

  <!-- ADMIN PANEL -->
  <div id="adminPanel" class="box admin-section hidden">
    <h3>üõ†Ô∏è Admin Dashboard</h3>
    <div>Total BV Sold: <span id="totalBV">0</span> | Active Users: <span id="totalUsers">0</span></div>
    
    <h4>Pending Product Orders</h4>
    <table id="ordersTable">
      <tr><th>ID</th><th>Name</th><th>Product</th><th>Qty</th><th>BV</th><th>Status</th><th>Actions</th></tr>
    </table>

    <h4>All Users</h4>
    <table id="usersTable">
      <tr><th>ID</th><th>Name</th><th>BV</th><th>Orders</th><th>Status</th></tr>
    </table>

    <button onclick="logout()">Logout</button>
  </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCBXuE2NHuZkKeQY7JjYM5vpbF1-K9AcS8",
  authDomain: "ashirwadmart-6d657.firebaseapp.com",
  databaseURL: "https://ashirwadmart-6d657-default-rtdb.firebaseio.com",
  projectId: "ashirwadmart-6d657"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentId = "";

// ‚úÖ LEGAL 6-LEVEL COMMISSION STRUCTURE (70% BV Distribution)
const LEVEL_COMMISSIONS = [0.175, 0.105, 0.084, 0.07, 0.035, 0.021]; // 17.5%, 10.5%, etc. = 49%

function show(ele) { document.getElementById(ele).classList.remove('hidden'); }
function hide(ele) { document.getElementById(ele).classList.add('hidden'); }
function toggleLoginRegister() {
  hide('loginBox'); show('registerBox');
}

async function register() {
  const name = document.getElementById('regName').value;
  const mobile = document.getElementById('regMobile').value;
  const wallet = document.getElementById('regWallet').value;
  const password = document.getElementById('regPassword').value;
  const ref = document.getElementById('regRef').value || '';

  if (!name || !mobile || !wallet || !password) {
    return alert('Fill all fields');
  }

  const id = 'U' + Date.now().toString().slice(-6);
  await db.ref('users/' + id).set({
    name, mobile, wallet, password, ref,
    bvBalance: 0, totalOrders: 0, status: 'Active',
    commissions: 0, level1: 0, level2: 0, level3: 0, level4: 0, level5: 0, level6: 0
  });

  alert(`‚úÖ Registered! ID: ${id}
Buy products to get BV & commissions!`);
  location.reload();
}

function login() {
  const id = document.getElementById('loginId').value;
  const pass = document.getElementById('loginPass').value;

  if (id === 'Admin' && pass === 'Jaihanuman@7') {
    currentId = 'Admin';
    hide('loginBox'); show('adminPanel');
    loadAdmin();
    return;
  }

  db.ref('users/' + id).once('value').then(snap => {
    const data = snap.val();
    if (data && data.password === pass) {
      currentId = id;
      loadUserDashboard(id);
      hide('loginBox'); show('userDashboard');
    } else {
      alert('Invalid credentials');
    }
  });
}

function loadUserDashboard(id) {
  db.ref('users/' + id).on('value', snap => {
    const data = snap.val();
    document.getElementById('userName').textContent = data.name;
    document.getElementById('userId').textContent = id;
    document.getElementById('userBV').textContent = data.bvBalance || 0;
  });
}

// ‚úÖ PRODUCT PURCHASE (LEGAL - Physical Product + BV)
async function buySanitaryPads() {
  const qty = parseInt(document.getElementById('sanitaryQty').value);
  const totalBV = qty * 150;
  const orderId = currentId + '_S_' + Date.now();

  await db.ref('orders/' + orderId).set({
    userId: currentId, product: 'Sanitary Pads', qty, totalBV,
    amountINR: qty * 150, status: 'Pending', timestamp: Date.now()
  });

  // Add to user total orders
  db.ref('users/' + currentId).transaction(user => {
    if (user) user.totalOrders = (user.totalOrders || 0) + qty;
    return user;
  });

  alert(`‚úÖ Order placed! ‚Çπ${qty*150} for ${qty} packs
Admin will approve & ship + ${totalBV} BV`);
}

async function buyHealthPack() {
  const qty = parseInt(document.getElementById('healthQty').value);
  const totalBV = qty * 500;
  const orderId = currentId + '_H_' + Date.now();

  await db.ref('orders/' + orderId).set({
    userId: currentId, product: 'Health Pack', qty, totalBV,
    amountINR: qty * 500, status: 'Pending', timestamp: Date.now()
  });

  db.ref('users/' + currentId).transaction(user => {
    if (user) user.totalOrders = (user.totalOrders || 0) + qty;
    return user;
  });

  alert(`‚úÖ Order placed! ‚Çπ${qty*500} for ${qty} packs
Admin approval ‚Üí Ship + ${totalBV} BV`);
}

// ‚úÖ 6-LEVEL TEAM TREE
async function showTeamTree() {
  const treeDiv = document.getElementById('teamTree');
  let html = '<div style="max-height:400px;overflow:auto;">';
  
  for (let level = 1; level <= 6; level++) {
    const users = await getLevelUsers(currentId, level);
    html += `<h5>L${level} (${users.length} members): ${users.reduce((sum, u) => sum + (u.bvBalance||0), 0).toFixed(0)} BV</h5>`;
    users.slice(0,10).forEach(u => {
      html += `<div>${u.id}: ${u.name} (${u.bvBalance} BV)</div>`;
    });
  }
  html += '</div>';
  treeDiv.innerHTML = html;
}

function logout() {
  currentId = '';
  hide('userDashboard');
  hide('adminPanel');
  show('loginBox');
}

// ADMIN FUNCTIONS
async function loadAdmin() {
  const ordersSnap = await db.ref('orders').once('value');
  const usersSnap = await db.ref('users').once('value');
  
  let totalBV = 0, totalUsers = 0;
  const tbody = document.querySelector('#ordersTable').parentNode.querySelector('tbody') || document.querySelector('#ordersTable');
  tbody.innerHTML = '';

  ordersSnap.forEach(snap => {
    const order = snap.val();
    if (order.status === 'Pending') {
      totalBV += order.totalBV;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${order.userId}</td>
        <td>${order.userId}</td>
        <td>${order.product}</td>
        <td>${order.qty}</td>
        <td>${order.totalBV}</td>
        <td>${order.status}</td>
        <td>
          <button onclick="approveOrder('${snap.key}')">‚úÖ Approve</button>
          <button onclick="rejectOrder('${snap.key}')">‚ùå Reject</button>
        </td>`;
      tbody.appendChild(tr);
    }
  });

  // Users table
  const usersTbody = document.querySelector('#usersTable').parentNode.querySelector('tbody') || document.querySelector('#usersTable');
  usersTbody.innerHTML = '';
  usersSnap.forEach(snap => {
    const user = snap.val();
    totalUsers++;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${snap.key}</td><td>${user.name}</td><td>${user.bvBalance||0}</td><td>${user.totalOrders||0}</td><td>${user.status}</td>`;
    usersTbody.appendChild(tr);
  });

  document.getElementById('totalBV').textContent = totalBV;
  document.getElementById('totalUsers').textContent = totalUsers;
}

async function approveOrder(orderId) {
  const orderSnap = await db.ref('orders/' + orderId).once('value');
  const order = orderSnap.val();
  
  // ‚úÖ ADD BV TO USER (Legal - Product delivered)
  await db.ref('users/' + order.userId).transaction(user => {
    if (user) {
      user.bvBalance = (user.bvBalance || 0) + order.totalBV;
      // Distribute 6-level commissions (49% of BV)
      distributeCommissions(order.userId, order.totalBV);
    }
    return user;
  });

  // Mark order complete
  await db.ref('orders/' + orderId).update({ status: 'Approved', approvedAt: Date.now() });
  
  alert(`‚úÖ Order approved! ${order.totalBV} BV added + commissions distributed`);
  loadAdmin();
}

function distributeCommissions(userId, bvAmount) {
  let current = userId;
  for (let level = 0; level < 6; level++) {
    db.ref('users/' + current).once('value').then(snap => {
      const referrerId = snap.val()?.ref;
      if (!referrerId) return;
      
      const commission = bvAmount * LEVEL_COMMISSIONS[level];
      db.ref('users/' + referrerId).transaction(user => {
        if (user) {
          user.bvBalance += commission;
          user[`level${level+1}`] = (user[`level${level+1}`] || 0) + 1;
        }
        return user;
      });
    });
    // Get next upline
    db.ref('users/' + current).once('value').then(snap => {
      current = snap.val()?.ref || '';
    });
  }
}

document.getElementById('loginId').addEventListener('keypress', e => {
  if (e.key === 'Enter') login();
});
</script>
</body>
</html>
