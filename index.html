<!DOCTYPE html>
<html>
<head>
  <title>Ashirwad Mart</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; background: #f0f8ff; }
    h2 { color: #333; }
    .box { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 0 8px #ccc; }
    input, button, select { padding: 10px; width: 100%; margin-top: 5px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; }
    button { background-color: #4CAF50; color: white; font-weight: bold; }
    .admin-section { background: #fff8e1; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>Ashirwad Mart</h2>

  <div id="auth" class="box">
    <input type="text" id="name" placeholder="Name" />
    <input type="text" id="mobile" placeholder="Mobile" />
    <input type="text" id="referral" placeholder="Referral Code (optional)" />
    <input type="text" id="usdt" placeholder="BEP20 USDT Address" />
    <button onclick="register()">Register</button>
    <hr />
    <input type="text" id="loginMobile" placeholder="Enter Mobile to Login" />
    <button onclick="login()">Login</button>
  </div>

  <div id="userPanel" class="box hidden">
    <h3>Welcome, <span id="userName"></span></h3>
    <p>Referral Code: <span id="userID"></span></p>
    <p>USDT Wallet: <span id="userWallet"></span></p>
    <p>Income Wallet: <b><span id="incomeWallet">0</span></b> USDT</p>
    <p>Agreement Status: <span id="agreementStatus">Active</span></p>
    <hr />
    <input type="number" id="depositAmount" placeholder="Enter Deposit (50 - 500 USDT)" />
    <button onclick="submitDeposit()">Deposit</button>
    <p>Send to: <b>0x49F7A836A32C1aCF04d4d20Fa87A14C7a19aB74B</b></p>
    <hr />
    <input type="number" id="withdrawAmount" placeholder="Withdraw Amount" />
    <button onclick="requestWithdraw()">Withdraw</button>
    <hr />
    <h4>Deposit History</h4>
    <ul id="depositHistory"></ul>
    <h4>Withdraw History</h4>
    <ul id="withdrawHistory"></ul>
    <hr />
    <h4>My Team</h4>
    <ul id="teamList"></ul>
    <hr />
    <button onclick="logout()">Logout</button>
  </div>

  <div id="adminPanel" class="box hidden admin-section">
    <h3>Admin Panel</h3>
    <input type="text" id="adminID" placeholder="Admin ID" />
    <input type="password" id="adminPass" placeholder="Password" />
    <button onclick="adminLogin()">Login</button>
    <div id="adminControls" class="hidden">
      <h4>All Users</h4>
      <div id="userTable"></div>
      <button onclick="logoutAdmin()">Logout</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyXXXXXXX",
      authDomain: "ashirwadmart-6d657.firebaseapp.com",
      projectId: "ashirwadmart-6d657",
      storageBucket: "ashirwadmart-6d657.appspot.com",
      messagingSenderId: "157185768316",
      appId: "1:157185768316:web:XXXXXXXXXXXX"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null;

    function register() {
      const name = document.getElementById("name").value;
      const mobile = document.getElementById("mobile").value;
      const referral = document.getElementById("referral").value;
      const usdt = document.getElementById("usdt").value;

      if (!name || !mobile || !usdt) return alert("All fields required");

      const userRef = db.ref("users/" + mobile);
      userRef.once("value", snap => {
        if (snap.exists()) return alert("Mobile already registered");
        userRef.set({
          name, mobile, referral, usdt,
          deposit: 0,
          income: 0,
          referralIncome: 0,
          totalIncome: 0,
          agreementClosed: false,
          deposits: [],
          withdrawals: [],
          team: []
        });
        alert("Registered! Now login.");
      });
    }

    function login() {
      const mobile = document.getElementById("loginMobile").value;
      db.ref("users/" + mobile).once("value", snap => {
        if (!snap.exists()) return alert("User not found");
        currentUser = snap.val();
        showUserPanel();
      });
    }

    function showUserPanel() {
      document.getElementById("auth").classList.add("hidden");
      document.getElementById("userPanel").classList.remove("hidden");

      document.getElementById("userName").innerText = currentUser.name;
      document.getElementById("userID").innerText = currentUser.mobile;
      document.getElementById("userWallet").innerText = currentUser.usdt;
      document.getElementById("incomeWallet").innerText = currentUser.income.toFixed(2);
      document.getElementById("agreementStatus").innerText = currentUser.agreementClosed ? "Closed" : "Active";

      updateDepositHistory();
      updateWithdrawHistory();
      updateTeam();
    }

    function submitDeposit() {
      const amount = parseFloat(document.getElementById("depositAmount").value);
      if (amount < 50 || amount > 500) return alert("Amount should be between 50-500");

      const uid = currentUser.mobile;
      const time = new Date().toLocaleString();
      db.ref("users/" + uid + "/deposits").push({ amount, time, status: "Pending" });

      alert("Deposit submitted. Wait for admin approval.");
    }

    function requestWithdraw() {
      const amount = parseFloat(document.getElementById("withdrawAmount").value);
      if (currentUser.income < amount || amount < 1) return alert("Insufficient income or invalid amount.");

      const uid = currentUser.mobile;
      const time = new Date().toLocaleString();
      db.ref("users/" + uid + "/withdrawals").push({ amount, time, status: "Pending" });

      // Set income to 0 and close agreement if total income reached
      if ((currentUser.totalIncome + amount) >= currentUser.deposit * 2) {
        db.ref("users/" + uid).update({
          income: 0,
          agreementClosed: true
        });
      } else {
        db.ref("users/" + uid + "/income").set(currentUser.income - amount);
      }

      alert("Withdraw request submitted.");
    }

    function updateDepositHistory() {
      const list = document.getElementById("depositHistory");
      list.innerHTML = "";
      db.ref("users/" + currentUser.mobile + "/deposits").once("value", snap => {
        snap.forEach(child => {
          const d = child.val();
          const li = document.createElement("li");
          li.innerText = `${d.time} - ${d.amount} USDT (${d.status})`;
          list.appendChild(li);
        });
      });
    }

    function updateWithdrawHistory() {
      const list = document.getElementById("withdrawHistory");
      list.innerHTML = "";
      db.ref("users/" + currentUser.mobile + "/withdrawals").once("value", snap => {
        snap.forEach(child => {
          const d = child.val();
          const li = document.createElement("li");
          li.innerText = `${d.time} - ${d.amount} USDT (${d.status})`;
          list.appendChild(li);
        });
      });
    }

    function updateTeam() {
      const list = document.getElementById("teamList");
      list.innerHTML = "";
      db.ref("users").once("value", snap => {
        snap.forEach(child => {
          const u = child.val();
          if (u.referral === currentUser.mobile) {
            const li = document.createElement("li");
            li.innerText = `${u.name} (${u.mobile})`;
            list.appendChild(li);
          }
        });
      });
    }

    function logout() {
      location.reload();
    }

    function adminLogin() {
      const id = document.getElementById("adminID").value;
      const pass = document.getElementById("adminPass").value;
      if (id === "Admin" && pass === "Jaihanuman@7") {
        document.getElementById("adminControls").classList.remove("hidden");
        loadAllUsers();
      } else alert("Invalid admin login");
    }

    function loadAllUsers() {
      const div = document.getElementById("userTable");
      div.innerHTML = "";
      db.ref("users").once("value", snap => {
        snap.forEach(child => {
          const u = child.val();
          const el = document.createElement("div");
          el.className = "box";
          el.innerHTML = `
            <b>${u.name}</b> (${u.mobile})<br/>
            Wallet: ${u.usdt}<br/>
            Deposit: ${u.deposit} USDT<br/>
            Income: ${u.income.toFixed(2)}<br/>
            Referral Income: ${u.referralIncome}<br/>
            Agreement: ${u.agreementClosed ? "Closed" : "Active"}
          `;
          div.appendChild(el);
        });
      });
    }

    function logoutAdmin() {
      location.reload();
    }
  </script>
</body>
  </html>
