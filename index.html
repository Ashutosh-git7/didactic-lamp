<!DOCTYPE html>
<html>
<head>
  <title>Ashirwad Mart</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f1f1f1; }
    .container { padding: 20px; max-width: 500px; margin: auto; background: white; margin-top: 20px; border-radius: 10px; }
    input, button, select { width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid #ccc; }
    .section { margin-top: 30px; }
    .admin-only { display: none; background: #fff8dc; padding: 10px; border: 1px dashed #999; border-radius: 10px; }
    .history-box { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container" id="app">
    <h2>Ashirwad Mart</h2>
    <div id="auth-section">
      <input type="text" id="mobile" placeholder="Enter Mobile Number" />
      <input type="text" id="name" placeholder="Enter Name" />
      <input type="text" id="wallet" placeholder="Your BEP20 USDT Wallet" />
      <button onclick="register()">Register / Login</button>
    </div>

    <div id="user-section" style="display:none;">
      <p><b>ID:</b> <span id="userid"></span></p>
      <p><b>Wallet:</b> <span id="usdtWallet"></span></p>
      <p><b>Deposit:</b> $<span id="totalDeposit">0</span></p>
      <p><b>Income Wallet:</b> $<span id="incomeWallet">0</span></p>
      <p><b>Status:</b> <span id="agreementStatus">Active</span></p>
      <div class="section">
        <h4>Make a Deposit</h4>
        <p>Send USDT to: <b>0x49F7A836A32C1aCF04d4d20Fa87A14C7a19aB74B</b></p>
        <input type="number" id="depositAmount" placeholder="Enter amount (50–500)" />
        <button onclick="submitDeposit()">Submit Deposit</button>
      </div>
      <div class="section">
        <h4>Withdraw Request</h4>
        <input type="number" id="withdrawAmount" placeholder="Enter amount (min $1)" />
        <button onclick="submitWithdrawal()">Request Withdrawal</button>
      </div>
      <div class="section">
        <h4>Your History</h4>
        <div id="depositHistory" class="history-box">Deposits will appear here</div>
        <div id="withdrawHistory" class="history-box">Withdrawals will appear here</div>
      </div>
      <div class="section">
        <h4>Referral Team</h4>
        <div id="referralList" class="history-box"></div>
      </div>
      <div class="section">
        <button onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="admin-only" id="adminPanel">
      <h3>Admin Panel</h3>
      <input type="text" id="adminID" placeholder="Admin ID" />
      <input type="password" id="adminPass" placeholder="Password" />
      <button onclick="adminLogin()">Login as Admin</button>
      <div id="adminControls" style="display:none;">
        <button onclick="loadAllUsers()">Load All Users</button>
        <div id="adminUserList" class="history-box"></div>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCrx-...", // 🔁 Replace with your real config
      authDomain: "ashirwadmart-6d657.firebaseapp.com",
      databaseURL: "https://ashirwadmart-6d657-default-rtdb.firebaseio.com",
      projectId: "ashirwadmart-6d657",
      storageBucket: "ashirwadmart-6d657.appspot.com",
      messagingSenderId: "1093051757739",
      appId: "1:1093051757739:web:cdf0a1986f63d08d79819a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null;

    function register() {
      const mobile = document.getElementById('mobile').value.trim();
      const name = document.getElementById('name').value.trim();
      const wallet = document.getElementById('wallet').value.trim();
      if (!mobile || !name || !wallet) return alert("Please fill all fields.");
      const userId = "UID" + mobile;
      db.ref("users/" + userId).once("value", snap => {
        if (!snap.exists()) {
          db.ref("users/" + userId).set({
            mobile, name, wallet,
            deposit: 0,
            income: 0,
            referralIncome: 0,
            agreement: "active",
            depositHistory: [],
            withdrawHistory: [],
            refBy: getReferrer() || ""
          });
        }
        localStorage.setItem("userId", userId);
        loadUser(userId);
      });
    }

    function loadUser(userId) {
      db.ref("users/" + userId).on("value", snap => {
        if (!snap.exists()) return;
        currentUser = snap.val();
        currentUser.id = userId;
        document.getElementById("auth-section").style.display = "none";
        document.getElementById("user-section").style.display = "block";
        document.getElementById("userid").innerText = userId;
        document.getElementById("usdtWallet").innerText = currentUser.wallet;
        document.getElementById("totalDeposit").innerText = currentUser.deposit || 0;
        document.getElementById("incomeWallet").innerText = currentUser.income || 0;
        document.getElementById("agreementStatus").innerText = currentUser.agreement;

        loadHistory("depositHistory", currentUser.depositHistory || []);
        loadHistory("withdrawHistory", currentUser.withdrawHistory || []);
        loadReferralList(userId);
      });
    }

    function loadHistory(elemId, data) {
      const box = document.getElementById(elemId);
      box.innerHTML = "";
      if (!data.length) return box.innerText = "No history";
      data.forEach(item => {
        box.innerHTML += `<div>• ${item}</div>`;
      });
    }

    function submitDeposit() {
      const amt = parseFloat(document.getElementById("depositAmount").value);
      if (isNaN(amt) || amt < 50 || amt > 500) return alert("Amount must be between 50 and 500.");
      const note = "Deposit requested: $" + amt;
      db.ref("users/" + currentUser.id + "/depositHistory").push(note);
      db.ref("users/" + currentUser.id + "/pendingDeposit").set(amt);
      alert("Deposit submitted. Admin will approve.");
    }

    function submitWithdrawal() {
      const amt = parseFloat(document.getElementById("withdrawAmount").value);
      if (isNaN(amt) || amt < 1) return alert("Min withdrawal is 1 USDT.");
      if (currentUser.income < amt) return alert("Insufficient income.");
      if (currentUser.agreement !== "active") return alert("Agreement closed.");
      const note = "Withdraw requested: $" + amt;
      db.ref("users/" + currentUser.id + "/withdrawHistory").push(note);
      db.ref("users/" + currentUser.id + "/pendingWithdraw").set(amt);
      alert("Withdrawal request sent.");
    }

    function getReferrer() {
      const params = new URLSearchParams(location.search);
      return params.get("r") || "";
    }

    function logout() {
      localStorage.removeItem("userId");
      location.reload();
    }

    function adminLogin() {
      const id = document.getElementById("adminID").value;
      const pass = document.getElementById("adminPass").value;
      if (id === "Admin" && pass === "Jaihanuman@7") {
        document.getElementById("adminControls").style.display = "block";
        alert("Admin logged in");
      } else {
        alert("Wrong admin credentials.");
      }
    }

    function loadAllUsers() {
      db.ref("users").once("value", snap => {
        const list = document.getElementById("adminUserList");
        list.innerHTML = "";
        snap.forEach(user => {
          const u = user.val();
          const uid = user.key;
          list.innerHTML += `
            <div>
              <b>${uid}</b> (${u.name}) - ${u.wallet}<br/>
              Deposit: ${u.deposit || 0}, Income: ${u.income || 0}, Agreement: ${u.agreement}<br/>
              <button onclick="approveDeposit('${uid}', ${u.pendingDeposit || 0})">Approve Deposit</button>
              <button onclick="approveWithdrawal('${uid}', ${u.pendingWithdraw || 0})">Approve Withdrawal</button>
              <button onclick="addWeekly('${uid}')">Add Weekly Income</button>
              <button onclick="closeAgreement('${uid}')">Close Agreement</button>
              <hr/>
            </div>
          `;
        });
      });
    }

    function approveDeposit(uid, amt) {
      if (!amt || amt <= 0) return alert("No pending deposit.");
      db.ref("users/" + uid).once("value", snap => {
        const u = snap.val();
        const total = (u.deposit || 0) + amt;
        db.ref("users/" + uid).update({ deposit: total });
        db.ref("users/" + uid + "/pendingDeposit").remove();
        if (u.refBy) {
          db.ref("users/" + u.refBy).once("value", refSnap => {
            const refUser = refSnap.val();
            if (refUser) {
              let newIncome = (refUser.income || 0) + amt * 0.05;
              db.ref("users/" + u.refBy).update({ income: newIncome });
            }
          });
        }
        alert("Deposit approved.");
      });
    }

    function approveWithdrawal(uid, amt) {
      if (!amt || amt <= 0) return alert("No withdrawal pending.");
      db.ref("users/" + uid).once("value", snap => {
        const u = snap.val();
        const incomeLeft = (u.income || 0) - amt;
        db.ref("users/" + uid).update({ income: Math.max(incomeLeft, 0) });
        db.ref("users/" + uid + "/pendingWithdraw").remove();
        if (u.agreement === "closed") db.ref("users/" + uid + "/income").set(0);
        alert("Withdrawal approved.");
      });
    }

    function addWeekly(uid) {
      db.ref("users/" + uid).once("value", snap => {
        const u = snap.val();
        const totalIncome = (u.income || 0);
        const maxIncome = (u.deposit || 0) * 2;
        if (totalIncome >= maxIncome) {
          alert("2x already reached.");
          return;
        }
        const weekly = (u.deposit || 0) * 0.10;
        const newIncome = Math.min(totalIncome + weekly, maxIncome);
        db.ref("users/" + uid + "/income").set(newIncome);
        alert("Weekly income added.");
      });
    }

    function closeAgreement(uid) {
      db.ref("users/" + uid).update({ agreement: "closed" });
      alert("Agreement closed.");
    }

    function loadReferralList(uid) {
      db.ref("users").once("value", snap => {
        let team = [];
        snap.forEach(user => {
          if (user.val().refBy === uid) {
            team.push(user.key + " - " + user.val().name);
          }
        });
        document.getElementById("referralList").innerHTML = team.length ? team.join("<br/>") : "No referrals.";
      });
    }

    // Auto-login if user in localStorage
    const savedId = localStorage.getItem("userId");
    if (savedId) loadUser(savedId);
  </script>
</body>
      </html>
