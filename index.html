<!DOCTYPE html>
<html>
<head>
  <title>Ashirwad Mart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="module">
    // Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, get, child, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBysNDv5s2VStATDEZWW0Q-4__KMb_AEKc",
      authDomain: "ashirwadmart-6d657.firebaseapp.com",
      databaseURL: "https://ashirwadmart-6d657-default-rtdb.firebaseio.com",
      projectId: "ashirwadmart-6d657",
      storageBucket: "ashirwadmart-6d657.appspot.com",
      messagingSenderId: "765873367260",
      appId: "1:765873367260:web:09376fa89be3d471b44579"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase();

    let currentUser = null;
    let isAdmin = false;

    function generateUserID() {
      return 'UID' + Math.floor(1000 + Math.random() * 9000);
    }

    function registerUser() {
      const name = document.getElementById('regName').value;
      const mobile = document.getElementById('regMobile').value;
      const wallet = document.getElementById('regWallet').value;
      const refCode = document.getElementById('regRef').value.trim();
      const userID = generateUserID();

      if (!name || !mobile || !wallet) {
        alert("Fill all fields");
        return;
      }

      const userRef = ref(db, 'users/' + userID);
      set(userRef, {
        name: name,
        mobile: mobile,
        wallet: wallet,
        referrer: refCode || '',
        deposit: 0,
        income: 0,
        referralIncome: 0,
        totalIncome: 0,
        status: 'pending'
      }).then(() => {
        alert('Registered! Your User ID: ' + userID);
        localStorage.setItem('userID', userID);
        showUserPanel(userID);
      });
    }

    function loginUser() {
      const userID = document.getElementById('loginID').value;
      get(child(ref(db), 'users/' + userID)).then((snap) => {
        if (snap.exists()) {
          currentUser = userID;
          localStorage.setItem('userID', userID);
          showUserPanel(userID);
        } else {
          alert('User not found!');
        }
      });
    }

    function showUserPanel(uid) {
      get(child(ref(db), 'users/' + uid)).then((snap) => {
        const data = snap.val();
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('registerPage').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'none';
        document.getElementById('userPanel').style.display = 'block';

        document.getElementById('userInfo').innerHTML = `
          <p><b>Name:</b> ${data.name}</p>
          <p><b>Mobile:</b> ${data.mobile}</p>
          <p><b>Wallet:</b> ${data.wallet}</p>
          <p><b>Deposit:</b> ${data.deposit} USDT</p>
          <p><b>Referral Income:</b> ${data.referralIncome} USDT</p>
          <p><b>Income:</b> ${data.income} USDT</p>
          <p><b>Status:</b> ${data.status}</p>
        `;
      });
    }

    function adminLogin() {
      const id = document.getElementById('adminID').value;
      const pass = document.getElementById('adminPass').value;
      if (id === "Admin" && pass === "Jaihanuman@7") {
        isAdmin = true;
        showAdminPanel();
      } else {
        alert("Invalid admin credentials");
      }
    }

    function showAdminPanel() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('registerPage').style.display = 'none';
      document.getElementById('userPanel').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'block';

      get(child(ref(db), 'users')).then((snap) => {
        const allUsers = snap.val();
        let html = '';
        for (const id in allUsers) {
          const u = allUsers[id];
          html += `
            <div style="border:1px solid #999;padding:10px;margin:10px;">
              <b>ID:</b> ${id}<br>
              <b>Name:</b> ${u.name}<br>
              <b>Deposit:</b> ${u.deposit} USDT<br>
              <b>Income:</b> ${u.income} USDT<br>
              <b>Status:</b> ${u.status}<br>
              <button onclick="approveDeposit('${id}')">Approve Deposit</button>
              <button onclick="addWeeklyIncome('${id}')">+ Weekly Income</button>
              <button onclick="closeAgreement('${id}')">Close</button>
            </div>
          `;
        }
        document.getElementById('adminUsers').innerHTML = html;
      });
    }

    window.addWeeklyIncome = function (id) {
      const uref = ref(db, 'users/' + id);
      get(uref).then((snap) => {
        const data = snap.val();
        if (data.status === 'closed') return alert('Agreement closed.');
        let newIncome = data.income + data.deposit * 0.1;
        let total = data.deposit * 2;
        if (newIncome >= total) {
          newIncome = total;
        }
        update(uref, { income: newIncome });
        showAdminPanel();
      });
    }

    window.approveDeposit = function (id) {
      const amount = prompt("Enter deposit amount (50-500 USDT):");
      const amt = parseFloat(amount);
      if (isNaN(amt) || amt < 50 || amt > 500) return alert("Invalid amount");

      const uref = ref(db, 'users/' + id);
      get(uref).then((snap) => {
        const data = snap.val();
        update(uref, { deposit: amt, status: 'active' });

        // Referral bonus
        if (data.referrer) {
          const refRef = ref(db, 'users/' + data.referrer);
          get(refRef).then((rSnap) => {
            if (rSnap.exists()) {
              const rData = rSnap.val();
              const newRefIncome = rData.referralIncome + (amt * 0.05);
              update(refRef, { referralIncome: newRefIncome });
            }
          });
        }

        showAdminPanel();
      });
    }

    window.closeAgreement = function (id) {
      const uref = ref(db, 'users/' + id);
      update(uref, { status: 'closed' });
      showAdminPanel();
    }

    function logout() {
      localStorage.removeItem('userID');
      location.reload();
    }

    window.onload = () => {
      const uid = localStorage.getItem('userID');
      if (uid) {
        showUserPanel(uid);
      }
    }
  </script>
</head>
<body style="font-family:sans-serif;padding:20px;">
  <h2>Ashirwad Mart</h2>

  <div id="registerPage">
    <h3>Register</h3>
    <input id="regName" placeholder="Full Name"><br><br>
    <input id="regMobile" placeholder="Mobile Number"><br><br>
    <input id="regWallet" placeholder="USDT BEP20 Wallet Address"><br><br>
    <input id="regRef" placeholder="Referral ID (Optional)"><br><br>
    <button onclick="registerUser()">Register</button>
    <p>Already registered? <a href="#" onclick="document.getElementById('registerPage').style.display='none';document.getElementById('loginPage').style.display='block';">Login here</a></p>
    <p>Admin? <a href="#" onclick="document.getElementById('registerPage').style.display='none';document.getElementById('adminLogin').style.display='block';">Admin Login</a></p>
  </div>

  <div id="loginPage" style="display:none;">
    <h3>User Login</h3>
    <input id="loginID" placeholder="Enter User ID"><br><br>
    <button onclick="loginUser()">Login</button>
    <p><a href="#" onclick="document.getElementById('loginPage').style.display='none';document.getElementById('registerPage').style.display='block';">Back to Register</a></p>
  </div>

  <div id="adminLogin" style="display:none;">
    <h3>Admin Login</h3>
    <input id="adminID" placeholder="Admin ID"><br><br>
    <input id="adminPass" placeholder="Password" type="password"><br><br>
    <button onclick="adminLogin()">Login</button>
    <p><a href="#" onclick="document.getElementById('adminLogin').style.display='none';document.getElementById('registerPage').style.display='block';">Back</a></p>
  </div>

  <div id="userPanel" style="display:none;">
    <h3>Your Dashboard</h3>
    <div id="userInfo"></div><br>
    <button onclick="logout()">Logout</button>
  </div>

  <div id="adminPanel" style="display:none;">
    <h3>Admin Panel</h3>
    <div id="adminUsers">Loading users...</div>
    <button onclick="logout()">Logout</button>
  </div>
</body>
</html>
