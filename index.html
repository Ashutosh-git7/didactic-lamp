<!-- FULL FINAL HTML CODE FOR ASHIRWAD MART -->
<!DOCTYPE html> 
<html>
<head>
  <title>🚀 Ashirwad Mart - Grow Up Together</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #121212;
      color: #e0e0e0;
      padding: 15px;
      margin: 0;
    }
    h2, h3, h4 {
      color: #00ffe1;
      text-align: center;
    }
    .box {
      background: #1e1e1e;
      padding: 20px;
      margin: 15px 0;
      border-radius: 12px;
      box-shadow: 0 0 10px #00ffe170;
    }
    input, button, select {
      padding: 12px;
      margin: 10px 0;
      width: 100%;
      border-radius: 6px;
      border: none;
      font-size: 16px;
    }
    input {
      background: #2a2a2a;
      color: #fff;
    }
    button {
      background: #00ffe1;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #00c7aa;
    }
    .hidden {
      display: none;
    }
    .admin-section {
      background: #2b1b1b;
      border: 1px solid #ff5555;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 8px;
      text-align: center;
      border-bottom: 1px solid #333;
    }
    th {
      background-color: #222;
      color: #00ffe1;
    }
    td {
      background-color: #1c1c1c;
    }
    a {
      color: #00ffe1;
      text-decoration: underline;
      cursor: pointer;
    }
    ul {
      padding-left: 20px;
    }
  </style>
</head>
<body>

<h2>🚀 Ashirwad Mart - Grow Up Together</h2>

<div id="loginBox" class="box">
  <h3>🔐 Login</h3>
  <input type="text" id="loginId" placeholder="Enter ID" />
  <input type="password" id="loginPass" placeholder="Password" />
  <button onclick="login()">Login</button>
  <p>Don't have ID? <a onclick="showRegister()">Register here</a></p>
</div>

<div id="registerBox" class="box hidden">
  <p><a onclick="showForgot()">Forgot Password?</a></p>
  <h3>📝 New Registration</h3>
  <input type="text" id="regName" placeholder="Full Name" />
  <input type="text" id="regMobile" placeholder="Mobile Number" />
  <input type="text" id="regWallet" placeholder="BEP20 USDT Wallet Address" />
  <input type="password" id="regPassword" placeholder="Set Password" />
<input type="text" id="regRef" placeholder="Referral ID (optional)" />
  <button onclick="register()">Register Now</button>
  
</div><div id="forgotBox" class="box hidden">
  <h3>🔑 Reset Password via OTP</h3>
  <input type="text" id="otpMobile" placeholder="Enter Registered Mobile Number" />
  <div id="recaptcha-container"></div>
  <button onclick="sendOTP()">Send OTP</button>
  <input type="text" id="otpCode" placeholder="Enter OTP" />
  <input type="password" id="otpNewPass" placeholder="New Password" />
  <button onclick="verifyOTP()">Verify & Change Password</button>
  <p><a onclick="backToLogin()">🔙 Back to Login</a></p>
</div>

<div id="userDashboard" class="box hidden">
  <h3>👋 Hello, <span id="userName"></span></h3>
  <p>💼 Wallet: <span id="userWallet"></span></p>
  <p>💰 Deposit: <b><span id="userDeposit">0</span> USDT</b></p>
  <p>📈 Income: <b><span id="userIncome">0</span> USDT</b></p>
  <p>🏦 Withdrawal Wallet: <b><span id="userWithdrawWallet"></span></b></p>
<p>🎯 Income Target (2x): <b><span id="userTarget">0</span> USDT</b></p>
<p>📉 Remaining Target: <b><span id="userRemaining">0</span> USDT</b></p>
  <p>🔒 Status: <span id="userStatus">Pending</span></p>
<p>💳 Wallet Balance: <b><span id="walletBalance">0</span> USDT</b></p>

<hr />
<h4>📱 Change Password via OTP</h4>
<input type="text" id="otpMobile" placeholder="Enter Registered Mobile Number" />
<div id="recaptcha-container"></div>
<button onclick="sendOTP()">Send OTP</button>
<input type="text" id="otpCode" placeholder="Enter OTP" />
<input type="password" id="otpNewPass" placeholder="New Password" />
<button onclick="verifyOTP()">Verify & Change Password</button>
  
  <hr />
  <h4>📥 Deposit Funds</h4>
  <p>Send 100–1000 USDT to:</p>
  <code>0x49F7A836A32C1aCF04d4d20Fa87A14C7a19aB74B</code>
  <input type="number" id="depAmount" placeholder="Enter amount (100-1000)" />
  <button onclick="submitDeposit()">Submit Deposit</button>

  <hr />
  <h4>💸 Request Withdrawal</h4>
  <input type="number" id="withAmt" placeholder="Min 5 USDT" />
  <button onclick="requestWithdraw()">Request Withdrawal</button>

  <hr />
  <h4>👨‍👩‍👧‍👦 Referral Team</h4>
  <button onclick="viewTeam()">View Your Team</button>
  <div id="teamBox"></div>
<!-- === USDT BUY/SELL BOX (paste inside #userDashboard, History section se pehle) === -->
<hr />
<div class="box">
  <h4>🪙 USDT Buy / Sell</h4>

  <div style="display:flex; gap:10px;">
    <button id="tabBuy" onclick="switchTrade('buy')">Buy USDT</button>
    <button id="tabSell" onclick="switchTrade('sell')">Sell USDT</button>
  </div>

  <div id="buyBox" style="margin-top:10px;">
    <p>🔐 Payment via UPI: <b>ashutoshkarmkar7-1@oksbi</b></p>
    <p>💱 Buy Price (per USDT): <b><span id="buyPriceInr">—</span> INR</b> (includes +5%)</p>
    <input type="number" id="buyAmtUsdt" placeholder="USDT amount e.g. 100" />
    <input type="text" id="buyWallet" placeholder="Your BEP20 USDT wallet to receive" />
    <input type="text" id="buyUpiRef" placeholder="UPI Payment Reference (optional)" />
    <p>🧮 You will pay: <b><span id="buyTotalInr">0</span> INR</b></p>
    <button onclick="submitBuy()">Submit Buy Request</button>
  </div>

  <div id="sellBox" class="hidden" style="margin-top:10px;">
    <p>📤 Send USDT to BEP20: <b>0x49F7A836A32C1aCF04d4d20Fa87A14C7a19aB74B</b></p>
    <p>💱 Sell Price (per USDT): <b><span id="sellPriceInr">—</span> INR</b> (includes −5%)</p>
    <input type="number" id="sellAmtUsdt" placeholder="USDT amount e.g. 100" />
    <input type="text" id="sellUpi" placeholder="Your UPI ID to receive INR" />
    <input type="text" id="sellTxHash" placeholder="Transaction Hash / Remark (optional)" />
    <p>🧮 You will receive: <b><span id="sellTotalInr">0</span> INR</b></p>
    <button onclick="submitSell()">Submit Sell Request</button>
  </div>
      </div>
  <hr />
  <h4>📜 History</h4>
  <button onclick="viewHistory()">View History</button>
  <div id="historyBox"></div>

  <button onclick="logout()">🚪 Logout</button>
</div>

<div id="adminPanel" class="box admin-section hidden">
  <h3>🛠️ Admin Dashboard</h3>
  <!-- === ADMIN: Market Price Control & Buy/Sell Requests === -->
<h4>⚙️ Market Price (USDT → INR) — hidden from users</h4>
<input type="number" id="adminMarketPrice" step="0.01" placeholder="e.g. 90.00" />
<button onclick="saveMarketPrice()">Save Price</button>
<p>Current Market Price: <b><span id="currentMarketPrice">—</span> INR</b></p>

<div id="adminTrades"></div>
  <div id="adminUsers"></div>

  <h4>➕ Add Weekly Income</h4>
  <input type="text" id="incomeUserId" placeholder="User ID" />
  <input type="number" id="incomeAmt" placeholder="Amount" />
  <button onclick="addWeeklyIncome()">Add Income</button>

  <button onclick="logout()">🚪 Logout</button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCBXuE2NHuZkKeQY7JjYM5vpbF1-K9AcS8",
    authDomain: "ashirwadmart-6d657.firebaseapp.com",
    databaseURL: "https://ashirwadmart-6d657-default-rtdb.firebaseio.com",
    projectId: "ashirwadmart-6d657",
    storageBucket: "ashirwadmart-6d657.appspot.com",
    messagingSenderId: "1013585797321",
    appId: "1:1013585797321:web:8a5c5fdb50c6aa7e7e57aa"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  let currentId = "";

  function showRegister() {
    document.getElementById('loginBox').classList.add('hidden');
    document.getElementById('registerBox').classList.remove('hidden');
  }

function showForgot() {
  document.getElementById('loginBox').classList.add('hidden');
  document.getElementById('registerBox').classList.add('hidden');
  document.getElementById('forgotBox').classList.remove('hidden');
}

function backToLogin() {
  document.getElementById('forgotBox').classList.add('hidden');
  document.getElementById('loginBox').classList.remove('hidden');
}

  function login() {
  const id = document.getElementById('loginId').value.trim();
  const pass = document.getElementById('loginPass').value;
  if (id === "Admin" && pass === "Jaihanuman@7") {
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("adminPanel").classList.remove("hidden");
    loadAdmin();
    return;
  }
  db.ref("users/" + id).once("value", snap => {
    if (snap.exists()) {
      const data = snap.val();
      if (data.password !== pass) return alert("Incorrect password");
      currentId = id;
      loadUser(id);
      document.getElementById("loginBox").classList.add("hidden");
      // Disable deposit button if agreement is active
if (data.status === "Active" && deposit > 0) {
  document.getElementById("depAmount").disabled = true;
  document.querySelector("button[onclick='submitDeposit()']").disabled = true;
  document.querySelector("button[onclick='submitDeposit()']").innerText = "Deposit Locked (Active)";
} else {
  document.getElementById("depAmount").disabled = false;
  document.querySelector("button[onclick='submitDeposit()']").disabled = false;
  document.querySelector("button[onclick='submitDeposit()']").innerText = "Submit Deposit";
}
      document.getElementById("userDashboard").classList.remove("hidden");
    } else {
      alert("User ID not found.");
    }
  });
  }

  function register() {
    const name = document.getElementById("regName").value.trim();
    const mobile = document.getElementById("regMobile").value.trim();
    const wallet = document.getElementById("regWallet").value.trim();
    const ref = document.getElementById("regRef").value.trim();
    if (!name || !mobile || !wallet) return alert("Please fill all fields");
    const id = "U" + Math.floor(Math.random() * 100000);
    
    const password = document.getElementById("regPassword").value.trim();
if (!password) return alert("Please set a password");

const userData = {
  name, mobile, wallet, deposit: 0, income: 0, status: "Pending", referredBy: ref, password, walletBalance: 0
};
    db.ref("users/" + id).set(userData).then(() => {
      alert("Registered! Your ID: " + id);
      location.reload();
    });
  }

  function loadUser(id) {
  db.ref("users/" + id).on("value", snap => {
    const data = snap.val();
    const deposit = parseFloat(data.deposit || 0);
    const income = parseFloat(data.income || 0);
    const cap = deposit * 2;
    const remaining = Math.max(0, cap - income);
  
    // remove this block completely — it's unused and causes error
    
    const balance = parseFloat(data.walletBalance || 0);

    document.getElementById("userName").innerText = data.name;
    document.getElementById("userWallet").innerText = data.wallet;
    document.getElementById("userDeposit").innerText = deposit;
    document.getElementById("userIncome").innerText = income;
    document.getElementById("userStatus").innerText = data.status;
    document.getElementById("userWithdrawWallet").innerText = data.wallet;
    document.getElementById("userTarget").innerText = cap;
    document.getElementById("userRemaining").innerText = remaining;
    document.getElementById("walletBalance").innerText = balance;
    document.getElementById("walletBalance").innerText = balance;
document.getElementById("userDashboard").classList.remove("hidden");
    // Auto close agreement if income reaches 2x
    
    if (deposit > 0 && income >= cap && data.status !== "Closed") {
      db.ref("users/" + id).update({
        income: 0,
        deposit: 0,
        status: "Closed"
      });
      alert("🎉 Congratulations! Your agreement has completed 2x and is now closed.");
    }
  });
}

  function submitDeposit() {
  db.ref("users/" + currentId).once("value", snap => {
    const data = snap.val();
    if (data.status === "Active") {
      return alert("Deposit is locked until agreement is closed.");
    }

    const amt = parseFloat(document.getElementById("depAmount").value);
    if (amt < 100 || amt > 1000) return alert("Invalid amount");

    db.ref("users/" + currentId).update({
      deposit: amt,
      status: "Pending"
    }).then(() => {
      alert("Deposit submitted! Waiting for admin approval.");
    });
  });
}

  function requestWithdraw() {
  const amt = parseFloat(document.getElementById("withAmt").value);
  if (amt < 5) return alert("Minimum 5 USDT");

  db.ref("users/" + currentId).once("value", snap => {
    const data = snap.val();
    const walletBalance = parseFloat(data.walletBalance || 0);
    if (amt > walletBalance) return alert("Insufficient wallet balance");

    db.ref("users/" + currentId + "/walletBalance").set(walletBalance - amt);
    db.ref("withdrawals/" + currentId).push({ amount: amt, status: "Pending" });
    alert("Withdrawal requested!");
  });
}

  function viewTeam() {
    db.ref("users").once("value", snap => {
      let html = "<ul>";
      snap.forEach(child => {
        const data = child.val();
        if (data.referredBy === currentId) {
          html += `<li>${child.key}: ${data.name} - ${data.deposit} USDT - ${data.status}</li>`;
        }
      });
      html += "</ul>";
      document.getElementById("teamBox").innerHTML = html;
    });
  }

  function viewHistory() {
    let html = "<h5>Withdrawals:</h5><ul>";
    db.ref("withdrawals/" + currentId).once("value", snap => {
      snap.forEach(child => {
        const d = child.val();
        html += `<li>${d.amount} USDT - ${d.status}</li>`;
      });
      html += "</ul>";
      document.getElementById("historyBox").innerHTML = html;
    });
  }

  function loadAdmin() {
    db.ref("users").once("value", snap => {
      let html = "<h4>All Users</h4><table><tr><th>ID</th><th>Name</th><th>Wallet</th><th>Deposit</th><th>Income</th><th>Status</th><th>Actions</th></tr>";
      snap.forEach(child => {
        const d = child.val();
        html += `<tr>
          <td>${child.key}</td>
          <td>${d.name}</td>
          <td>${d.wallet}</td>
          <td>${d.deposit}</td>
          <td>${d.income}</td>
          <td>${d.status}</td>
          <td>
            <button onclick="approveDeposit('${child.key}')">✅ Accept</button>
            <button onclick="rejectDeposit('${child.key}')">❌ Reject</button>
            <button onclick="closeAgreement('${child.key}')">🔒 Close</button>
          </td>
        </tr>`;
      });
      html += "</table>";
      document.getElementById("adminUsers").innerHTML = html;
    });

    db.ref("withdrawals").once("value", snap => {
      let html = "<h4>Pending Withdrawals</h4><table><tr><th>User ID</th><th>Amount</th><th>Status</th><th>Action</th></tr>";
      snap.forEach(userSnap => {
        const userId = userSnap.key;
        userSnap.forEach(wSnap => {
          const w = wSnap.val();
          if (w.status === "Pending") {
            html += `<tr>
              <td>${userId}</td>
              <td>${w.amount}</td>
              <td>${w.status}</td>
              <td>
                <button onclick="approveWithdraw('${userId}', '${wSnap.key}')">Approve</button>
                <button onclick="rejectWithdraw('${userId}', '${wSnap.key}')">Reject</button>
              </td>
            </tr>`;
          }
        });
      });
      html += "</table>";
      document.getElementById("adminUsers").innerHTML += html;
    });
  }

  function approveDeposit(userId) {
  db.ref("users/" + userId).once("value", snap => {
    const data = snap.val();
    const amt = parseFloat(data.deposit || 0);

    // Mark deposit as active
    db.ref("users/" + userId + "/status").set("Active");

    // Referral income distribution (only after approval)
    if (data.referredBy) {
      const ref1 = data.referredBy;
      db.ref("users/" + ref1).once("value", s1 => {
        if (s1.exists()) {
          const d1 = s1.val();
          const cap1 = (parseFloat(d1.deposit) || 0) * 2;
          const currentIncome1 = parseFloat(d1.income || 0);
          const walletBalance1 = parseFloat(d1.walletBalance || 0);
          const bonus1 = amt * 0.05;
          const newIncome1 = Math.min(currentIncome1 + bonus1, cap1);
          const actualAdded1 = newIncome1 - currentIncome1;

          db.ref("users/" + ref1).update({
            income: newIncome1,
            walletBalance: walletBalance1 + actualAdded1
          });

          // Level 2: 3%
          if (d1.referredBy) {
            const ref2 = d1.referredBy;
            db.ref("users/" + ref2).once("value", s2 => {
              if (s2.exists()) {
                const d2 = s2.val();
                const cap2 = (parseFloat(d2.deposit) || 0) * 2;
                const currentIncome2 = parseFloat(d2.income || 0);
                const walletBalance2 = parseFloat(d2.walletBalance || 0);
                const bonus2 = amt * 0.03;
                const newIncome2 = Math.min(currentIncome2 + bonus2, cap2);
                const actualAdded2 = newIncome2 - currentIncome2;

                db.ref("users/" + ref2).update({
                  income: newIncome2,
                  walletBalance: walletBalance2 + actualAdded2
                });

                // Level 3: 2%
                if (d2.referredBy) {
                  const ref3 = d2.referredBy;
                  db.ref("users/" + ref3).once("value", s3 => {
                    if (s3.exists()) {
                      const d3 = s3.val();
                      const cap3 = (parseFloat(d3.deposit) || 0) * 2;
                      const currentIncome3 = parseFloat(d3.income || 0);
                      const walletBalance3 = parseFloat(d3.walletBalance || 0);
                      const bonus3 = amt * 0.02;
                      const newIncome3 = Math.min(currentIncome3 + bonus3, cap3);
                      const actualAdded3 = newIncome3 - currentIncome3;

                      db.ref("users/" + ref3).update({
                        income: newIncome3,
                        walletBalance: walletBalance3 + actualAdded3
                      });
                    }
                  });
                }
              }
            });
          }
        }
      });
    }

    alert("Deposit approved and referral income distributed.");
  });
}

  function rejectDeposit(userId) {
    db.ref("users/" + userId).update({ deposit: 0, status: "Rejected" });
    alert("Deposit rejected.");
  }

  function closeAgreement(userId) {
    db.ref("users/" + userId).update({ status: "Closed", deposit: 0, income: 0 });
    alert("Agreement closed.");
  }

  function approveWithdraw(userId, withdrawId) {
    db.ref("withdrawals/" + userId + "/" + withdrawId + "/status").set("Approved");
    db.ref("users/" + userId).once("value", snap => {
      const data = snap.val();
      const deposit = parseFloat(data.deposit || 0);
      const income = parseFloat(data.income || 0);
      if (deposit > 0 && income >= 2 * deposit) {
        db.ref("users/" + userId).update({
          income: 0,
          deposit: 0,
          status: "Closed"
        });
      }
    });
    alert("Withdrawal approved.");
  }

  function rejectWithdraw(userId, withdrawId) {
    db.ref("withdrawals/" + userId + "/" + withdrawId + "/status").set("Rejected");
    alert("Withdrawal rejected.");
  }

  function addWeeklyIncome() {
  const uid = document.getElementById("incomeUserId").value.trim();
  const amt = parseFloat(document.getElementById("incomeAmt").value);
  if (!uid || isNaN(amt)) return alert("Enter valid input");

  db.ref("users/" + uid).once("value", snap => {
    if (!snap.exists()) {
      return alert("User ID not found!");
    }

    const data = snap.val();
    const deposit = parseFloat(data.deposit || 0);
    const income = parseFloat(data.income || 0);
    const walletBalance = parseFloat(data.walletBalance || 0);
    const cap = deposit * 2;

    // अगर income पहले से 2x हो चुका है तो income नहीं जोड़ेगा
    if (deposit > 0 && income >= cap) {
      db.ref("users/" + uid).update({
        status: "Closed",
        deposit: 0,
        income: 0
      });
      return alert("User already reached 2x. Agreement closed.");
    }

    const newIncome = Math.min(income + amt, cap);
    const actualAdded = newIncome - income;

    db.ref("users/" + uid).update({
      income: newIncome,
      walletBalance: walletBalance + actualAdded
    });

    // Auto close जब 2x पूरा हो जाए
    if (newIncome >= cap) {
      db.ref("users/" + uid).update({
        status: "Closed",
        deposit: 0,
        income: 0
      });
      alert("🎉 Income added. User reached 2x, agreement closed.");
    } else {
      alert("✅ Weekly income added successfully!");
    }
  });
}
  let confirmationResultGlobal = null;

function sendOTP() {
  const mobile = document.getElementById("otpMobile").value.trim();
  if (!mobile) return alert("Enter your registered mobile number");

  const fullNumber = "+91" + mobile; // Change as per your country code

  window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
    'size': 'normal',
    'callback': function(response) {
      // reCAPTCHA solved
    }
  });

  firebase.auth().signInWithPhoneNumber(fullNumber, window.recaptchaVerifier)
    .then(function (confirmationResult) {
      confirmationResultGlobal = confirmationResult;
      alert("OTP sent successfully");
    })
    .catch(function (error) {
      alert("Error sending OTP: " + error.message);
    });
}

function verifyOTP() {
  const code = document.getElementById("otpCode").value.trim();
  const newPass = document.getElementById("otpNewPass").value.trim();
  const mobile = document.getElementById("otpMobile").value.trim();

  if (!code || !newPass) return alert("Please enter all fields");

  confirmationResultGlobal.confirm(code).then(function (result) {
    // User signed in via OTP
    const phone = result.user.phoneNumber;

    // Find user by phone
    db.ref("users").once("value", snap => {
      let found = false;
      snap.forEach(child => {
        const data = child.val();
        if (data.mobile === mobile) {
          db.ref("users/" + child.key + "/password").set(newPass);
          alert("✅ Password changed successfully!");
          found = true;
        }
      });
      if (!found) alert("Mobile number not found");
    });
  }).catch(function (error) {
    alert("OTP verification failed: " + error.message);
  });
}
  
/* ===== USDT BUY/SELL LOGIC ===== */
let MARKET_PRICE = 0; // INR per USDT (admin sets in /config/marketPrice)

function watchMarketPrice() {
  db.ref("config/marketPrice").on("value", snap => {
    MARKET_PRICE = parseFloat(snap.val() || 0);
    const el = document.getElementById("currentMarketPrice");
    if (el) el.innerText = MARKET_PRICE ? MARKET_PRICE.toFixed(2) : "—";
    updateTradePrices();
  });
}

function saveMarketPrice() {
  const v = parseFloat(document.getElementById("adminMarketPrice").value);
  if (isNaN(v) || v <= 0) return alert("Enter valid market price (INR)");
  db.ref("config/marketPrice").set(v).then(()=>alert("Market price saved."));
}

function switchTrade(tab) {
  const buyBox = document.getElementById("buyBox");
  const sellBox = document.getElementById("sellBox");
  const tabBuy = document.getElementById("tabBuy");
  const tabSell = document.getElementById("tabSell");
  if (tab === "buy") {
    buyBox.classList.remove("hidden");
    sellBox.classList.add("hidden");
    tabBuy.style.opacity = "1";
    tabSell.style.opacity = "0.7";
  } else {
    sellBox.classList.remove("hidden");
    buyBox.classList.add("hidden");
    tabSell.style.opacity = "1";
    tabBuy.style.opacity = "0.7";
  }
  updateTradePrices();
}

function updateTradePrices() {
  const buyPrice = MARKET_PRICE ? MARKET_PRICE * 1.05 : 0;
  const sellPrice = MARKET_PRICE ? MARKET_PRICE * 0.95 : 0;

  const buySpan = document.getElementById("buyPriceInr");
  const sellSpan = document.getElementById("sellPriceInr");
  if (buySpan) buySpan.innerText = buyPrice ? buyPrice.toFixed(2) : "—";
  if (sellSpan) sellSpan.innerText = sellPrice ? sellPrice.toFixed(2) : "—";

  // Totals
  const buyAmt = parseFloat(document.getElementById("buyAmtUsdt")?.value || 0);
  const sellAmt = parseFloat(document.getElementById("sellAmtUsdt")?.value || 0);

  const buyTotal = (buyPrice * buyAmt) || 0;
  const sellTotal = (sellPrice * sellAmt) || 0;

  const buyTotalEl = document.getElementById("buyTotalInr");
  const sellTotalEl = document.getElementById("sellTotalInr");
  if (buyTotalEl) buyTotalEl.innerText = Math.round(buyTotal).toString();
  if (sellTotalEl) sellTotalEl.innerText = Math.round(sellTotal).toString();
}

// Recalculate totals when user types amounts
document.addEventListener("input", (e) => {
  if (["buyAmtUsdt","sellAmtUsdt"].includes(e.target.id)) updateTradePrices();
});

// Prefill buy wallet from user profile when dashboard loads
function prefFillTradeFields(userData) {
  const w = document.getElementById("buyWallet");
  if (w && userData?.wallet) w.value = userData.wallet;
}

// Override/extend existing loadUser to prefill & prices (call after your existing UI updates)
const __orig_loadUser = loadUser;
loadUser = function(id) {
  db.ref("users/" + id).on("value", snap => {
    const data = snap.val();

    // call your existing UI updater (from your original loadUser)
    // We re-run same logic as you had:
    const deposit = parseFloat(data.deposit || 0);
    const income = parseFloat(data.income || 0);
    const cap = deposit * 2;
    const remaining = Math.max(0, cap - income);
    const balance = parseFloat(data.walletBalance || 0);

    document.getElementById("userName").innerText = data.name;
    document.getElementById("userWallet").innerText = data.wallet;
    document.getElementById("userDeposit").innerText = deposit;
    document.getElementById("userIncome").innerText = income;
    document.getElementById("userStatus").innerText = data.status;
    document.getElementById("userWithdrawWallet").innerText = data.wallet;
    document.getElementById("userTarget").innerText = cap;
    document.getElementById("userRemaining").innerText = remaining;
    document.getElementById("walletBalance").innerText = balance;
    document.getElementById("userDashboard").classList.remove("hidden");

    if (deposit > 0 && income >= cap && data.status !== "Closed") {
      db.ref("users/" + id).update({ income: 0, deposit: 0, status: "Closed" });
      alert("🎉 Congratulations! Your agreement has completed 2x and is now closed.");
    }

    // NEW: trade prefill
    prefFillTradeFields(data);
    updateTradePrices();
  });
};

// Submit Buy
function submitBuy() {
  if (!currentId) return alert("Please login first.");
  if (!MARKET_PRICE) return alert("Market price not set by admin yet.");

  const amt = parseFloat(document.getElementById("buyAmtUsdt").value);
  const recvWallet = document.getElementById("buyWallet").value.trim();
  const upiRef = document.getElementById("buyUpiRef").value.trim();

  if (isNaN(amt) || amt <= 0) return alert("Enter valid USDT amount.");
  if (!recvWallet) return alert("Enter your BEP20 USDT wallet address.");

  const price = MARKET_PRICE * 1.05;
  const totalInr = Math.round(price * amt);

  const payload = {
    userId: currentId,
    type: "BUY",
    amountUSDT: amt,
    priceINR: parseFloat(price.toFixed(2)),
    totalINR: totalInr,
    payToUPI: "ashutoshkarmkar7-1@oksbi",
    userWalletBEP20: recvWallet,
    upiReference: upiRef || "",
    status: "Pending",
    createdAt: Date.now()
  };

  const ref = db.ref("buyRequests").push();
  ref.set(payload).then(()=>{
    // also store under user history
    db.ref(`users/${currentId}/orders/${ref.key}`).set(payload);
    alert("✅ Buy request submitted! Pay via UPI shown and wait for admin approval.");
  });
}

// Submit Sell
function submitSell() {
  if (!currentId) return alert("Please login first.");
  if (!MARKET_PRICE) return alert("Market price not set by admin yet.");

  const amt = parseFloat(document.getElementById("sellAmtUsdt").value);
  const userUpi = document.getElementById("sellUpi").value.trim();
  const tx = document.getElementById("sellTxHash").value.trim();

  if (isNaN(amt) || amt <= 0) return alert("Enter valid USDT amount.");
  if (!userUpi) return alert("Enter your UPI ID to receive INR.");

  const price = MARKET_PRICE * 0.95;
  const totalInr = Math.round(price * amt);

  const payload = {
    userId: currentId,
    type: "SELL",
    amountUSDT: amt,
    priceINR: parseFloat(price.toFixed(2)),
    totalINR: totalInr,
    sendUSDTToBEP20: "0x49F7A836A32C1aCF04d4d20Fa87A14C7a19aB74B",
    userUPI: userUpi,
    txHash: tx || "",
    status: "Pending",
    createdAt: Date.now()
  };

  const ref = db.ref("sellRequests").push();
  ref.set(payload).then(()=>{
    db.ref(`users/${currentId}/orders/${ref.key}`).set(payload);
    alert("✅ Sell request submitted! Send USDT to shown address and wait for admin approval.");
  });
}

/* ===== ADMIN LISTING & ACTIONS ===== */
function loadTradesForAdmin() {
  // Auto-refresh lists
  db.ref("buyRequests").on("value", snap => {
    let html = "<h4>🛒 Buy Requests</h4><table><tr><th>ID</th><th>User</th><th>USDT</th><th>Price (INR)</th><th>Total (INR)</th><th>BEP20</th><th>UPI Ref</th><th>Status</th><th>Action</th></tr>";
    snap.forEach(child => {
      const d = child.val();
      html += `<tr>
        <td>${child.key}</td>
        <td>${d.userId}</td>
        <td>${d.amountUSDT}</td>
        <td>${d.priceINR}</td>
        <td>${d.totalINR}</td>
        <td>${d.userWalletBEP20 || "-"}</td>
        <td>${d.upiReference || "-"}</td>
        <td>${d.status}</td>
        <td>
          <button onclick="approveBuy('${child.key}')">Approve</button>
          <button onclick="rejectBuy('${child.key}')">Reject</button>
        </td>
      </tr>`;
    });
    html += "</table>";
    document.getElementById("adminTrades").innerHTML = html;
  });

  db.ref("sellRequests").on("value", snap => {
    let html = document.getElementById("adminTrades").innerHTML;
    html += "<h4>💼 Sell Requests</h4><table><tr><th>ID</th><th>User</th><th>USDT</th><th>Price (INR)</th><th>Total (INR)</th><th>User UPI</th><th>TX/Remark</th><th>Status</th><th>Action</th></tr>";
    snap.forEach(child => {
      const d = child.val();
      html += `<tr>
        <td>${child.key}</td>
        <td>${d.userId}</td>
        <td>${d.amountUSDT}</td>
        <td>${d.priceINR}</td>
        <td>${d.totalINR}</td>
        <td>${d.userUPI || "-"}</td>
        <td>${d.txHash || "-"}</td>
        <td>${d.status}</td>
        <td>
          <button onclick="approveSell('${child.key}')">Approve</button>
          <button onclick="rejectSell('${child.key}')">Reject</button>
        </td>
      </tr>`;
    });
    html += "</table>";
    document.getElementById("adminTrades").innerHTML = html;
  });
}

function approveBuy(reqId) {
  db.ref("buyRequests/" + reqId).update({ status: "Approved", approvedAt: Date.now() });
  alert("✅ Buy approved.");
}
function rejectBuy(reqId) {
  db.ref("buyRequests/" + reqId).update({ status: "Rejected", rejectedAt: Date.now() });
  alert("❌ Buy rejected.");
}
function approveSell(reqId) {
  db.ref("sellRequests/" + reqId).update({ status: "Approved", approvedAt: Date.now() });
  alert("✅ Sell approved.");
}
function rejectSell(reqId) {
  db.ref("sellRequests/" + reqId).update({ status: "Rejected", rejectedAt: Date.now() });
  alert("❌ Sell rejected.");
}

/* ===== HOOK INTO EXISTING FLOWS ===== */
// Call these when app starts / admin logs in
(function initTradeModule(){
  watchMarketPrice();
  // If admin panel becomes visible, load trades
  const observer = new MutationObserver(() => {
    const adminVisible = !document.getElementById("adminPanel").classList.contains("hidden");
    if (adminVisible) loadTradesForAdmin();
  });
  observer.observe(document.body, { attributes:true, childList:true, subtree:true });
})();
    function logout() {
    location.reload();
  }
</script>
</body>
  </html>
