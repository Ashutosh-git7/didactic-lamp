<!DOCTYPE html>
<html>
<head>
  <title>üöÄ Ashirwad Mart P - Grow Up Together</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #121212;
      color: #e0e0e0;
      margin: 0;
      padding: 15px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h2, h3, h4, h5 {
      color: #00ffe1;
      text-align: center;
      margin: 12px 0 8px;
      font-weight: 600;
    }
    .box {
      background: #1e1e1e;
      padding: 24px 30px;
      margin: 20px 0;
      border-radius: 12px;
      box-shadow: 0 0 18px #00ffe170;
      width: 100%;
      max-width: 650px;
      box-sizing: border-box;
    }
    input, button, select, textarea {
      padding: 12px 15px;
      margin: 10px 0 20px 0;
      width: 100%;
      border-radius: 6px;
      border: none;
      font-size: 16px;
      background: #2a2a2a;
      color: #fff;
      box-sizing: border-box;
      transition: background-color 0.2s ease, box-shadow 0.2s ease;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      background-color: #393939;
      box-shadow: 0 0 6px #00ffe1aa;
    }
    button {
      background: #00ffe1;
      color: #000;
      font-weight: 700;
      cursor: pointer;
      border: none;
      transition: background 0.3s ease;
      user-select: none;
    }
    button:hover, button:focus {
      background: #00c7aa;
      outline: none;
    }
    a {
      color: #00ffe1;
      text-decoration: underline;
      cursor: pointer;
      user-select: none;
    }
    a:hover {
      color: #00c7aa;
    }
    .hidden {
      display: none !important;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0 10px 0;
    }
    th, td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #333;
      font-size: 14px;
    }
    th {
      background-color: #222;
      color: #00ffe1;
      font-weight: 700;
    }
    td {
      background-color: #1c1c1c;
      word-break: break-word;
    }
    .admin-section {
      background: #2b1b1b;
      border: 2px solid #ff5555;
      max-width: 980px;
    }
    .admin-section h3 {
      margin-top: 0;
    }
    .btn-table {
      padding: 6px 10px;
      margin: 0 3px;
      font-size: 13px;
      border-radius: 6px;
      font-weight: 600;
    }
    .btn-accept {
      background-color: #28a745;
      color: #fff;
      border: none;
    }
    .btn-reject {
      background-color: #dc3545;
      color: #fff;
      border: none;
    }
    .btn-close {
      background-color: #6c757d;
      color: #fff;
      border: none;
    }
    .btn-edit {
      background-color: #007bff;
      color: #fff;
      border: none;
    }
    .btn-delete {
      background-color: #e55753;
      color: #fff;
      border: none;
    }
    .btn-small {
      padding: 5px 8px;
      font-size: 12px;
    }
    #userDashboard {
      max-width: 650px;
      text-align: left;
    }
    #userDashboard p, #userDashboard code {
      margin: 6px 0;
      font-size: 15px;
    }
    #profitChartContainer {
      margin-top: 20px;
      background: #272727;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 0 12px #00ffe1bb;
    }
    #profitChart {
      width: 100% !important;
      max-height: 250px;
    }
    code {
      display: inline-block;
      background-color: #333;
      padding: 6px 10px;
      border-radius: 6px;
      font-family: monospace;
      user-select: all;
    }
    hr {
      border: none;
      border-top: 1px solid #262626;
      margin: 25px 0;
    }
    @media (max-width: 640px) {
      .box, .admin-section {
        max-width: 100%;
        padding: 15px 20px;
      }
      table, th, td {
        font-size: 12px;
      }
      button, input, select, textarea {
        font-size: 14px;
      }
    }
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal-content {
      background: #1e1e1e;
      border-radius: 12px;
      padding: 25px 30px;
      width: 100%;
      max-width: 480px;
      box-shadow: 0 0 20px #00ffe1bb;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .modal-header h4 {
      margin: 0;
      color: #00ffe1;
    }
    .modal-close {
      font-size: 22px;
      font-weight: 700;
      cursor: pointer;
      color: #ff5555;
      user-select: none;
    }
    .tmpl-section {
      border: 2px solid #ff6b35;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      background: #2a1a0f;
    }
    .btn-stake {
      background-color: #ff6b35;
      color: #fff;
      border: none;
    }
  </style>
</head>
<body>

<h2>üöÄ Ashirwad Mart P - Grow Up Together</h2>

<div id="loginBox" class="box">
  <h3>üîê Login</h3>
  <input type="text" id="loginId" placeholder="Enter ID" autocomplete="username" />
  <input type="password" id="loginPass" placeholder="Password" autocomplete="current-password" />
  <button onclick="login()">Login</button>
  <p>Don't have ID? <a onclick="showRegister()">Register here</a></p>
</div>

<div id="registerBox" class="box hidden">
  <p><a onclick="showForgot()">Forgot Password?</a></p>
  <h3>üìù New Registration</h3>
  <input type="text" id="regName" placeholder="Full Name" autocomplete="name"/>
  <input type="text" id="regMobile" placeholder="Mobile Number" autocomplete="tel"/>
  <input type="text" id="regWallet" placeholder="BEP20 USDT Wallet Address" />
  <input type="password" id="regPassword" placeholder="Set Password" autocomplete="new-password"/>
  <input type="text" id="regRef" placeholder="Referral ID (optional)" />
  <button onclick="register()">Register Now</button>
</div>

<div id="forgotBox" class="box hidden">
  <h3>üîë Reset Password via OTP</h3>
  <input type="text" id="otpMobile" placeholder="Enter Registered Mobile Number" autocomplete="tel" />
  <div id="recaptcha-container"></div>
  <button onclick="sendOTP()">Send OTP</button>
  <input type="text" id="otpCode" placeholder="Enter OTP" autocomplete="one-time-code" />
  <input type="password" id="otpNewPass" placeholder="New Password" autocomplete="new-password" />
  <button onclick="verifyOTP()">Verify & Change Password</button>
  <p><a onclick="backToLogin()">üîô Back to Login</a></p>
</div>
<div id="userDashboard" class="box hidden">
  <h3>üëã Hello, <span id="userName"></span></h3>
  <p>üíº Wallet: <span id="userWallet"></span></p>
  
  <!-- üî• TMPL STAKING -->
  <div class="tmpl-section">
    <h4>üî• TMPL Staking (5% Monthly)</h4>
    <p>Staked: <b><span id="tmplStaked">0</span></b> | Next: <span id="nextRewardDate">N/A</span></p>
    <p>5% Reward: <b><span id="monthlyReward">0</span></b></p>
    <input type="number" id="tmplStakeAmount" placeholder="TMPL (Min 100)" min="100"/>
    <button onclick="submitTMPLStake()">Stake</button>
    <button onclick="requestTMPLWithdraw()">Withdraw</button>
  </div>

  <p>üí∞ Deposit: <b><span id="userDeposit">0</span> USDT</b></p>
  <p><small><em>Deposit Time: <span id="userDepositTime">N/A</span></em></small></p>
  <p>üìà Income: <b><span id="userIncome">0</span> USDT</b></p>
  <p>üè¶ Withdrawal Wallet: <b><span id="userWithdrawWallet"></span></b></p>
  <p><small>Set your UPI ID for INR withdrawals:</small></p>
  <input type="text" id="userUPI" placeholder="Enter your UPI ID here" autocomplete="off" />
  <button id="saveUPIButton" onclick="saveUserUPI()">Save UPI ID</button>
  <p>üéØ Income Target (2x): <b><span id="userTarget">0</span> USDT</b></p>
  <p>üìâ Remaining Target: <b><span id="userRemaining">0</span> USDT</b></p>
  <p>üîí Status: <span id="userStatus">Pending</span></p>
  <p>üí≥ Wallet Balance: <b><span id="walletBalance">0</span> USDT</b></p>

  <hr />
  <h4>üì• Deposit Funds</h4>
  <label>
    <input type="radio" name="depositCurrency" value="USDT" checked onclick="updateDepositUI()" /> Deposit in USDT
  </label>
  <label>
    <input type="radio" name="depositCurrency" value="INR" onclick="updateDepositUI()" /> Deposit in INR (UPI)
  </label>

  <div id="depositUSDTDiv" style="margin-top: 15px;">
    <p>Send 100‚Äì1000 USDT to:</p>
    <code>0x49F7A836A32C1aCF04d4d20Fa87A14C7a19aB74B</code>
    <input type="number" id="depAmount" placeholder="Enter amount (100-1000)" min="100" max="1000" />
    <button onclick="submitDeposit()">Submit Deposit</button>
  </div>

  <div id="depositINRDiv" class="hidden" style="margin-top: 15px;">
    <p>Current USDT to INR Buy Rate = <b><span id="usdtToInrBuyRate">Loading...</span> ‚Çπ</b></p>
    <p>Enter USDT amount to deposit (100-1000 USDT):</p>
    <input type="number" id="depINRUSDTAmount" placeholder="Enter USDT amount (100-1000)" min="100" max="1000" oninput="updateINRDepositAmount()" />
    <p>You need to pay (INR) <b><span id="depINRAmount">0</span></b> via UPI.</p>
    <p>Send payment to UPI ID: <code>ashutoshkarmkar7-1@oksbi</code></p>
    <button onclick="submitDepositINR()">Submit INR Deposit Request</button>
  </div>

  <hr />
  <h4>üí∏ Request Withdrawal</h4>

  <label>
    <input type="radio" name="withdrawCurrency" value="USDT" checked onclick="updateWithdrawUI()" /> Withdraw in USDT
  </label>
  <label>
    <input type="radio" name="withdrawCurrency" value="INR" onclick="updateWithdrawUI()" /> Withdraw in INR
  </label>

  <div id="withdrawUSDTDiv" style="margin-top: 15px;">
    <p>Your BEP20 USDT Wallet Address: <code id="userWalletAddress"></code></p>
    <input type="number" id="withAmt" placeholder="Min 5 USDT" min="5" />
    <button onclick="requestWithdraw()">Request Withdrawal</button>
  </div>

  <div id="withdrawINRDiv" class="hidden" style="margin-top: 15px;">
    <p>Current USDT to INR Sell Rate = <b><span id="usdtToInrSellRate">Loading...</span> ‚Çπ</b></p>
    <p>Wallet Balance: <span id="walletBalanceINR">0</span> ‚Çπ (approx.)</p>
    <p>Enter INR withdrawal amount (Min ‚Çπ373 approx for 5 USDT):</p>
    <input type="number" id="withAmtINR" placeholder="Enter INR amount" min="0" />
    <button onclick="requestWithdrawINR()">Request INR Withdrawal</button>
  </div>

  <hr />
  <h4>üîë Change Password</h4>
  <input type="password" id="changePassCurrent" placeholder="Current Password" />
  <input type="password" id="changePassNew" placeholder="New Password" />
  <button onclick="changePasswordNormal()">Change Password</button>
  
  <hr/>
  <h4>üë®üë©üëßüë¶ Referral Team</h4>
  <button onclick="viewTeam()">View Your Team</button>
  <div id="teamBox"></div>

  <hr />
  <h4>üìú History</h4>
  <button onclick="viewHistory()">View History</button>
  <div id="historyBox"></div>

  <div id="profitChartContainer" class="hidden">
    <h4>üìä Profit Graph (Deposit vs Income)</h4>
    <canvas id="profitChart"></canvas>
  </div>

  <button onclick="logout()">üö™ Logout</button>
</div>
<div id="adminPanel" class="box admin-section hidden">
  <h3>üõ†Ô∏è Admin Dashboard</h3>

  <div style="margin-bottom:15px; font-size: 16px; color: #00ffe1;">
    <b>Total Deposit Balance:</b> <span id="totalDepositBalance">0</span> USDT &nbsp;&nbsp;&nbsp;
    <b>Total Wallet Balance:</b> <span id="totalWalletBalance">0</span> USDT
  </div>
  
  <div id="adminTMPLStakes">
    <h4>üî• Pending TMPL Stakes</h4>
    <table id="tmplStakesTable"><thead><tr><th>User</th><th>TMPL</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>
  </div>
  <button onclick="processMonthlyRewards()">‚öôÔ∏è 5% Rewards Process</button>

  <h4>üî• Add TMPL Stake (Admin)</h4>
  <input type="text" id="adminTMPLUserId" placeholder="User ID (e.g. U12345)" />
  <input type="number" id="adminTMPLAmount" placeholder="TMPL Amount (Min 100)" min="100" />
  <button onclick="addTMPLStakeAdmin()">Add TMPL Stake</button>

  <div id="adminDepositsContainer" style="margin-bottom: 20px;">
    <h4>üìù Pending Deposit Requests</h4>
    <table id="depositsTable">
      <thead>
        <tr>
          <th>User ID</th><th>Name</th><th>Amount</th><th>Currency</th><th>Status</th><th>Deposit Time</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="adminWithdrawalsContainer" style="margin-bottom: 20px;">
    <h4>üìù Pending Withdrawal Requests</h4>
    <table id="withdrawalsTable">
      <thead>
        <tr>
          <th>User ID</th><th>Name</th><th>Amount</th><th>Currency</th><th>UPI ID</th><th>Status</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="adminUsersContainer"></div>

  <h4>‚ûï Add Weekly Income</h4>
  <input type="text" id="incomeUserId" placeholder="User ID" />
  <input type="number" id="incomeAmt" placeholder="Amount" />
  <button onclick="addWeeklyIncome()">Add Income</button>

  <button onclick="logout()">üö™ Logout</button>
</div>

<div id="editUserModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h4>Edit User</h4>
      <span class="modal-close" onclick="closeEditModal()">&times;</span>
    </div>
    <input type="text" id="editUserId" placeholder="User ID" disabled />
    <input type="text" id="editName" placeholder="Full Name" />
    <input type="text" id="editMobile" placeholder="Mobile Number" />
    <input type="text" id="editWallet" placeholder="BEP20 USDT Wallet Address" />
    <input type="password" id="editPassword" placeholder="Password (leave blank to keep unchanged)" />
    <input type="text" id="editRef" placeholder="Referral ID" />
    <select id="editStatus">
      <option value="Pending">Pending</option>
      <option value="Active">Active</option>
      <option value="Rejected">Rejected</option>
      <option value="Closed">Closed</option>
    </select>
    <input type="number" id="editDeposit" placeholder="Deposit" min="0" step="any" />
    <input type="number" id="editIncome" placeholder="Income" min="0" step="any" />
    <input type="number" id="editWalletBalance" placeholder="Wallet Balance" min="0" step="any" />
    <input type="text" id="editDepositTime" placeholder="Deposit Time (ISO format)" />
    <button onclick="saveUserChanges()">Save Changes</button>
  </div>
</div>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCBXuE2NHuZkKeQY7JjYM5vpbF1-K9AcS8",
    authDomain: "ashirwadmart-6d657.firebaseapp.com",
    databaseURL: "https://ashirwadmart-6d657-default-rtdb.firebaseio.com",
    projectId: "ashirwadmart-6d657",
    storageBucket: "ashirwadmart-6d657.appspot.com",
    messagingSenderId: "1013585797321",
    appId: "1:1013585797321:web:8a5c5fdb50c6aa7e7e57aa"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentId = "";
  let profitChartInstance = null;

  // Margins on exchange rates internally for deposit and withdrawal
  let usdtToINRBuy = null;   
  let usdtToINRSell = null;  

  async function loadExchangeRates() {
    try {
      const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=tether&vs_currencies=inr');
      const data = await response.json();
      const baseRate = data.tether.inr;
      if (baseRate) {
        usdtToINRBuy = baseRate * 1.07;
        usdtToINRSell = baseRate * 0.98;

        document.getElementById('usdtToInrBuyRate').innerText = usdtToINRBuy.toFixed(2);
        document.getElementById('usdtToInrSellRate').innerText = usdtToINRSell.toFixed(2);

        if (currentId && currentId !== "Admin") {
          db.ref('users/' + currentId).once('value').then(snap => {
            const data = snap.val();
            if (data) {
              const walletUSDT = parseFloat(data.walletBalance || 0);
              const walletINR = walletUSDT * usdtToINRSell;
              document.getElementById('walletBalanceINR').innerText = walletINR.toFixed(2);
              const userUPI = data.upiId || "";
              document.getElementById("userUPI").value = userUPI;
            }
          });
        }
        updateINRDepositAmount();
      }
    } catch (e) {
      console.error(e);
      document.getElementById('usdtToInrBuyRate').innerText = 'Error';
      document.getElementById('usdtToInrSellRate').innerText = 'Error';
    }
  }
  loadExchangeRates();
  setInterval(loadExchangeRates, 60000);

  function show(ele) { ele.classList.remove('hidden'); }
  function hide(ele) { ele.classList.add('hidden'); }

  function showRegister() {
    hide(document.getElementById('loginBox'));
    show(document.getElementById('registerBox'));
    hide(document.getElementById('forgotBox'));
  }
  function showForgot() {
    hide(document.getElementById('loginBox'));
    hide(document.getElementById('registerBox'));
    show(document.getElementById('forgotBox'));
  }
  function backToLogin() {
    hide(document.getElementById('forgotBox'));
    hide(document.getElementById('registerBox'));
    show(document.getElementById('loginBox'));
  }

  function login() {
    const id = document.getElementById('loginId').value.trim();
    const pass = document.getElementById('loginPass').value;
    if (!id) return alert("Please enter your ID");
    if (!pass) return alert("Please enter your password");

    if (id === "Admin" && pass === "Jaihanuman@7") {
      currentId = "Admin";
      hide(document.getElementById("loginBox"));
      show(document.getElementById("adminPanel"));
      loadAdmin();
      return;
    }
    db.ref("users/" + id).once("value", snap => {
      if (snap.exists()) {
        const data = snap.val();
        if (data.password !== pass) return alert("Incorrect password");
        currentId = id;
        loadUser(id);
        hide(document.getElementById("loginBox"));
        show(document.getElementById("userDashboard"));
      } else {
        alert("User ID not found.");
      }
    });
  }

  function register() {
    const name = document.getElementById("regName").value.trim();
    const mobile = document.getElementById("regMobile").value.trim();
    const wallet = document.getElementById("regWallet").value.trim();
    const ref = document.getElementById("regRef").value.trim();
    const password = document.getElementById("regPassword").value.trim();

    if (!name || !mobile || !wallet || !password) {
      return alert("Please fill all required fields");
    }
    const id = "U" + Math.floor(Math.random() * 100000);

    const userData = {
      name, mobile, wallet, deposit: 0, income: 0, status: "Pending", referredBy: ref || "", password,
      walletBalance: 0, depositTime: null, upiId: ""
    };
    db.ref("users/" + id).set(userData).then(() => {
      alert(`Registered! Your ID: ${id}`);
      location.reload();
    }).catch(err => alert("Error during registration: " + err.message));
  }
function loadUser(id) {
    db.ref("users/" + id).on("value", snap => {
      if (!snap.exists()) {
        alert("User data not found");
        logout();
        return;
      }
      const data = snap.val();

      const deposit = parseFloat(data.deposit || 0);
      const income = parseFloat(data.income || 0);
      const cap = deposit * 2;
      const remaining = Math.max(0, cap - income);
      const balance = parseFloat(data.walletBalance || 0);
      const depositTimeStr = data.depositTime ? new Date(data.depositTime).toLocaleString() : "N/A";

      document.getElementById("userName").innerText = data.name;
      document.getElementById("userWallet").innerText = data.wallet;
      document.getElementById("userDeposit").innerText = deposit.toFixed(2);
      document.getElementById("userDepositTime").innerText = depositTimeStr;
      document.getElementById("userIncome").innerText = income.toFixed(2);
      document.getElementById("userStatus").innerText = data.status;
      document.getElementById("userWithdrawWallet").innerText = data.wallet;
      document.getElementById("userTarget").innerText = cap.toFixed(2);
      document.getElementById("userRemaining").innerText = remaining.toFixed(2);
      document.getElementById("walletBalance").innerText = balance.toFixed(2);

      document.getElementById("userWalletAddress").innerText = data.wallet || "(No wallet address)";

      const upiValue = data.upiId || "";
      document.getElementById("userUPI").value = upiValue;
      if (upiValue.trim()) {
        document.getElementById("saveUPIButton").style.display = "none";
      } else {
        document.getElementById("saveUPIButton").style.display = "inline-block";
      }

      if (usdtToINRSell) {
        const walletINR = balance * usdtToINRSell;
        document.getElementById('walletBalanceINR').innerText = walletINR.toFixed(2);
      }

      if (deposit > 0 && income >= cap && data.status !== "Closed") {
        db.ref("users/" + id).update({
          income: 0,
          deposit: 0,
          status: "Closed",
          depositTime: null
        });
        alert("üéâ Congratulations! Your agreement has completed 2x and is now closed.");
      }

      loadProfitChart(deposit, income);
      loadTMPLStakingData(id);
    });
  }

  function updateDepositUI() {
    const currency = document.querySelector('input[name="depositCurrency"]:checked').value;
    if (currency === "USDT") {
      show(document.getElementById("depositUSDTDiv"));
      hide(document.getElementById("depositINRDiv"));
    } else {
      hide(document.getElementById("depositUSDTDiv"));
      show(document.getElementById("depositINRDiv"));
      updateINRDepositAmount();
    }
  }

  function updateINRDepositAmount() {
    const usdtAmt = parseFloat(document.getElementById("depINRUSDTAmount").value);
    if (isNaN(usdtAmt) || usdtAmt < 100 || usdtAmt > 1000 || !usdtToINRBuy) {
      document.getElementById("depINRAmount").innerText = "0";
      return;
    }
    const inrAmt = usdtAmt * usdtToINRBuy;
    document.getElementById("depINRAmount").innerText = inrAmt.toFixed(2);
  }

  // Referral income percentages for levels
  const REF_LEVELS = [0.05, 0.03, 0.02]; // 5%, 3%, 2%

  function addReferralIncome(depositAmount, userId) {
    let currentUserId = userId;
    let level = 0;

    function updateUserIncome(userId, incomeToAdd) {
      return db.ref("users/" + userId).transaction(userData => {
        if (userData) {
          userData.income = (parseFloat(userData.income) || 0) + incomeToAdd;
          userData.walletBalance = (parseFloat(userData.walletBalance) || 0) + incomeToAdd;
        }
        return userData;
      });
    }

    (async () => {
      while (level < 3 && currentUserId) {
        const userSnap = await db.ref("users/" + currentUserId).once("value");
        if (!userSnap.exists()) break;
        const user = userSnap.val();
        const referrerId = user.referredBy;
        if (!referrerId) break;

        const referralIncome = depositAmount * REF_LEVELS[level];
        if (referralIncome > 0) {
          await updateUserIncome(referrerId, referralIncome);
        }

        currentUserId = referrerId;
        level++;
      }
    })();
  }

  function submitDeposit() {
    const amt = parseFloat(document.getElementById("depAmount").value);
    if (isNaN(amt) || amt < 100 || amt > 1000) {
      return alert("Deposit amount must be between 100 and 1000 USDT");
    }
    db.ref("users/" + currentId).once("value").then(snap => {
      if (!snap.exists()) return alert("User data not found");

      const data = snap.val();
      if (data.status === "Active") return alert("Deposit is locked until agreement is closed.");

      const nowISOString = new Date().toISOString();

      db.ref("users/" + currentId).update({
        deposit: amt,
        status: "Pending",
        depositTime: nowISOString,
        depositCurrency: "USDT",
        depositINRAmount: null
      }).then(() => {
        alert("Deposit submitted! Waiting for admin approval.");
        document.getElementById("depAmount").value = "";
        loadUser(currentId);
      }).catch(err => alert("Error submitting deposit: " + err.message));
    });
  }

  function submitDepositINR() {
    const usdtAmt = parseFloat(document.getElementById("depINRUSDTAmount").value);
    if (isNaN(usdtAmt) || usdtAmt < 100 || usdtAmt > 1000) {
      return alert("USDT amount must be between 100 and 1000");
    }
    if (!usdtToINRBuy) {
      return alert("Exchange rate not loaded yet. Please wait.");
    }
    const inrAmt = usdtAmt * usdtToINRBuy;
    const nowISOString = new Date().toISOString();

    db.ref("users/" + currentId).once("value").then(snap => {
      if (!snap.exists()) return alert("User data not found");

      const data = snap.val();
      if (data.status === "Active") return alert("Deposit is locked until agreement is closed.");

      db.ref("depositINRRequests/" + currentId).set({
        usdtAmount: usdtAmt,
        inrAmount: inrAmt,
        status: "Pending",
        depositTime: nowISOString,
        upiId: "ashutoshkarmkar7-1@oksbi"
      }).then(() => {
        alert(`INR deposit request submitted for approx ‚Çπ${inrAmt.toFixed(2)}. Please pay via UPI to ashutoshkarmkar7-1@oksbi.
After payment, wait for admin approval.`);
        document.getElementById("depINRUSDTAmount").value = "";
        document.getElementById("depINRAmount").innerText = "0";
      }).catch(err => alert("Error submitting INR deposit: " + err.message));
    });
  }

  // üî• TMPL FUNCTIONS
  const TMPL_MONTHLY_RATE = 0.05;

  function loadTMPLStakingData(userId) {
    db.ref("tmplStakes/" + userId).once("value").then(snap => {
      const data = snap.val();
      if (data) {
        const staked = parseFloat(data.amount || 0);
        document.getElementById("tmplStaked").innerText = staked.toFixed(2);
        document.getElementById("nextRewardDate").innerText = new Date((data.lastRewardDate || Date.now()) + 30*24*60*60*1000).toLocaleDateString();
        document.getElementById("monthlyReward").innerText = (staked * TMPL_MONTHLY_RATE).toFixed(2);
      } else {
        document.getElementById("tmplStaked").innerText = "0";
        document.getElementById("nextRewardDate").innerText = "N/A";
        document.getElementById("monthlyReward").innerText = "0";
      }
    });
  }

  function submitTMPLStake() {
    const amt = parseFloat(document.getElementById("tmplStakeAmount").value);
    if (isNaN(amt) || amt < 100) return alert("Min 100 TMPL");
    db.ref("tmplStakesPending/" + currentId).set({amount: amt, status: "Pending", timestamp: Date.now()}).then(() => {
      alert("Stake submitted!");
      document.getElementById("tmplStakeAmount").value = "";
    });
  }

  function requestTMPLWithdraw() {
    db.ref("tmplStakes/" + currentId).once("value").then(snap => {
      const data = snap.val();
      if (!data || parseFloat(data.amount || 0) <= 0) return alert("No stake");
      db.ref("tmplWithdrawalsPending/" + currentId).push({amount: data.amount, status: "Pending", timestamp: Date.now()}).then(() => {
        db.ref("tmplStakes/" + currentId).remove();
        alert("Withdrawal requested!");
      });
    });
  }
