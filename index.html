<!DOCTYPE html>
<html>
<head>
  <title>Ashirwad Mart</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial; padding: 10px; background: #f2f2f2; }
    .box { background: white; padding: 15px; margin: 10px 0; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    input, button, select { width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; }
    button { background: #007bff; color: white; border: none; }
    .hidden { display: none; }
    .btn-red { background: red; }
    .btn-green { background: green; }
  </style>
</head>
<body>

<div class="box" id="authBox">
  <h3>ğŸš€ Ashirwad Mart</h3>
  <input id="name" placeholder="Full Name" />
  <input id="mobile" placeholder="Mobile Number" />
  <input id="wallet" placeholder="BEP20 Wallet Address" />
  <input id="referral" placeholder="Referral ID (optional)" />
  <button onclick="register()">Register</button>
  <hr />
  <input id="loginMobile" placeholder="Mobile Number" />
  <button onclick="login()">Login</button>
</div>

<div class="box hidden" id="userPanel">
  <h3>ğŸ‘‹ Welcome, <span id="userName"></span></h3>
  <p>Wallet: <span id="userWallet"></span></p>
  <p>Deposit: $<span id="userDeposit">0</span> | Income: $<span id="userIncome">0</span> | Referral: $<span id="userReferral">0</span></p>
  <p>Status: <span id="agreementStatus"></span></p>

  <h4>ğŸ’¸ Make a Deposit</h4>
  <p>Send USDT to: <b>0x49F7A836A32C1aCF04d4d20Fa87A14C7a19aB74B</b></p>
  <input id="depositAmt" type="number" placeholder="Enter amount (50â€“500)" />
  <button onclick="submitDeposit()">Submit Deposit</button>

  <h4>ğŸ’° Request Withdrawal</h4>
  <input id="withdrawAmt" type="number" placeholder="Min $1" />
  <button onclick="requestWithdraw()">Withdraw</button>

  <h4>ğŸ“œ Deposit History</h4>
  <ul id="depositHistory"></ul>

  <h4>ğŸ“¤ Withdrawal History</h4>
  <ul id="withdrawHistory"></ul>

  <h4>ğŸ‘¥ Your Team</h4>
  <ul id="teamList"></ul>

  <button onclick="logout()">Logout</button>
</div>

<div class="box hidden" id="adminLogin">
  <h3>ğŸ› ï¸ Admin Login</h3>
  <input id="adminId" placeholder="Admin ID" />
  <input id="adminPass" placeholder="Password" type="password" />
  <button onclick="adminLogin()">Login</button>
</div>

<div class="box hidden" id="adminPanel">
  <h3>ğŸ”§ Admin Panel</h3>
  <div id="adminUsers"></div>
  <h4>Add Weekly Income</h4>
  <input id="incomeUserId" placeholder="User ID" />
  <input id="incomeAmt" placeholder="Amount" type="number" />
  <button onclick="addWeeklyIncome()">Add Income</button>
  <button onclick="logout()">Logout</button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDmj9Pp0opI0eAYNE9bwU6L_MNphfwO9Ag",
    authDomain: "ashirwadmart-6d657.firebaseapp.com",
    databaseURL: "https://ashirwadmart-6d657-default-rtdb.firebaseio.com",
    projectId: "ashirwadmart-6d657",
    storageBucket: "ashirwadmart-6d657.appspot.com",
    messagingSenderId: "718751531728",
    appId: "1:718751531728:web:40d147fa2ddadd508a6837"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentUser = null;

  function register() {
    const name = name.value;
    const mobile = mobile.value;
    const wallet = wallet.value;
    const ref = referral.value || "";
    if (!name || !mobile || !wallet) return alert("All fields required");
    const id = "ID" + Date.now();
    db.ref("users/" + mobile).set({ id, name, mobile, wallet, deposit: 0, income: 0, referral: 0, status: "pending", refby: ref });
    if (ref) {
      db.ref("users").orderByChild("id").equalTo(ref).once("value", snap => {
        if (snap.exists()) {
          const refKey = Object.keys(snap.val())[0];
          db.ref("users/" + refKey).once("value", ss => {
            const r = ss.val();
            db.ref("users/" + refKey).update({ referral: (r.referral || 0) + 5 });
          });
        }
      });
    }
    alert("Registered successfully");
  }

  function login() {
    const mob = loginMobile.value;
    db.ref("users/" + mob).once("value", snap => {
      if (snap.exists()) {
        currentUser = mob;
        showUserPanel(snap.val());
      } else {
        alert("User not found");
      }
    });
  }

  function showUserPanel(data) {
    authBox.classList.add("hidden");
    userPanel.classList.remove("hidden");
    userName.innerText = data.name;
    userWallet.innerText = data.wallet;
    userDeposit.innerText = data.deposit || 0;
    userIncome.innerText = data.income || 0;
    userReferral.innerText = data.referral || 0;
    agreementStatus.innerText = data.status;
    loadHistory();
    loadTeam(data.id);
  }

  function logout() {
    location.reload();
  }

  function submitDeposit() {
    const amt = Number(depositAmt.value);
    if (amt < 50 || amt > 500) return alert("Amount must be 50â€“500");
    db.ref("deposits/" + currentUser).push({ amount: amt, status: "pending", date: Date.now() });
    alert("Deposit submitted");
  }

  function requestWithdraw() {
    const amt = Number(withdrawAmt.value);
    db.ref("users/" + currentUser).once("value", s => {
      const u = s.val();
      if ((u.income + u.referral) < amt || amt < 1) return alert("Insufficient balance");
      db.ref("withdrawals/" + currentUser).push({ amount: amt, status: "pending", date: Date.now() });
      alert("Requested");
    });
  }

  function loadHistory() {
    depositHistory.innerHTML = "";
    withdrawHistory.innerHTML = "";
    db.ref("deposits/" + currentUser).once("value", s => {
      s.forEach(d => {
        const v = d.val();
        depositHistory.innerHTML += `<li>$${v.amount} - ${v.status}</li>`;
      });
    });
    db.ref("withdrawals/" + currentUser).once("value", s => {
      s.forEach(w => {
        const v = w.val();
        withdrawHistory.innerHTML += `<li>$${v.amount} - ${v.status}</li>`;
      });
    });
  }

  function loadTeam(myId) {
    teamList.innerHTML = "";
    db.ref("users").orderByChild("refby").equalTo(myId).once("value", snap => {
      snap.forEach(s => {
        const u = s.val();
        teamList.innerHTML += `<li>${u.name} - ${u.mobile}</li>`;
      });
    });
  }

  function adminLogin() {
    if (adminId.value === "Admin" && adminPass.value === "Jaihanuman@7") {
      adminLogin.classList.add("hidden");
      adminPanel.classList.remove("hidden");
      loadAdminUsers();
    } else alert("Invalid credentials");
  }

  function loadAdminUsers() {
    db.ref("users").once("value", s => {
      adminUsers.innerHTML = "";
      s.forEach(u => {
        const d = u.val();
        adminUsers.innerHTML += `
          <div class="box">
            <b>${d.name}</b> (${d.mobile})<br/>
            Deposit: ${d.deposit} | Income: ${d.income} | Referral: ${d.referral}<br/>
            Status: ${d.status}<br/>
            <button class="btn-green" onclick="approveDeposit('${u.key}')">Approve Deposit</button>
            <button class="btn-red" onclick="rejectDeposit('${u.key}')">Reject</button>
            <button onclick="closeAgreement('${u.key}')">Close Agreement</button>
          </div>`;
      });
    });
  }

  function approveDeposit(uid) {
    db.ref("deposits/" + uid).once("value", s => {
      let total = 0, lastKey = "";
      s.forEach(d => {
        if (d.val().status === "pending") {
          total = d.val().amount;
          lastKey = d.key;
        }
      });
      if (!lastKey) return alert("No pending deposit");
      db.ref("users/" + uid).once("value", u => {
        const d = u.val();
        db.ref("users/" + uid).update({ deposit: (d.deposit || 0) + total, status: "active" });
        db.ref("deposits/" + uid + "/" + lastKey).update({ status: "approved" });
        alert("Approved");
        loadAdminUsers();
      });
    });
  }

  function rejectDeposit(uid) {
    db.ref("deposits/" + uid).once("value", s => {
      s.forEach(d => {
        if (d.val().status === "pending") {
          db.ref("deposits/" + uid + "/" + d.key).update({ status: "rejected" });
        }
      });
      alert("Rejected");
      loadAdminUsers();
    });
  }

  function addWeeklyIncome() {
    const uid = incomeUserId.value;
    const amt = Number(incomeAmt.value);
    db.ref("users/" + uid).once("value", u => {
      const d = u.val();
      const maxIncome = d.deposit * 2;
      if ((d.income + amt) > maxIncome) return alert("Limit exceeded");
      db.ref("users/" + uid).update({ income: d.income + amt });
      alert("Income added");
    });
  }

  function closeAgreement(uid) {
    db.ref("users/" + uid).update({ status: "closed", deposit: 0, income: 0, referral: 0 });
    alert("Agreement closed");
    loadAdminUsers();
  }
</script>
</body>
  </html>
