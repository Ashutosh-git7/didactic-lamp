<!DOCTYPE html>
<html>
<head>
  <title>üöÄ Ashirwad Mart P - Founder Registration (FIXED & IMPROVED)</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- FIXED jsPDF - Multiple CDNs for reliability -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #121212 0%, #1a1a2e 50%, #16213e 100%);
      color: #e0e0e0;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h2 { color: #00ffe1; text-align: center; margin: 20px 0; font-size: 28px; text-shadow: 0 0 20px rgba(0,255,225,0.5); }
    .box {
      background: rgba(30, 30, 30, 0.95);
      padding: 30px;
      margin: 20px 0;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 255, 225, 0.2);
      width: 100%;
      max-width: 500px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 255, 225, 0.1);
    }
    input, select, textarea {
      padding: 15px;
      margin: 12px 0;
      width: 100%;
      border-radius: 10px;
      border: 1px solid #333;
      font-size: 16px;
      background: rgba(42, 42, 42, 0.8);
      color: #fff;
      transition: all 0.3s ease;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #00ffe1;
      background: rgba(57, 57, 57, 0.9);
      box-shadow: 0 0 15px rgba(0, 255, 225, 0.3);
    }
    button {
      padding: 15px 25px;
      margin: 10px 5px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }
    .btn-primary {
      background: linear-gradient(45deg, #00ffe1, #00c7aa);
      color: #000;
    }
    .btn-primary:hover { background: linear-gradient(45deg, #00c7aa, #00ffe1); transform: translateY(-2px); }
    .btn-success { background: linear-gradient(45deg, #28a745, #20c997); color: white; }
    .btn-success:hover { background: linear-gradient(45deg, #20c997, #28a745); }
    .btn-danger { background: linear-gradient(45deg, #dc3545, #c82333); color: white; }
    .btn-danger:hover { background: linear-gradient(45deg, #c82333, #dc3545); }
    .btn-warning { background: linear-gradient(45deg, #ffc107, #e0a800); color: #000; }
    .btn-warning:hover { background: linear-gradient(45deg, #e0a800, #ffc107); }
    .payment-info {
      background: rgba(40, 167, 69, 0.2);
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid #28a745;
      margin: 20px 0;
    }
    .code-display {
      background: linear-gradient(45deg, #00ffe1, #00c7aa);
      color: #000;
      font-size: 24px;
      font-weight: 700;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      margin: 20px 0;
      letter-spacing: 3px;
      animation: pulse 2s infinite;
    }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .status-pending { color: #ffc107; font-weight: bold; }
    .status-approved { color: #28a745; font-weight: bold; }
    .status-rejected { color: #dc3545; font-weight: bold; }
    .admin-login-box { background: rgba(220, 53, 69, 0.15); border: 2px solid #dc3545; }
    .hidden { display: none !important; }
    .certificate-box { border: 2px solid #28a745; background: rgba(40, 167, 69, 0.15); }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.8);
    }
    .modal-content {
      background: rgba(30, 30, 30, 0.95);
      margin: 5% auto;
      padding: 30px;
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid rgba(0, 255, 225, 0.3);
    }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { color: #00ffe1; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
    .stat-card {
      background: rgba(0, 255, 225, 0.1);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid rgba(0, 255, 225, 0.3);
    }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #333; }
    th { background: linear-gradient(45deg, #00ffe1, #00c7aa); color: #000; font-weight: bold; }
    .action-btn { padding: 5px 10px; margin: 2px; font-size: 12px; width: auto; }
    @media (max-width: 640px) {
      .box { padding: 20px 15px; margin: 10px 0; }
      h2 { font-size: 24px; }
      .modal-content { margin: 10% auto; width: 95%; }
      .stats-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <h2>üöÄ Ashirwad Mart P - Founder Registration</h2>

  <!-- Founder Registration Form -->
  <div id="registerBox" class="box">
    <h3>üëë Founder Registration (‚Çπ150)</h3>
    <p><strong>Product:</strong> 3 Sanitary Pads + Founder Certificate</p>
    
    <div class="payment-info">
      <h4>üí∞ Payment Details</h4>
      <p><strong>UPI ID:</strong> <code>ashutoshkarmkar7-1@oksbi</code></p>
      <p><strong>Amount:</strong> <strong>‚Çπ150</strong></p>
      <p><em>Payment ‡§ï‡•á ‡§¨‡§æ‡§¶ UPI Transaction ID enter ‡§ï‡§∞‡•á‡§Ç</em></p>
    </div>

    <input type="text" id="founderName" placeholder="Full Name *" required />
    <input type="tel" id="founderMobile" placeholder="Mobile Number (10 digits) *" required />
    <input type="email" id="founderEmail" placeholder="Email (optional)" />
    <input type="text" id="founderAddress" placeholder="Complete Address *" required />
    <input type="text" id="paymentRef" placeholder="UPI Transaction ID *" required />
    <input type="text" id="paymentScreenshot" placeholder="Payment Screenshot URL (optional)" />
    
    <select id="productReceived">
      <option value="No">Product Received? No</option>
      <option value="Yes">Product Received? Yes</option>
    </select>
    
    <button class="btn-primary" onclick="registerFounder()">üìù Register Founder</button>
    <div id="codeDisplay" class="code-display hidden"></div>
  </div>

  <!-- Certificate Download -->
  <div id="certificateBox" class="box certificate-box">
    <h3>üìú Founder Certificate Download</h3>
    <p><strong>‚úÖ Admin approval ‡§ï‡•á ‡§¨‡§æ‡§¶ PDF download ‡§ï‡§∞‡•á‡§Ç</strong></p>
    <input type="tel" id="certMobile" placeholder="Registered Mobile Number *" required />
    <input type="text" id="certCode" placeholder="Founder Code (FXXXXXXX) *" required />
    <button class="btn-success" onclick="downloadCertificate()">üéì Download Certificate PDF</button>
  </div>

  <!-- Admin Login -->
  <div id="adminLoginBox" class="box admin-login-box">
    <h3>üîê Admin Login</h3>
    <div style="text-align: center; color: #ffc107;">
      <p><strong>Password Protected</strong></p>
    </div>
    <input type="password" id="adminPasswordInput" placeholder="Enter Admin Password" />
    <button class="btn-success" onclick="adminSignIn()">Login to Admin Panel</button>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="box hidden" style="max-width: 1200px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
      <h3>üõ†Ô∏è Admin Dashboard - Founder Management</h3>
      <div>
        <button class="btn-success action-btn" onclick="refreshFounders()">üîÑ Refresh</button>
        <button class="btn-danger action-btn" onclick="adminLogout()">üö™ Logout</button>
      </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="stats-grid" id="statsCards">
      <div class="stat-card">
        <h4 id="totalPending">0</h4>
        <p>Pending</p>
      </div>
      <div class="stat-card">
        <h4 id="totalApproved" style="color: #28a745;">0</h4>
        <p>Approved</p>
      </div>
      <div class="stat-card">
        <h4 id="totalRejected" style="color: #dc3545;">0</h4>
        <p>Rejected</p>
      </div>
      <div class="stat-card">
        <h4 id="totalFounders">0</h4>
        <p>Total</p>
      </div>
    </div>
    
    <div id="foundersList"></div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeEditModal()">&times;</span>
      <h3>‚úèÔ∏è Edit Founder Details</h3>
      <input type="text" id="editName" placeholder="Full Name" />
      <input type="tel" id="editMobile" placeholder="Mobile Number" />
      <input type="email" id="editEmail" placeholder="Email" />
      <input type="text" id="editAddress" placeholder="Address" />
      <input type="text" id="editPaymentRef" placeholder="Payment Reference" />
      <select id="editProductReceived">
        <option value="No">Product Received? No</option>
        <option value="Yes">Product Received? Yes</option>
      </select>
      <select id="editStatus">
        <option value="Pending">Pending</option>
        <option value="Approved">Approved</option>
        <option value="Rejected">Rejected</option>
      </select>
      <div style="display: flex; gap: 10px;">
        <button class="btn-primary" onclick="saveEdit()" style="flex: 1;">üíæ Save Changes</button>
        <button class="btn-danger" onclick="deleteFounder()" style="flex: 1;">üóëÔ∏è Delete</button>
      </div>
    </div>
  </div>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyCBXuE2NHuZkKeQY7JjYM5vpbF1-K9AcS8",
    authDomain: "ashirwadmart-6d657.firebaseapp.com",
    databaseURL: "https://ashirwadmart-6d657-default-rtdb.firebaseio.com",
    projectId: "ashirwadmart-6d657",
    storageBucket: "ashirwadmart-6d657.appspot.com",
    messagingSenderId: "1013585797321",
    appId: "1:1013585797321:web:8a5c5fdb50c6aa7e7e57aa"
  };
  
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();

  let isAdminLoggedIn = false;
  let editingKey = null;

  // FIXED: Robust Founder Code Generation
  async function generateUniqueFounderCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    for (let attempt = 0; attempt < 20; attempt++) {
      let code = 'F';
      for (let i = 0; i < 7; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      
      const snapshot = await db.ref('founders').orderByChild('code').equalTo(code).once('value');
      if (!snapshot.exists()) {
        return code;
      }
    }
    // Fallback: Timestamp-based
    return 'F' + Date.now().toString(36).toUpperCase().substring(0, 7);
  }

  // Founder Registration - FIXED Validation
  async function registerFounder() {
    const name = document.getElementById('founderName').value.trim();
    const mobile = document.getElementById('founderMobile').value.trim();
    const email = document.getElementById('founderEmail').value.trim();
    const address = document.getElementById('founderAddress').value.trim();
    const paymentRef = document.getElementById('paymentRef').value.trim();
    const screenshot = document.getElementById('paymentScreenshot').value.trim();
    const productReceived = document.getElementById('productReceived').value;

    // Strict Validation
    if (!name || !mobile || !address || !paymentRef) {
      return alert('‚ùå ‡§∏‡§≠‡•Ä required fields (*) ‡§≠‡§∞‡•á‡§Ç!');
    }
    if (mobile.length !== 10 || !/^d{10}$/.test(mobile)) {
      return alert('‚ùå Valid 10-digit mobile number enter ‡§ï‡§∞‡•á‡§Ç!');
    }
    if (name.length < 2) {
      return alert('‚ùå Name ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ 2 characters ‡§ï‡§æ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è!');
    }

    try {
      // Show loading
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = '‚è≥ Registering...';
      btn.disabled = true;

      const founderCode = await generateUniqueFounderCode();
      
      const founderData = {
        name, mobile, email: email || '', address, paymentRef, screenshot,
        productReceived, code: founderCode, status: 'Pending',
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        paymentAmount: 150,
        registrationIP: '' // Add later if needed
      };

      await db.ref('founders').push(founderData);
      
      // Success UI
      showFounderCode(founderCode);
      alert(`‚úÖ Founder Registered Successfully!

Your Unique Founder Code: ${founderCode}

‡§á‡§∏‡•á safe ‡§∞‡§ñ‡•á‡§Ç‡•§ Admin approval ‡§ï‡§æ wait ‡§ï‡§∞‡•á‡§Ç‡•§`);
      
      // Clear form
      document.querySelectorAll('#registerBox input, #registerBox select').forEach(el => el.value = '');
      
    } catch (err) {
      console.error('Registration error:', err);
      alert('‚ùå Registration failed: ' + err.message);
    } finally {
      // Reset button
      const btn = event.target;
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  }

  function showFounderCode(code) {
    const display = document.getElementById('codeDisplay');
    display.textContent = `üéâ Your Founder Code: ${code} üéâ`;
    display.classList.remove('hidden');
  }

  // FIXED Certificate Download - Multiple jsPDF fallbacks
  async function downloadCertificate() {
    const mobile = document.getElementById('certMobile').value.trim();
    const code = document.getElementById('certCode').value.trim().toUpperCase();

    if (!mobile || !code) return alert('‚ùå Mobile number ‡§î‡§∞ Founder Code ‡§¶‡•ã‡§®‡•ã‡§Ç enter ‡§ï‡§∞‡•á‡§Ç!');
    if (mobile.length !== 10 || !/^d{10}$/.test(mobile)) {
      return alert('‚ùå Valid 10-digit mobile number enter ‡§ï‡§∞‡•á‡§Ç!');
    }
    if (!code.startsWith('F') || code.length !== 8) {
      return alert('‚ùå Founder Code FXXXXXXX format ‡§Æ‡•á‡§Ç ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è!');
    }

    try {
      // Search by mobile first
      const mobileSnap = await db.ref('founders')
        .orderByChild('mobile').equalTo(mobile).once('value');

      if (!mobileSnap.exists()) {
        return alert('‚ùå ‡§á‡§∏ mobile number ‡§∏‡•á ‡§ï‡•ã‡§à registration ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!');
      }

      let matchedFounder = null;
      mobileSnap.forEach(child => {
        const data = child.val();
        if (data.code && data.code.toUpperCase() === code) {
          matchedFounder = data;
          editingKey = child.key;
          return true;
        }
      });

      if (!matchedFounder) {
        return alert('‚ùå Founder Code ‡§ó‡§≤‡§§ ‡§π‡•à ‡§Ø‡§æ match ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∞‡§π‡§æ!');
      }

      if (matchedFounder.status !== 'Approved') {
        return alert(`‚è≥ Status: "${matchedFounder.status}"
Admin ‡§∏‡•á approval ‡§ï‡§æ wait ‡§ï‡§∞‡•á‡§Ç!`);
      }

      // FIXED PDF Generation with fallbacks
      if (typeof window.jspdf === 'undefined') {
        alert('‚ùå PDF library load ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§™‡§æ‡§à‡•§ Page refresh ‡§ï‡§∞‡§ï‡•á try ‡§ï‡§∞‡•á‡§Ç‡•§');
        return;
      }

      generateCertificatePDF(matchedFounder);
      
      // Clear fields
      document.getElementById('certMobile').value = '';
      document.getElementById('certCode').value = '';
      
    } catch (err) {
      console.error('Certificate error:', err);
      alert('‚ùå Error: ' + err.message);
    }
  }

  // FIXED PDF Generation
  function generateCertificatePDF(founder) {
    try {
      // Try multiple jsPDF instances
      let jsPDF;
      if (window.jspdf && window.jspdf.jsPDF) {
        jsPDF = window.jspdf.jsPDF;
      } else if (window['jspdf']) {
        jsPDF = window['jspdf'].jsPDF;
      } else {
        throw new Error('jsPDF not available');
      }

      const doc = new jsPDF('landscape', 'pt', 'a4');
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();

      // Beautiful Certificate Design
      doc.setLineWidth(6);
      doc.setDrawColor(0, 255, 225);
      doc.rect(40, 40, pageWidth - 80, pageHeight - 80, 'S');

      // Header
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(36);
      doc.setTextColor(0, 255, 225);
      doc.text('ASHIRWAD MART P', pageWidth / 2, 120, { align: 'center' });

      doc.setFontSize(28);
      doc.setTextColor(255, 255, 255);
      doc.text('FOUNDER CERTIFICATE', pageWidth / 2, 170, { align: 'center' });

      // Main Content
      doc.setFontSize(18);
      doc.setTextColor(220, 220, 220);
      doc.text('This certifies that', pageWidth / 2, 220, { align: 'center' });

      // Founder Name - Largest & Boldest
      doc.setFontSize(40);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(0, 255, 225);
      doc.text(founder.name.toUpperCase(), pageWidth / 2, 270, { align: 'center' });

      // Details
      doc.setFontSize(20);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(255, 255, 255);
      doc.text('Founder Code:', pageWidth / 2, 330, { align: 'center' });
      doc.setFontSize(24);
      doc.text(founder.code, pageWidth / 2, 360, { align: 'center' });

      doc.setFontSize(16);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(200, 200, 200);
      doc.text(`Mobile: ${founder.mobile}`, pageWidth / 2, 400, { align: 'center' });
      
      const dateStr = founder.approvedAt ? 
        new Date(founder.approvedAt).toLocaleDateString('en-IN') : 
        new Date().toLocaleDateString('en-IN');
      doc.text(`Approval Date: ${dateStr}`, pageWidth / 2, 430, { align: 'center' });

      // Footer & Signature
      doc.setFontSize(14);
      doc.setDrawColor(0, 255, 225);
      doc.setLineWidth(2);
      doc.line(pageWidth - 250, pageHeight - 100, pageWidth - 50, pageHeight - 100);
      
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(255, 255, 255);
      doc.text('Authorised Signatory', pageWidth - 150, pageHeight - 80, { align: 'center' });
      doc.setFont('helvetica', 'normal');
      doc.text('Ashirwad Mart P', pageWidth - 150, pageHeight - 55, { align: 'center' });
      doc.setTextColor(150, 150, 150);
      doc.text('admin@ashirwadmart.com', pageWidth - 150, pageHeight - 35, { align: 'center' });

      // Save with proper filename
      const cleanName = founder.name.replace(/[^a-zA-Z0-9]/g, '').substring(0, 20);
      const fileName = `AshirwadMartP_Founder_${founder.code}_${cleanName}.pdf`;
      doc.save(fileName);

      alert('üéâ Certificate successfully downloaded!
' + fileName);
    } catch (pdfErr) {
      console.error('PDF Error:', pdfErr);
      alert('‚ùå PDF generation failed‡•§ Console check ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ page refresh ‡§ï‡§∞‡•á‡§Ç‡•§');
    }
  }

  // Admin Functions
  async function adminSignIn() {
    const password = document.getElementById('adminPasswordInput').value;
    if (!password) return alert('‚ùå Password enter ‡§ï‡§∞‡•á‡§Ç!');

    // Admin Password
    if (password === 'Jaihanuman@2025!') {
      isAdminLoggedIn = true;
      document.getElementById('adminLoginBox').classList.add('hidden');
      document.getElementById('adminPanel').classList.remove('hidden');
      document.getElementById('adminPasswordInput').value = '';
      loadFounders();
      alert('‚úÖ Admin Login Successful! üöÄ');
    } else {
      alert('‚ùå Wrong Password! Try again.');
      document.getElementById('adminPasswordInput').value = '';
      document.getElementById('adminPasswordInput').focus();
    }
  }

  function adminLogout() {
    isAdminLoggedIn = false;
    document.getElementById('adminPanel').classList.add('hidden');
    document.getElementById('adminLoginBox').classList.remove('hidden');
    document.getElementById('foundersList').innerHTML = '';
    document.getElementById('adminPasswordInput').focus();
  }

  // Edit Modal Functions
  function openEditModal(key, data) {
    if (!isAdminLoggedIn) return alert('‚ùå Admin login required!');
    
    editingKey = key;
    document.getElementById('editName').value = data.name || '';
    document.getElementById('editMobile').value = data.mobile || '';
    document.getElementById('editEmail').value = data.email || '';
    document.getElementById('editAddress').value = data.address || '';
    document.getElementById('editPaymentRef').value = data.paymentRef || '';
    document.getElementById('editProductReceived').value = data.productReceived || 'No';
    document.getElementById('editStatus').value = data.status || 'Pending';
    
    document.getElementById('editModal').style.display = 'block';
  }

  function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    editingKey = null;
  }

  async function saveEdit() {
    if (!editingKey || !isAdminLoggedIn) return alert('‚ùå Admin login required!');
    
    const updates = {
      name: document.getElementById('editName').value.trim(),
      mobile: document.getElementById('editMobile').value.trim(),
      email: document.getElementById('editEmail').value.trim(),
      address: document.getElementById('editAddress').value.trim(),
      paymentRef: document.getElementById('editPaymentRef').value.trim(),
      productReceived: document.getElementById('editProductReceived').value,
      status: document.getElementById('editStatus').value
    };

    if (updates.status === 'Approved') {
      updates.approvedAt = firebase.database.ServerValue.TIMESTAMP;
    }

    try {
      await db.ref('founders/' + editingKey).update(updates);
      alert('‚úÖ Changes saved successfully!');
      closeEditModal();
      loadFounders();
    } catch (err) {
      alert('‚ùå Update failed: ' + err.message);
    }
  }

  async function deleteFounder() {
    if (!editingKey || !isAdminLoggedIn) return;
    
    if (confirm('üóëÔ∏è Permanent delete? This cannot be undone!')) {
      try {
        await db.ref('founders/' + editingKey).remove();
        alert('‚úÖ Founder deleted successfully!');
        closeEditModal();
        loadFounders();
      } catch (err) {
        alert('‚ùå Delete failed: ' + err.message);
      }
    }
  }

  // Main Admin Dashboard - FIXED Real-time
  function loadFounders() {
    if (!isAdminLoggedIn) return;
    
    const foundersRef = db.ref('founders').orderByChild('timestamp');
    foundersRef.on('value', async (snapshot) => {
      let html = '<table><thead><tr>';
      html += '<th>Code</th><th>Name</th><th>Mobile</th><th>Payment Ref</th><th>Status</th><th>Date</th><th>Actions</th>';
      html += '</tr></thead><tbody>';

      let totalPending = 0, totalApproved = 0, totalRejected = 0, total = 0;

      const promises = [];
      snapshot.forEach((child) => {
        const data = child.val();
        const key = child.key;
        total++;
        
        const statusClass = data.status === 'Approved' ? 'status-approved' : 
                           data.status === 'Rejected' ? 'status-rejected' : 'status-pending';
        const date = data.timestamp ? 
          new Date(data.timestamp).toLocaleString('en-IN') : 'N/A';
        
        if (data.status === 'Pending') totalPending++;
        if (data.status === 'Approved') totalApproved++;
        if (data.status === 'Rejected') totalRejected++;

        html += `<tr>
          <td style="font-weight: bold; color: #00ffe1;">${data.code || 'N/A'}</td>
          <td>${data.name || 'N/A'}</td>
          <td>${data.mobile || 'N/A'}</td>
          <td style="font-size: 12px; max-width: 150px; word-break: break-all;">${data.paymentRef || 'N/A'}</td>
          <td><span class="${statusClass}">${data.status || 'Pending'}</span></td>
          <td style="font-size: 12px;">${date}</td>
          <td>
            <button class="btn-warning action-btn" onclick="openEditModal('${key}', ${JSON.stringify(data)})">‚úèÔ∏è</button>
            <button class="btn-success action-btn" onclick="quickUpdateStatus('${key}', 'Approved')">‚úÖ</button>
            <button class="btn-danger action-btn" onclick="quickUpdateStatus('${key}', 'Rejected')">‚ùå</button>
          </td>
        </tr>`;
      });

      html += '</tbody></table>';

      // Update Stats
      document.getElementById('totalPending').textContent = totalPending;
      document.getElementById('totalApproved').textContent = totalApproved;
      document.getElementById('totalRejected').textContent = totalRejected;
      document.getElementById('totalFounders').textContent = total;

      document.getElementById('foundersList').innerHTML = html;
    });
  }

  // Quick Status Update
  async function quickUpdateStatus(key, status) {
    if (!isAdminLoggedIn) return;
    
    if (confirm(`Status ‡§ï‡•ã "${status}" ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`)) {
      const updates = { status };
      if (status === 'Approved') {
        updates.approvedAt = firebase.database.ServerValue.TIMESTAMP;
      }
      
      try {
        await db.ref('founders/' + key).update(updates);
        alert('‚úÖ Status updated!');
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      }
    }
  }

  function refreshFounders() {
    if (isAdminLoggedIn) loadFounders();
  }

  // Event Listeners
  window.onclick = function(event) {
    const modal = document.getElementById('editModal');
    if (event.target === modal) closeEditModal();
  };

  document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      const active = document.activeElement;
      if (active.id === 'adminPasswordInput') {
        adminSignIn();
      }
    }
  });

  // Auto-focus
  window.onload = function() {
    document.getElementById('adminPasswordInput').focus();
    console.log('‚úÖ Ashirwad Mart P - All systems ready!');
    console.log('üìú jsPDF loaded:', typeof window.jspdf !== 'undefined');
  };
</script>
</body>
</html>
