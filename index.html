<!DOCTYPE html>
<html>
<head>
  <title>Ashirwad Mart</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; background: #0d1117; color: #e6edf3; }
    .card { background: #161b22; border-radius: 10px; padding: 15px; margin-bottom: 10px; }
    .btn { background: #238636; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; }
    .btn:disabled { background: gray; }
    input, select { padding: 8px; width: 100%; margin-bottom: 10px; border-radius: 5px; border: none; }
    h2 { color: #58a6ff; }
    .admin { background: #7d8590; }
  </style>
</head>
<body>
  <div id="app">
    <!-- Content dynamically injected here -->
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCz8QOqMBff9KQUY7raMGy05bIhZzhX0I0",
      authDomain: "ashirwadmart-6d657.firebaseapp.com",
      databaseURL: "https://ashirwadmart-6d657-default-rtdb.firebaseio.com",
      projectId: "ashirwadmart-6d657",
      storageBucket: "ashirwadmart-6d657.appspot.com",
      messagingSenderId: "829116350207",
      appId: "1:829116350207:web:ed216660f44cfe6656db62"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const appDiv = document.getElementById('app');
    let currentUser = null;

    function renderLogin() {
      appDiv.innerHTML = `
        <div class="card">
          <h2>Login</h2>
          <input type="text" id="loginId" placeholder="User ID or Admin" />
          <input type="password" id="loginPass" placeholder="Password (only for admin)" />
          <button class="btn" onclick="login()">Login</button>
          <p>New user? <a href="#" onclick="renderRegister()">Register here</a></p>
        </div>
      `;
    }

    function renderRegister() {
      appDiv.innerHTML = `
        <div class="card">
          <h2>Register</h2>
          <input type="text" id="regName" placeholder="Name" />
          <input type="text" id="regMobile" placeholder="Mobile Number" />
          <input type="text" id="regWallet" placeholder="Your USDT BEP20 Wallet Address" />
          <input type="text" id="regRef" placeholder="Referral ID (optional)" />
          <button class="btn" onclick="register()">Register</button>
        </div>
      `;
    }

    function register() {
      const name = document.getElementById('regName').value;
      const mobile = document.getElementById('regMobile').value;
      const wallet = document.getElementById('regWallet').value;
      const ref = document.getElementById('regRef').value.toLowerCase();
      if (!name || !mobile || !wallet) return alert("Fill all fields");

      const userId = 'id' + Math.random().toString(36).substring(2, 6);
      db.ref('users/' + userId).set({
        name, mobile, wallet, ref, deposit: 0, income: 0, totalIncome: 0,
        referralIncome: 0, withdraw: 0, status: "Active", history: [], withdrawHistory: []
      }, () => {
        alert("Registered! Your ID: " + userId);
        renderLogin();
      });
    }

    function login() {
      const id = document.getElementById('loginId').value.trim().toLowerCase();
      const pass = document.getElementById('loginPass').value;
      if (id === "admin" && pass === "Jaihanuman@7") return renderAdmin();
      db.ref('users/' + id).once('value', snap => {
        if (snap.exists()) {
          currentUser = { id, ...snap.val() };
          renderUser();
        } else {
          alert("User not found");
        }
      });
    }

    function renderUser() {
      const u = currentUser;
      appDiv.innerHTML = `
        <div class="card">
          <h2>Welcome, ${u.name}</h2>
          <p><b>ID:</b> ${currentUser.id}</p>
          <p><b>Status:</b> ${u.status}</p>
          <p><b>Deposit:</b> $${u.deposit}</p>
          <p><b>Income Wallet:</b> $${u.income}</p>
          <p><b>Total Income:</b> $${u.totalIncome}</p>
          <p><b>Withdrawn:</b> $${u.withdraw}</p>
          <button class="btn" onclick="requestDeposit()">Deposit</button>
          <button class="btn" onclick="requestWithdraw()" ${u.income < 1 ? 'disabled' : ''}>Withdraw</button>
          <button class="btn" onclick="viewHistory()">History</button>
        </div>
      `;
    }

    function requestDeposit() {
      const amount = prompt("Enter deposit amount (50â€“500 USDT)");
      const amt = parseFloat(amount);
      if (amt < 50 || amt > 500) return alert("Amount should be between 50 and 500");

      const ref = db.ref('users/' + currentUser.id);
      ref.once('value', snap => {
        const user = snap.val();
        const hist = user.history || [];
        hist.push({ amount: amt, date: new Date().toLocaleDateString() });
        ref.update({
          deposit: user.deposit + amt,
          history: hist
        });
        if (user.ref) {
          db.ref('users/' + user.ref).once('value', refSnap => {
            if (refSnap.exists()) {
              const refUser = refSnap.val();
              const refIncome = amt * 0.05;
              const updatedIncome = (refUser.income || 0) + refIncome;
              const updatedTotal = (refUser.totalIncome || 0) + refIncome;
              const finalIncome = Math.min(updatedTotal, refUser.deposit * 2);
              db.ref('users/' + user.ref).update({
                income: finalIncome,
                totalIncome: finalIncome
              });
            }
          });
        }
        alert("Deposit request noted.");
        location.reload();
      });
    }

    function requestWithdraw() {
      const amount = prompt("Enter withdrawal amount");
      const amt = parseFloat(amount);
      if (amt > currentUser.income || amt < 1) return alert("Invalid amount");

      const ref = db.ref('users/' + currentUser.id);
      ref.once('value', snap => {
        const user = snap.val();
        const withdrawHist = user.withdrawHistory || [];
        withdrawHist.push({ amount: amt, date: new Date().toLocaleDateString() });

        let newIncome = user.income - amt;
        let newWithdraw = user.withdraw + amt;
        let status = user.totalIncome >= user.deposit * 2 ? "Closed" : "Active";

        ref.update({
          income: newIncome,
          withdraw: newWithdraw,
          status: status,
          withdrawHistory: withdrawHist
        });
        alert("Withdrawal request submitted.");
        location.reload();
      });
    }

    function viewHistory() {
      const u = currentUser;
      const deposits = u.history.map(h => `<li>${h.date}: $${h.amount}</li>`).join('');
      const withdraws = u.withdrawHistory.map(h => `<li>${h.date}: $${h.amount}</li>`).join('');
      appDiv.innerHTML = `
        <div class="card">
          <h2>History</h2>
          <b>Deposits:</b><ul>${deposits}</ul>
          <b>Withdrawals:</b><ul>${withdraws}</ul>
          <button class="btn" onclick="renderUser()">Back</button>
        </div>
      `;
    }

    function renderAdmin() {
      db.ref('users').once('value', snap => {
        const users = snap.val();
        let html = '<div class="card admin"><h2>Admin Panel</h2>';
        for (const id in users) {
          const u = users[id];
          html += `
            <div class="card">
              <b>${u.name}</b> (${id})<br/>
              Deposit: $${u.deposit}<br/>
              Income: $${u.income}<br/>
              Wallet: ${u.wallet}<br/>
              Total Income: $${u.totalIncome}<br/>
              Status: ${u.status}<br/>
            </div>
          `;
        }
        html += `<button class="btn" onclick="renderLogin()">Logout</button></div>`;
        appDiv.innerHTML = html;
      });
    }

    renderLogin();
  </script>
</body>
</html>
