<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üöÄ Ashirwad Mart - Grow Up Together</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <style>
    /* Base styles with improvements for readability and spacing */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #121212;
      color: #e0e0e0;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    h2, h3, h4, h5 {
      color: #00ffe1;
      text-align: center;
      margin: 15px 0 10px;
      font-weight: 600;
    }
    .box {
      background: #1e1e1e;
      padding: 30px 35px;
      margin: 20px 0;
      border-radius: 12px;
      box-shadow: 0 0 22px #00ffe170;
      width: 100%;
      max-width: 650px;
      box-sizing: border-box;
    }
    input, button, select, textarea {
      padding: 14px 16px;
      margin: 12px 0 24px 0;
      width: 100%;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      background: #2a2a2a;
      color: #fff;
      box-sizing: border-box;
      transition: background-color 0.25s ease, box-shadow 0.25s ease;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      background-color: #393939;
      box-shadow: 0 0 8px #00ffe1cc;
    }
    button {
      background: #00ffe1;
      color: #000;
      font-weight: 700;
      cursor: pointer;
      border: none;
      transition: background 0.3s ease;
      user-select: none;
      box-shadow: 0 3px 8px #00ffe1bb;
    }
    button:hover, button:focus {
      background: #00c7aa;
      outline: none;
      box-shadow: 0 5px 15px #00c7aacc;
    }
    a {
      color: #00ffe1;
      text-decoration: underline;
      cursor: pointer;
      user-select: none;
    }
    a:hover {
      color: #00c7aa;
    }
    .hidden {
      display: none !important;
    }
    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0 10px 0;
    }
    th, td {
      padding: 14px;
      text-align: center;
      border-bottom: 1px solid #333;
      font-size: 14px;
    }
    th {
      background-color: #222;
      color: #00ffe1;
      font-weight: 700;
    }
    td {
      background-color: #1c1c1c;
      word-break: break-word;
    }
    /* Admin Panel Section */
    .admin-section {
      background: #2b1b1b;
      border: 2px solid #ff5555;
      max-width: 980px;
    }
    .admin-section h3 {
      margin-top: 0;
    }
    /* Buttons in table */
    .btn-table {
      padding: 7px 12px;
      margin: 0 5px;
      font-size: 14px;
      border-radius: 6px;
      font-weight: 600;
      user-select: none;
    }
    .btn-accept {
      background-color: #28a745;
      color: #fff;
      border: none;
    }
    .btn-reject {
      background-color: #dc3545;
      color: #fff;
      border: none;
    }
    .btn-close {
      background-color: #6c757d;
      color: #fff;
      border: none;
    }
    .btn-edit {
      background-color: #007bff;
      color: #fff;
      border: none;
    }
    .btn-delete {
      background-color: #e55753;
      color: #fff;
      border: none;
    }
    .btn-small {
      padding: 6px 10px;
      font-size: 13px;
    }
    /* User Dashboard */
    #userDashboard {
      max-width: 650px;
      text-align: left;
    }
    #userDashboard p, #userDashboard code {
      margin: 7px 0;
      font-size: 16px;
    }
    #profitChartContainer {
      margin-top: 25px;
      background: #272727;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 16px #00ffe1bb;
    }
    #profitChart {
      width: 100% !important;
      max-height: 260px;
    }
    code {
      display: inline-block;
      background-color: #333;
      padding: 6px 10px;
      border-radius: 6px;
      font-family: monospace;
      user-select: all;
    }
    hr {
      border: none;
      border-top: 1px solid #262626;
      margin: 30px 0;
    }
    /* Modal for editing */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal-content {
      background: #1e1e1e;
      border-radius: 12px;
      padding: 30px 35px;
      width: 100%;
      max-width: 480px;
      box-shadow: 0 0 24px #00ffe1bb;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-header h4 {
      margin: 0;
      color: #00ffe1;
    }
    .modal-close {
      font-size: 24px;
      font-weight: 700;
      cursor: pointer;
      color: #ff5555;
      user-select: none;
    }
    /* Responsive */
    @media (max-width: 640px) {
      .box, .admin-section {
        max-width: 100%;
        padding: 20px 25px;
      }
      table, th, td {
        font-size: 13px;
      }
      button, input, select, textarea {
        font-size: 15px;
      }
    }
    /* Loading spinner */
    .loading-spinner {
      border: 4px solid #2a2a2a;
      border-top: 4px solid #00ffe1;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h2>üöÄ Ashirwad Mart - Grow Up Together</h2>

  <div id="loginBox" class="box" aria-label="Login Form">
    <h3>üîê Login</h3>
    <input type="text" id="loginId" placeholder="Enter ID" autocomplete="username" aria-required="true" aria-label="User ID" />
    <input type="password" id="loginPass" placeholder="Password" autocomplete="current-password" aria-required="true" aria-label="Password" />
    <button id="btnLogin" onclick="login()">Login</button>
    <p>Don't have ID? <a onclick="showRegister()" tabindex="0">Register here</a></p>
    <div id="loginLoading" class="loading-spinner hidden" aria-hidden="true"></div>
  </div>

  <div id="registerBox" class="box hidden" aria-label="Registration Form">
    <p><a onclick="showForgot()" tabindex="0">Forgot Password?</a></p>
    <h3>üìù New Registration</h3>
    <input type="text" id="regName" placeholder="Full Name" autocomplete="name" aria-required="true" aria-label="Full Name" />
    <input type="tel" id="regMobile" placeholder="Mobile Number" autocomplete="tel" aria-required="true" aria-label="Mobile Number" />
    <input type="text" id="regWallet" placeholder="BEP20 USDT Wallet Address" aria-required="true" aria-label="Wallet Address" />
    <input type="password" id="regPassword" placeholder="Set Password" autocomplete="new-password" aria-required="true" aria-label="Password" />
    <input type="text" id="regRef" placeholder="Referral ID (optional)" aria-label="Referral ID" />
    <button id="btnRegister" onclick="register()">Register Now</button>
    <div id="registerLoading" class="loading-spinner hidden" aria-hidden="true"></div>
  </div>

  <div id="forgotBox" class="box hidden" aria-label="Forgot Password Form">
    <h3>üîë Reset Password via OTP</h3>
    <input type="tel" id="otpMobile" placeholder="Enter Registered Mobile Number" autocomplete="tel" aria-required="true" aria-label="Registered Mobile Number" />
    <div id="recaptcha-container"></div>
    <button id="btnSendOTP" onclick="sendOTP()">Send OTP</button>
    <input type="text" id="otpCode" placeholder="Enter OTP" autocomplete="one-time-code" aria-required="true" aria-label="OTP Code" />
    <input type="password" id="otpNewPass" placeholder="New Password" autocomplete="new-password" aria-required="true" aria-label="New Password" />
    <button id="btnVerifyOTP" onclick="verifyOTP()">Verify & Change Password</button>
    <p><a onclick="backToLogin()" tabindex="0">üîô Back to Login</a></p>
    <div id="otpLoading" class="loading-spinner hidden" aria-hidden="true"></div>
  </div>

  <div id="userDashboard" class="box hidden" aria-label="User Dashboard">
    <h3>üëã Hello, <span id="userName" aria-live="polite"></span></h3>
    <p>üíº Wallet: <span id="userWallet"></span></p>
    <p>üí∞ Deposit: <b><span id="userDeposit">0</span> USDT</b></p>
    <p><small><em>Deposit Time: <span id="userDepositTime">N/A</span></em></small></p>
    <p>üìà Income: <b><span id="userIncome">0</span> USDT</b></p>
    <p>üè¶ Withdrawal Wallet: <b><span id="userWithdrawWallet"></span></b></p>
    <p>üéØ Income Target (2x): <b><span id="userTarget">0</span> USDT</b></p>
    <p>üìâ Remaining Target: <b><span id="userRemaining">0</span> USDT</b></p>
    <p>üîí Status: <span id="userStatus">Pending</span></p>
    <p>üí≥ Wallet Balance: <b><span id="walletBalance">0</span> USDT</b></p>

    <hr />
    <h4>üì• Deposit Funds</h4>
    <p>Send 100‚Äì1000 USDT to:</p>
    <code>0x49F7A836A32C1aCF04d4d20Fa87A14C7a19aB74B</code>
    <input type="number" id="depAmount" placeholder="Enter amount (100-1000)" min="100" max="1000" aria-label="Deposit Amount" />
    <button id="btnSubmitDeposit" onclick="submitDeposit()">Submit Deposit</button>

    <hr />
    <h4>üí∏ Request Withdrawal</h4>
    <input type="number" id="withAmt" placeholder="Min 5 USDT" min="5" aria-label="Withdrawal Amount" />
    <button id="btnRequestWithdraw" onclick="requestWithdraw()">Request Withdrawal</button>

    <hr />
    <h4>üîë Change Password</h4>
    <input type="password" id="changePassCurrent" placeholder="Current Password" aria-label="Current Password" />
    <input type="password" id="changePassNew" placeholder="New Password" aria-label="New Password" />
    <button id="btnChangePass" onclick="changePasswordNormal()">Change Password</button>

    <hr/>
    <h4>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Referral Team</h4>
    <button id="btnViewTeam" onclick="viewTeam()">View Your Team</button>
    <div id="teamBox" aria-live="polite"></div>

    <hr />
    <h4>üìú History</h4>
    <button id="btnViewHistory" onclick="viewHistory()">View History</button>
    <div id="historyBox" aria-live="polite"></div>

    <div id="profitChartContainer" class="hidden">
      <h4>üìä Profit Graph (Deposit vs Income)</h4>
      <canvas id="profitChart"></canvas>
    </div>

    <button id="btnLogout" onclick="logout()">üö™ Logout</button>
  </div>

  <div id="adminPanel" class="box admin-section hidden" aria-label="Admin Dashboard">
    <h3>üõ†Ô∏è Admin Dashboard</h3>

    <div style="margin-bottom:15px; font-size: 16px; color: #00ffe1;">
      <b>Total Deposit Balance:</b> <span id="totalDepositBalance">0</span> USDT &nbsp;&nbsp;&nbsp;
      <b>Total Wallet Balance:</b> <span id="totalWalletBalance">0</span> USDT
    </div>

    <div id="adminUsersContainer" aria-live="polite"></div>

    <h4>‚ûï Add Weekly Income</h4>
    <input type="text" id="incomeUserId" placeholder="User ID" aria-label="User ID" />
    <input type="number" id="incomeAmt" placeholder="Amount" aria-label="Amount" />
    <button id="btnAddIncome" onclick="addWeeklyIncome()">Add Income</button>

    <button id="btnAdminLogout" onclick="logout()">üö™ Logout</button>
  </div>

  <!-- Modal for Editing User -->
  <div id="editUserModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="editUserTitle" tabindex="-1">
    <div class="modal-content">
      <div class="modal-header">
        <h4 id="editUserTitle">Edit User</h4>
        <button class="modal-close" onclick="closeEditModal()" aria-label="Close">&times;</button>
      </div>
      <input type="text" id="editUserId" placeholder="User ID" disabled aria-label="User ID" />
      <input type="text" id="editName" placeholder="Full Name" aria-label="Full Name" />
      <input type="tel" id="editMobile" placeholder="Mobile Number" aria-label="Mobile Number" />
      <input type="text" id="editWallet" placeholder="BEP20 USDT Wallet Address" aria-label="Wallet Address" />
      <input type="password" id="editPassword" placeholder="Password (leave blank to keep unchanged)" aria-label="Password" />
      <input type="text" id="editRef" placeholder="Referral ID" aria-label="Referral ID" />
      <select id="editStatus" aria-label="Status">
        <option value="Pending">Pending</option>
        <option value="Active">Active</option>
        <option value="Rejected">Rejected</option>
        <option value="Closed">Closed</option>
      </select>
      <input type="number" id="editDeposit" placeholder="Deposit" min="0" step="any" aria-label="Deposit" />
      <input type="number" id="editIncome" placeholder="Income" min="0" step="any" aria-label="Income" />
      <input type="number" id="editWalletBalance" placeholder="Wallet Balance" min="0" step="any" aria-label="Wallet Balance" />
      <input type="datetime-local" id="editDepositTime" placeholder="Deposit Time" aria-label="Deposit Time" />
      <button id="btnSaveUserChanges" onclick="saveUserChanges()">Save Changes</button>
    </div>
  </div>

  <script>
    // Firebase config & initialize
    const firebaseConfig = {
      apiKey: "AIzaSyCBXuE2NHuZkKeQY7JjYM5vpbF1-K9AcS8",
      authDomain: "ashirwadmart-6d657.firebaseapp.com",
      databaseURL: "https://ashirwadmart-6d657-default-rtdb.firebaseio.com",
      projectId: "ashirwadmart-6d657",
      storageBucket: "ashirwadmart-6d657.appspot.com",
      messagingSenderId: "1013585797321",
      appId: "1:1013585797321:web:8a5c5fdb50c6aa7e7e57aa"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentId = "";
    let profitChartInstance = null;

    // Helper: Show and hide elements
    function show(ele) { ele.classList.remove('hidden'); }
    function hide(ele) { ele.classList.add('hidden'); }

    function setLoading(buttonId, isLoading) {
      const button = document.getElementById(buttonId);
      const spinnerId = buttonId.replace('btn', '').toLowerCase() + "Loading";
      const spinner = document.getElementById(spinnerId);
      if (spinner) {
        spinner.style.display = isLoading ? "block" : "none";
        button.disabled = isLoading;
      }
    }

    // Show/hide form sections
    function showRegister() {
      hide(document.getElementById('loginBox'));
      show(document.getElementById('registerBox'));
      hide(document.getElementById('forgotBox'));
      hide(document.getElementById('userDashboard'));
      hide(document.getElementById('adminPanel'));
    }
    function showForgot() {
      hide(document.getElementById('loginBox'));
      hide(document.getElementById('registerBox'));
      show(document.getElementById('forgotBox'));
      hide(document.getElementById('userDashboard'));
      hide(document.getElementById('adminPanel'));
    }
    function backToLogin() {
      show(document.getElementById('loginBox'));
      hide(document.getElementById('registerBox'));
      hide(document.getElementById('forgotBox'));
      hide(document.getElementById('userDashboard'));
      hide(document.getElementById('adminPanel'));
    }

    // Logout session clear
    function logout() {
      currentId = "";
      backToLogin();
      clearUserData();
    }
    function clearUserData() {
      document.getElementById("userName").innerText = "";
      document.getElementById("userWallet").innerText = "";
      document.getElementById("userDeposit").innerText = "0";
      document.getElementById("userDepositTime").innerText = "N/A";
      document.getElementById("userIncome").innerText = "0";
      document.getElementById("userStatus").innerText = "Pending";
      document.getElementById("userWithdrawWallet").innerText = "";
      document.getElementById("userTarget").innerText = "0";
      document.getElementById("userRemaining").innerText = "0";
      document.getElementById("walletBalance").innerText = "0";
      hide(document.getElementById("profitChartContainer"));
      if(profitChartInstance) {
        profitChartInstance.destroy();
        profitChartInstance = null;
      }
      document.getElementById("teamBox").innerHTML = "";
      document.getElementById("historyBox").innerHTML = "";
    }

    // Login function with error handling & loading
    async function login() {
      setLoading('btnLogin', true);
      try {
        const id = document.getElementById('loginId').value.trim();
        const pass = document.getElementById('loginPass').value;

        if (!id) throw new Error("Please enter your ID");
        if (!pass) throw new Error("Please enter your password");

        if (id === "Admin" && pass === "Jaihanuman@7") {
          currentId = "Admin";
          hide(document.getElementById("loginBox"));
          hide(document.getElementById("registerBox"));
          hide(document.getElementById("forgotBox"));
          show(document.getElementById("adminPanel"));
          await loadAdmin();
          return;
        }

        const snap = await db.ref("users/" + id).get();
        if (!snap.exists()) throw new Error("User ID not found.");
        const data = snap.val();
        if (data.password !== pass) throw new Error("Incorrect password");

        currentId = id;
        await loadUser(id);
        hide(document.getElementById("loginBox"));
        hide(document.getElementById("registerBox"));
        hide(document.getElementById("forgotBox"));
        show(document.getElementById("userDashboard"));
      } catch (err) {
        alert(err.message);
      } finally {
        setLoading('btnLogin', false);
      }
    }

    // Register with validation, random ID, loading
    async function register() {
      setLoading('btnRegister', true);
      try {
        const name = document.getElementById("regName").value.trim();
        const mobile = document.getElementById("regMobile").value.trim();
        const wallet = document.getElementById("regWallet").value.trim();
        const ref = document.getElementById("regRef").value.trim();
        const password = document.getElementById("regPassword").value.trim();

        if (!name || !mobile || !wallet || !password) {
          throw new Error("Please fill all required fields");
        }
        // Simple wallet address basic pattern check (BEP20 address)
        const walletPattern = /^0x[a-fA-F0-9]{40}$/;
        if (!walletPattern.test(wallet)) {
          throw new Error("Invalid BEP20 USDT Wallet Address");
        }

        // Mobile number basic check (10 digits minimum)
        const mobilePattern = /^[0-9]{10,15}$/;
        if (!mobilePattern.test(mobile)) {
          throw new Error("Invalid Mobile Number");
        }

        // Generate unique ID - ensure uniqueness in demo by check, else regenerate
        let id = "";
        let unique = false;
        while (!unique) {
          id = "U" + Math.floor(Math.random() * 1000000);
          const exists = await db.ref("users/" + id).get();
          if (!exists.exists()) unique = true;
        }

        const userData = {
          name, mobile, wallet, deposit: 0, income: 0, status: "Pending",
          referredBy: ref || "", password,
          walletBalance: 0, depositTime: null
        };

        await db.ref("users/" + id).set(userData);
        alert(`Registered! Your ID: ${id}. Remember this for login.`);
        location.reload();
      } catch (err) {
        alert(err.message);
      } finally {
        setLoading('btnRegister', false);
      }
    }

    // Load user details and update UI
    function loadUser(id) {
      db.ref("users/" + id).on("value", snap => {
        if (!snap.exists()) {
          alert("User data not found");
          logout();
          return;
        }
        const data = snap.val();

        const deposit = parseFloat(data.deposit || 0);
        const income = parseFloat(data.income || 0);
        const cap = deposit * 2;
        const remaining = Math.max(0, cap - income);
        const balance = parseFloat(data.walletBalance || 0);

        const depositTimeStr = data.depositTime ? new Date(data.depositTime).toLocaleString() : "N/A";

        document.getElementById("userName").innerText = data.name;
        document.getElementById("userWallet").innerText = data.wallet;
        document.getElementById("userDeposit").innerText = deposit.toFixed(2);
        document.getElementById("userDepositTime").innerText = depositTimeStr;
        document.getElementById("userIncome").innerText = income.toFixed(2);
        document.getElementById("userStatus").innerText = data.status;
        document.getElementById("userWithdrawWallet").innerText = data.wallet;
        document.getElementById("userTarget").innerText = cap.toFixed(2);
        document.getElementById("userRemaining").innerText = remaining.toFixed(2);
        document.getElementById("walletBalance").innerText = balance.toFixed(2);

        if (deposit > 0 && income >= cap && data.status !== "Closed") {
          db.ref("users/" + id).update({
            income: 0,
            deposit: 0,
            status: "Closed",
            depositTime: null
          });
          alert("üéâ Congratulations! Your agreement has completed 2x and is now closed.");
        }
        loadProfitChart(deposit, income);
      });
    }

    // Profit Chart Load
    function loadProfitChart(deposit, income) {
      const container = document.getElementById("profitChartContainer");
      if (deposit <= 0) {
        container.classList.add("hidden");
        if(profitChartInstance) {
          profitChartInstance.destroy();
          profitChartInstance = null;
        }
        return;
      }
      container.classList.remove("hidden");

      const ctx = document.getElementById("profitChart").getContext('2d');

      if (profitChartInstance) {
        profitChartInstance.destroy();
      }

      profitChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Start', 'Now'],
          datasets: [
            {
              label: 'Deposit',
              data: [deposit, deposit],
              borderColor: '#00ffe1',
              backgroundColor: 'rgba(0, 255, 225, 0.3)',
              fill: true,
              tension: 0.3,
              pointRadius: 5
            },
            {
              label: 'Income',
              data: [0, income],
              borderColor: '#ffed00',
              backgroundColor: 'rgba(255, 237, 0, 0.3)',
              fill: true,
              tension: 0.3,
              pointRadius: 5
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: { color: '#00ffe1' }
            }
          },
          scales: {
            x: {
              ticks: { color: '#00ffe1' }
            },
            y: {
              beginAtZero: true,
              ticks: { color: '#00ffe1' }
            }
          }
        }
      });
    }

    // Submit deposit with validations
    async function submitDeposit() {
      try {
        const amt = parseFloat(document.getElementById("depAmount").value);
        if (isNaN(amt) || amt < 100 || amt > 1000) {
          alert("Deposit amount must be between 100 and 1000 USDT");
          return;
        }

        const snap = await db.ref("users/" + currentId).get();
        if (!snap.exists()) {
          alert("User data not found");
          return;
        }
        const data = snap.val();
        if (data.status === "Active") {
          alert("Deposit is locked until agreement is closed.");
          return;
        }

        const nowISOString = new Date().toISOString();

        await db.ref("users/" + currentId).update({
          deposit: amt,
          status: "Pending",
          depositTime: nowISOString
        });
        alert("Deposit submitted! Waiting for admin approval.");
        document.getElementById("depAmount").value = "";
      } catch (err) {
        alert("Error submitting deposit: " + err.message);
      }
    }

    // Request withdrawal
    async function requestWithdraw() {
      try {
        const amt = parseFloat(document.getElementById("withAmt").value);
        if (isNaN(amt) || amt < 5) {
          alert("Minimum withdrawal amount is 5 USDT");
          return;
        }

        const snap = await db.ref("users/" + currentId).get();
        if (!snap.exists()) {
          alert("User data not found");
          return;
        }
        const data = snap.val();
        const walletBalance = parseFloat(data.walletBalance || 0);
        if (amt > walletBalance) {
          alert("Insufficient wallet balance");
          return;
        }

        const newBalance = walletBalance - amt;
        await db.ref("users/" + currentId + "/walletBalance").set(newBalance);
        await db.ref("withdrawals/" + currentId).push({ amount: amt, status: "Pending" });
        alert("Withdrawal requested!");
        document.getElementById("withAmt").value = "";
      } catch (err) {
        alert("Error requesting withdrawal: " + err.message);
      }
    }

    // Change password for logged-in user
    async function changePasswordNormal() {
      try {
        const currentPass = document.getElementById("changePassCurrent").value;
        const newPass = document.getElementById("changePassNew").value;
        if (!currentPass || !newPass) {
          alert("Please fill both current and new password");
          return;
        }
        const snap = await db.ref("users/" + currentId).get();
        if (!snap.exists()) {
          alert("User data not found");
          return;
        }
        const data = snap.val();
        if (data.password !== currentPass) {
          alert("Current password is incorrect");
          return;
        }
        await db.ref("users/" + currentId + "/password").set(newPass);
        alert("Password changed successfully. Please login again.");
        logout();
      } catch (err) {
        alert("Error changing password: " + err.message);
      }
    }

    // View referral team
    async function viewTeam() {
      try {
        const snap = await db.ref("users").get();
        let html = "<ul>";
        snap.forEach(child => {
          const data = child.val();
          if (data.referredBy === currentId) {
            html += `<li><b>${child.key}</b>: ${data.name} - ${parseFloat(data.deposit || 0).toFixed(2)} USDT - ${data.status}</li>`;
          }
        });
        html += "</ul>";
        document.getElementById("teamBox").innerHTML = html;
      } catch (err) {
        alert("Error loading team data: " + err.message);
      }
    }

    // View withdrawal history
    async function viewHistory() {
      try {
        const snap = await db.ref("withdrawals/" + currentId).get();
        let html = "<h5>Withdrawals:</h5><ul>";
        if (snap.exists()) {
          snap.forEach(child => {
            const d = child.val();
            html += `<li>${parseFloat(d.amount).toFixed(2)} USDT - ${d.status}</li>`;
          });
        } else {
          html += "<li>No withdrawal history found.</li>";
        }
        html += "</ul>";
        document.getElementById("historyBox").innerHTML = html;
      } catch (err) {
        alert("Error loading history: " + err.message);
      }
    }

    // Admin panel load users
    async function loadAdmin() {
      try {
        const snap = await db.ref("users").get();
        if (!snap.exists()) {
          document.getElementById("adminUsersContainer").innerHTML = "<p>No users found.</p>";
          return;
        }
        let html = `<table aria-label="Users Table"><thead>
          <tr><th>User ID</th><th>Name</th><th>Deposit</th><th>Income</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
        let totalDeposit = 0;
        let totalWallet = 0;
        snap.forEach(child => {
          const key = child.key;
          const data = child.val();
          totalDeposit += parseFloat(data.deposit || 0);
          totalWallet += parseFloat(data.walletBalance || 0);
          html += `<tr>
            <td>${key}</td>
            <td>${data.name}</td>
            <td>${parseFloat(data.deposit || 0).toFixed(2)}</td>
            <td>${parseFloat(data.income || 0).toFixed(2)}</td>
            <td>${data.status}</td>
            <td>
              <button class="btn-table btn-edit" onclick="editUser('${key}')">Edit</button>
              <button class="btn-table btn-delete" onclick="deleteUser('${key}')">Delete</button>
            </td>
          </tr>`;
        });
        html += "</tbody></table>";
        document.getElementById("adminUsersContainer").innerHTML = html;
        document.getElementById("totalDepositBalance").innerText = totalDeposit.toFixed(2);
        document.getElementById("totalWalletBalance").innerText = totalWallet.toFixed(2);
      } catch (err) {
        alert("Error loading admin data: " + err.message);
      }
    }

    // Edit user modal open with data
    async function editUser(userId) {
      try {
        const snap = await db.ref("users/" + userId).get();
        if (!snap.exists()) {
          alert("User not found");
          return;
        }
        const data = snap.val();
        document.getElementById("editUserId").value = userId;
        document.getElementById("editName").value = data.name || "";
        document.getElementById("editMobile").value = data.mobile || "";
        document.getElementById("editWallet").value = data.wallet || "";
        document.getElementById("editPassword").value = ""; // Leave blank
        document.getElementById("editRef").value = data.referredBy || "";
        document.getElementById("editStatus").value = data.status || "Pending";
        document.getElementById("editDeposit").value = parseFloat(data.deposit || 0);
        document.getElementById("editIncome").value = parseFloat(data.income || 0);
        document.getElementById("editWalletBalance").value = parseFloat(data.walletBalance || 0);
        document.getElementById("editDepositTime").value = data.depositTime ? new Date(data.depositTime).toISOString().slice(0,16) : "";
        show(document.getElementById("editUserModal"));
        document.getElementById("editUserModal").focus();
      } catch (err) {
        alert("Error loading user data: " + err.message);
      }
    }

    // Save user changes from modal
    async function saveUserChanges() {
      try {
        const userId = document.getElementById("editUserId").value;
        const name = document.getElementById("editName").value.trim();
        const mobile = document.getElementById("editMobile").value.trim();
        const wallet = document.getElementById("editWallet").value.trim();
        const password = document.getElementById("editPassword").value;
        const referredBy = document.getElementById("editRef").value.trim();
        const status = document.getElementById("editStatus").value;
        const deposit = parseFloat(document.getElementById("editDeposit").value);
        const income = parseFloat(document.getElementById("editIncome").value);
        const walletBalance = parseFloat(document.getElementById("editWalletBalance").value);
        const depositTimeRaw = document.getElementById("editDepositTime").value;
        const depositTime = depositTimeRaw ? new Date(depositTimeRaw).toISOString() : null;

        if (!name || !mobile || !wallet || isNaN(deposit) || isNaN(income) || isNaN(walletBalance)) {
          alert("Please fill all fields correctly");
          return;
        }

        let updateData = { name, mobile, wallet, referredBy, status, deposit, income, walletBalance, depositTime };
        if (password) {
          updateData.password = password;
        }

        await db.ref("users/" + userId).update(updateData);
        alert("User updated successfully");
        closeEditModal();
        loadAdmin();
      } catch (err) {
        alert("Error saving user: " + err.message);
      }
    }

    function closeEditModal() {
      hide(document.getElementById("editUserModal"));
    }

    // Delete user after confirmation
    async function deleteUser(userId) {
      if (!confirm(`Are you sure to delete user ${userId}? This action cannot be undone.`)) return;
      try {
        await db.ref("users/" + userId).remove();
        alert("User deleted");
        loadAdmin();
      } catch (err) {
        alert("Error deleting user: " + err.message);
      }
    }

    // Add weekly income by admin
    async function addWeeklyIncome() {
      try {
        const userId = document.getElementById("incomeUserId").value.trim();
        const amount = parseFloat(document.getElementById("incomeAmt").value);
        if (!userId) {
          alert("Enter User ID");
          return;
        }
        if (isNaN(amount) || amount <= 0) {
          alert("Enter a valid amount");
          return;
        }

        const userSnap = await db.ref("users/" + userId).get();
        if (!userSnap.exists()) {
          alert("User not found");
          return;
        }
        const userData = userSnap.val();
        const newIncome = (parseFloat(userData.income || 0)) + amount;
        // Prevent income exceeding 2x deposit cap automatically
        const deposit = parseFloat(userData.deposit || 0);
        if (newIncome > deposit * 2) {
          alert("Income exceeds 2x deposit cap");
          return;
        }
        await db.ref("users/" + userId).update({ income: newIncome });

        // Credit wallet balance also
        const newWalletBalance = (parseFloat(userData.walletBalance || 0)) + amount;
        await db.ref("users/" + userId).update({ walletBalance: newWalletBalance });

        alert(`Income of ${amount} USDT added to user ${userId}`);
        document.getElementById("incomeUserId").value = "";
        document.getElementById("incomeAmt").value = "";
      } catch (err) {
        alert("Error adding income: " + err.message);
      }
    }

  </script>
</body>
</html>
